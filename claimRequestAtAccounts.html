<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Requests Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #F8FAFC; /* A very light blue/off-white */
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #FFFFFF;
            border-left: 4px solid #3B82F6; /* A clear, vibrant blue border */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Updated button styles for a more modern look and improved text visibility */
        .btn {
            /* Now using white text color directly */
            @apply flex-1 text-white py-1.5 px-3 rounded-xl font-semibold text-xs transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-dealer {
            background-color: #1D4ED8; /* A darker, solid blue */
            box-shadow: 0 4px 6px -1px rgba(29, 78, 216, 0.5), 0 2px 4px -1px rgba(29, 78, 216, 0.25);
            @apply focus:ring-blue-800;
            color: #FFFFFF;
            font-size: 15px;
            border-radius: 10px;
            padding: 10px;
            margin-right: 5px;
        }
        .btn-supplier {
            background-color: #1E3A8A; /* An even deeper blue */
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.5), 0 2px 4px -1px rgba(30, 58, 138, 0.25);
            @apply focus:ring-blue-900;
            color: #FFFFFF;
            font-size: 15px;
            border-radius: 10px;
            padding: 10px;
            margin-right: 5px;            
        }
        .btn-clear {
            background-color: #374151; /* A darker gray */
            box-shadow: 0 4-6px -1px rgba(55, 65, 81, 0.5), 0 2px 4px -1px rgba(55, 65, 81, 0.25);
            @apply focus:ring-gray-700;
            color: #FFFFFF;
            font-size: 15px;
            border-radius: 10px;
            padding: 10px;
            margin-right: 5px;            
        }
        .btn-dealer:hover {
            background-color: #1e3a8a;
        }
        .btn-supplier:hover {
            background-color: #111827;
        }
        .btn-clear:hover {
            background-color: #1F2937;
        }

        /* --- KEY CHANGES START --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(107, 114, 128, 0.75); /* Equivalent of bg-gray-600 with opacity */
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            position: relative;
            padding: 1.5rem; /* Equivalent of p-6 */
            background-color: #FFFFFF;
            border-radius: 0.5rem; /* Equivalent of rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 91.666667%; /* Equivalent of w-11/12 */
            max-width: 500px;
            max-height: 100vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .ts-dropdown {
            z-index: 9999 !important;
        }
        /* --- KEY CHANGES END --- */
        
        /* Loader Pop-up styles */
        #loader-overlay {
            @apply fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 ease-in-out;
        }

        /* Custom Modal for Email Input */
        #email-modal {
            @apply fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 antialiased">

    <div id="loader-overlay" class="hidden opacity-0">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-blue-200 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-blue-200 font-semibold">Fetching claim requests...</p>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-bold text-gray-900 mb-2"></h3>
            <p id="message-text" class="text-sm text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button id="close-message-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">OK</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-8 text-center">Claim Requests Portal</h1>
        <div id="requests-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
    </div>

    <div id="supplier-modal" class="modal hidden">
        <div class="modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-xl font-bold text-gray-900">Select Supplier</h3>
                <button id="close-supplier-modal-btn" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="supplier-select" class="block text-sm font-medium text-gray-700 mb-2">Search or Add Supplier</label>
                <select id="supplier-select" autocomplete="off" placeholder="Search for a supplier..."></select>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="done-btn" class="btn bg-blue-600 hover:bg-blue-700 w-full md:w-auto px-6 py-2">
                    Done
                </button>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal hidden">
        <div class="modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-xl font-bold text-gray-900">Enter Supplier Email</h3>
                <button id="close-email-modal-btn" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="email-input" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="email-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter supplier's email address" required>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="submit-email-btn" class="btn bg-blue-600 hover:bg-blue-700 w-full md:w-auto px-6 py-2">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const requestsContainer = document.getElementById('requests-container');
  const loaderOverlay = document.getElementById('loader-overlay');

  // ----------------- Loader -----------------
  const showLoader = (msg = 'Loading...') => {
    loaderOverlay.style.display = 'flex';
    loaderOverlay.querySelector('p').textContent = msg;
  };
  const hideLoader = () => {
    loaderOverlay.style.display = 'none';
  };

  // ----------------- Message Box -----------------
  const showMessageBox = (title, message) => {
    const box = document.createElement('div');
    box.className =
      'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
    box.innerHTML = `
      <div class="bg-white p-4 rounded-md shadow-lg max-w-sm w-full">
        <h3 class="text-base font-bold mb-2">${title}</h3>
        <p class="text-sm mb-3">${message}</p>
        <button class="btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs">OK</button>
      </div>`;
    document.body.appendChild(box);
    box.querySelector('button').addEventListener('click', () => box.remove());
  };

  // ----------------- Get Claim Requests -----------------
  const getClaimRequests = async () => {
    showLoader('Fetching claim requests...');
    try {
      const url =
        'https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec?action=getClaimRequests';
      const res = await fetch(url);
      const data = await res.json();
      return data || [];
    } catch (err) {
      console.error('Error fetching claim requests:', err);
      showMessageBox('Error', 'Could not fetch claim requests.');
      return [];
    } finally {
      hideLoader();
    }
  };

  // ----------------- Get Supplier Data -----------------
  const getSupplierData = async (reqId) => {
    showLoader('Fetching supplier data...');
    try {
      const url = `https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec?action=getSupplierData&reqId=${reqId}`;
      const res = await fetch(url);
      const data = await res.json();
      return data || {};
    } catch (err) {
      console.error('Error fetching supplier data:', err);
      showMessageBox('Error', 'Could not fetch supplier data.');
      return {};
    } finally {
      hideLoader();
    }
  };

  // ----------------- Create Claim Card (FIXED remark-box) -----------------
  const createClaimCard = (request) => {
    const card = document.createElement('div');
    card.className = 'card p-4 rounded-lg shadow-md hover:shadow-lg';
    card.dataset.reqId = request['REQ-ID'] || '';

    const pReq = document.createElement('p');
    pReq.className =
      'text-xs font-semibold text-gray-500 mb-1';
    pReq.innerHTML = `Request ID: <span class="font-medium text-blue-600">${
      request['REQ-ID'] || ''
    }</span>`;

    const h2 = document.createElement('h2');
    h2.className = 'text-base font-bold text-blue-900 mt-1';
    h2.textContent = request['Dealer Name'] || '';

    const pProduct = document.createElement('p');
    pProduct.className = 'text-gray-700 text-xs mt-1';
    pProduct.innerHTML = `Product: <span class="font-medium">${
      request['Product'] || ''
    }</span>`;

    const pQty = document.createElement('p');
    pQty.className = 'text-gray-700 text-xs';
    pQty.innerHTML = `Quantity: <span class="font-medium">${
      request['Qty'] || ''
    }</span>`;

    const pCrm = document.createElement('p');
    pCrm.className = 'text-gray-700 text-xs';
    pCrm.innerHTML = `CRM: <span class="font-medium">${
      request['CRM Name'] || ''
    }</span>`;

    const pIssue = document.createElement('p');
    pIssue.className = 'text-gray-700 text-xs';
    pIssue.innerHTML = `Issue: <span class="font-medium">${
      request['Issue'] || ''
    }</span>`;

    // FIX: added remark-box class
    const remarkBox = document.createElement('div');
    remarkBox.className =
      'remark-box mt-3 p-2 bg-blue-50 border border-blue-200 rounded-md';
    remarkBox.innerHTML = `<p class="text-xs font-semibold text-blue-800">Remark:</p>
                           <p class="text-xs text-blue-700 italic">${
                             request['Owner Remark'] || ''
                           }</p>`;

    const btnRow = document.createElement('div');
    btnRow.className = 'flex mt-4 space-x-1';

    const btnDealer = document.createElement('button');
    btnDealer.className = 'btn btn-dealer';
    btnDealer.dataset.id = request['REQ-ID'] || '';
    btnDealer.textContent = 'Dealer Claim';

    const btnSupplier = document.createElement('button');
    btnSupplier.className =
      'btn btn-supplier supplier-claim-btn';
    btnSupplier.dataset.id = request['REQ-ID'] || '';
    btnSupplier.textContent = 'Supplier Claim';

    const btnClear = document.createElement('button');
    btnClear.className = 'btn btn-clear';
    btnClear.dataset.id = request['REQ-ID'] || '';
    btnClear.textContent = 'Clear';

    btnRow.append(btnDealer, btnSupplier, btnClear);

    card.append(
      pReq,
      h2,
      pProduct,
      pQty,
      pCrm,
      pIssue,
      remarkBox,
      btnRow
    );
    requestsContainer.appendChild(card);
  };

  // ----------------- Load Requests -----------------
  const loadRequests = async () => {
    requestsContainer.innerHTML = '';
    const data = await getClaimRequests();
    data.forEach((req) => createClaimCard(req));
  };

  // ----------------- Dealer Claim: Show CN No. -----------------
  requestsContainer.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-dealer');
    if (!btn) return;
    const reqId = btn.dataset.id;
    const card = btn.closest('.card');

    if (card.querySelector('.cn-input-form')) return;

    const btnRow = card.querySelector('.flex.mt-4');
    if (btnRow) btnRow.style.display = 'none';

    const inputId = `cn-input-${reqId}`;
    const formHtml = `
      <div class="cn-input-form mt-4">
        <label for="${inputId}" class="block text-xs font-semibold text-gray-700 mb-1">Enter CN No.:</label>
        <div class="flex items-center space-x-2">
          <input type="text" id="${inputId}" class="flex-grow px-2 py-1 border border-gray-300 rounded-md text-xs focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="e.g., CN12345" required>
          <button class="btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md" 
                  data-req-id="${reqId}" data-submit-cn-btn="true">
            <i class="fas fa-paper-plane mr-1"></i> Submit
          </button>
        </div>
      </div>
    `;

    const remarkBox = card.querySelector('.remark-box');
    remarkBox.insertAdjacentHTML('afterend', formHtml);
  });

  // ----------------- Dealer Claim Submit -----------------
  requestsContainer.addEventListener('click', async (e) => {
    const submitBtn = e.target.closest('[data-submit-cn-btn="true"]');
    if (!submitBtn) return;
    e.preventDefault();

    const reqId = submitBtn.dataset.reqId;
    const cnInput = document.getElementById(`cn-input-${reqId}`);
    const cnNo = cnInput.value.trim();
    if (!cnNo) {
      showMessageBox('Validation Error', 'Please enter a Credit Note number.');
      return;
    }

    await sendDealerClaimRequest(reqId, cnNo);

    const card = submitBtn.closest('.card');
    card.querySelector('.cn-input-form').remove();
    const btnRow = card.querySelector('.flex.mt-4');
    if (btnRow) btnRow.style.display = 'flex';
  });

  // ----------------- Send Dealer Claim -----------------
  const sendDealerClaimRequest = async (reqId, cnNo) => {
    showLoader('Submitting CN No. for dealer claim...');
    const postUrl =
      'https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec';
    const payload = { reqId, cnNo, action: 'dealerClaim' };

    try {
      await fetch(postUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      showMessageBox(
        'Success!',
        `CN No. ${cnNo} submitted for REQ-ID ${reqId}.`
      );
      await loadRequests();
    } catch (err) {
      console.error('Error submitting dealer claim:', err);
      showMessageBox('Error', 'Could not submit dealer claim.');
    } finally {
      hideLoader();
    }
  };

  // ----------------- Supplier Claim -----------------
  requestsContainer.addEventListener('click', async (e) => {
    const btn = e.target.closest('.supplier-claim-btn');
    if (!btn) return;
    const reqId = btn.dataset.id;
    const supplierData = await getSupplierData(reqId);
    showMessageBox(
      'Supplier Data',
      `Supplier for REQ-ID ${reqId}: ${
        supplierData['Supplier Name'] || 'N/A'
      }`
    );
  });

  // ----------------- Clear Button -----------------
  requestsContainer.addEventListener('click', (e) => {
    if (e.target.closest('.btn-clear')) {
      e.target.closest('.card').remove();
    }
  });

  // ----------------- Init -----------------
  loadRequests();
});
</script>

</body>
</html>
