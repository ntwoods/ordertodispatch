<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Requests Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #F8FAFC; /* A very light blue/off-white */
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #FFFFFF;
            border-left: 4px solid #3B82F6; /* A clear, vibrant blue border */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Updated button styles for a more modern look and improved text visibility */
        .btn {
            /* Now using white text color directly */
            @apply flex-1 text-white py-1.5 px-3 rounded-xl font-semibold text-xs transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-dealer {
            background-color: #1D4ED8; /* A darker, solid blue */
            box-shadow: 0 4px 6px -1px rgba(29, 78, 216, 0.5), 0 2px 4px -1px rgba(29, 78, 216, 0.25);
            @apply focus:ring-blue-800;
            color: #FFFFFF;
            font-size: 15px;
            border-radius: 10px;
            padding: 10px;
            margin-right: 5px;
        }
        .btn-supplier {
            background-color: #1E3A8A; /* An even deeper blue */
            box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.5), 0 2px 4px -1px rgba(30, 58, 138, 0.25);
            @apply focus:ring-blue-900;
            color: #FFFFFF;
            font-size: 15px;
            border-radius: 10px;
            padding: 10px;
            margin-right: 5px;            
        }
        .btn-clear {
            background-color: #374151; /* A darker gray */
            box-shadow: 0 4-6px -1px rgba(55, 65, 81, 0.5), 0 2px 4px -1px rgba(55, 65, 81, 0.25);
            @apply focus:ring-gray-700;
            color: #FFFFFF;
            font-size: 15px;
            border-radius: 10px;
            padding: 10px;
            margin-right: 5px;            
        }
        .btn-dealer:hover {
            background-color: #1e3a8a;
        }
        .btn-supplier:hover {
            background-color: #111827;
        }
        .btn-clear:hover {
            background-color: #1F2937;
        }

        /* --- KEY CHANGES START --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(107, 114, 128, 0.75); /* Equivalent of bg-gray-600 with opacity */
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            position: relative;
            padding: 1.5rem; /* Equivalent of p-6 */
            background-color: #FFFFFF;
            border-radius: 0.5rem; /* Equivalent of rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 91.666667%; /* Equivalent of w-11/12 */
            max-width: 500px;
            max-height: 100vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .ts-dropdown {
            z-index: 9999 !important;
        }
        /* --- KEY CHANGES END --- */
        
        /* Loader Pop-up styles */
        #loader-overlay {
            @apply fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 ease-in-out;
        }

        /* Custom Modal for Email Input */
        #email-modal {
            @apply fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 antialiased">

    <div id="loader-overlay" class="hidden opacity-0">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-blue-200 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-blue-200 font-semibold">Fetching claim requests...</p>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-bold text-gray-900 mb-2"></h3>
            <p id="message-text" class="text-sm text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button id="close-message-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">OK</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-8 text-center">Claim Requests Portal</h1>
        <div id="requests-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
    </div>

    <div id="supplier-modal" class="modal hidden">
        <div class="modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-xl font-bold text-gray-900">Select Supplier</h3>
                <button id="close-supplier-modal-btn" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="supplier-select" class="block text-sm font-medium text-gray-700 mb-2">Search or Add Supplier</label>
                <select id="supplier-select" autocomplete="off" placeholder="Search for a supplier..."></select>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="done-btn" class="btn bg-blue-600 hover:bg-blue-700 w-full md:w-auto px-6 py-2">
                    Done
                </button>
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal hidden">
        <div class="modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3">
                <h3 class="text-xl font-bold text-gray-900">Enter Supplier Email</h3>
                <button id="close-email-modal-btn" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="email-input" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="email-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter supplier's email address" required>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="submit-email-btn" class="btn bg-blue-600 hover:bg-blue-700 w-full md:w-auto px-6 py-2">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const requestsContainer = document.getElementById('requests-container');
            const loaderOverlay = document.getElementById('loader-overlay');

            const supplierModal = document.getElementById('supplier-modal');
            const closeModalBtn = document.getElementById('close-supplier-modal-btn');
            const modalContent = supplierModal.querySelector('.modal-content');
            
            const emailModal = document.getElementById('email-modal');
            const closeEmailModalBtn = document.getElementById('close-email-modal-btn');
            const emailInput = document.getElementById('email-input');
            const submitEmailBtn = document.getElementById('submit-email-btn');
            const emailModalContent = emailModal.querySelector('.modal-content');

            const messageModal = document.getElementById('message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageText = document.getElementById('message-text');
            const closeMessageModalBtn = document.getElementById('close-message-modal');

            let tomSelectInstance;
            let currentReqId = null;
            let currentSupplierName = null;

            // Function to show a custom message box
            const showMessageBox = (title, message) => {
                messageTitle.textContent = title;
                messageText.textContent = message;
                messageModal.classList.remove('hidden');
            };

            // Function to close the custom message box
            closeMessageModalBtn.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            // Function to show the loader
            const showLoader = (text = 'Fetching claim requests...') => {
                const loaderText = loaderOverlay.querySelector('p');
                loaderText.textContent = text;
                loaderOverlay.classList.remove('hidden');
                setTimeout(() => {
                    loaderOverlay.classList.remove('opacity-0');
                    loaderOverlay.classList.add('opacity-100');
                }, 10);
            };

            // Function to hide the loader
            const hideLoader = () => {
                loaderOverlay.classList.remove('opacity-100');
                loaderOverlay.classList.add('opacity-0');
                setTimeout(() => {
                    loaderOverlay.classList.add('hidden');
                }, 300);
            };

            // Function to fetch actual claim requests from the Apps Script API
            const getClaimRequests = async () => {
                const apiUrl = 'https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec';
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    return data.data || [];
                } catch (error) {
                    console.error('Error fetching claim requests:', error);
                    // Return an empty array or a fallback message if the API call fails
                    const errorCard = `<div class="col-span-full text-center text-red-500 mt-10">
                        <p>Failed to load claim requests. Please check the API URL or your internet connection.</p>
                    </div>`;
                    requestsContainer.innerHTML = errorCard;
                    return [];
                }
            };

            // Function to fetch data from the Google Sheet (D and E columns)
            const getSupplierData = async () => {
                const sheetId = '1UeohB4IPgEzGwybOJaIKpCIa38A4UvBstM8waqYv9V0';
                const sheetName = 'Paste Here';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
                
                try {
                    const response = await fetch(url);
                    const csvText = await response.text();
                    
                    const rows = csvText.split('\n').slice(1); // Remove header row
                    const suppliers = rows.map(row => {
                        const columns = row.split(',').map(col => col.trim().replace(/^"|"$/g, ''));
                        // Return an object with both name and email.
                        // We are strictly using column D for name (columns[3]) and E for email (columns[4])
                        return { name: columns[8], email: columns[9] }; 
                    }).filter(s => s.name); // Filter out any empty names
                    
                    // Use a Set to store unique names to handle duplicates
                    const uniqueNames = new Set();
                    const uniqueSuppliers = [];
                    for (const supplier of suppliers) {
                        if (supplier.name && !uniqueNames.has(supplier.name)) {
                            uniqueNames.add(supplier.name);
                            uniqueSuppliers.push(supplier);
                        }
                    }

                    return uniqueSuppliers;
                } catch (error) {
                    console.error('Error fetching data from Google Sheet:', error);
                    // Fallback options with emails
                    return [
                        { name: 'Supplier A', email: 'supplierA@example.com' },
                        { name: 'Supplier B', email: 'supplierB@example.com' },
                        { name: 'Supplier C', email: 'supplierC@example.com' }
                    ];
                }
            };
            
// Function to render a single claim request card
const createClaimCard = (request) => {
  const card = document.createElement('div');
  card.className = 'card p-4 rounded-lg shadow-md hover:shadow-lg';
  card.dataset.reqId = request["REQ-ID"] || '';
  card.dataset.product = request["Product"] || '';
  card.dataset.qty = request["Qty"] || '';
  card.dataset.issue = request["Issue"] || '';

  const pReq = document.createElement('p');
  pReq.className = 'text-xs font-semibold text-gray-500 mb-1';
  pReq.innerHTML = `Request ID: <span class="font-medium text-blue-600">${String(request["REQ-ID"]||'')}</span>`;

  const h2 = document.createElement('h2');
  h2.className = 'text-base font-bold text-blue-900 mt-1';
  h2.textContent = request["Dealer Name"] || '';

  const pProduct = document.createElement('p');
  pProduct.className = 'text-gray-700 text-xs mt-1';
  pProduct.innerHTML = `Product: <span class="font-medium">${String(request["Product"]||'')}</span>`;

  const pQty = document.createElement('p');
  pQty.className = 'text-gray-700 text-xs';
  pQty.innerHTML = `Approved Quantity: <span class="font-medium">${String(request["Approved Qty"]||'')}</span>`;

  const pCrm = document.createElement('p');
  pCrm.className = 'text-gray-700 text-xs';
  pCrm.innerHTML = `CRM: <span class="font-medium">${String(request["CRM Name"]||'')}</span>`;

  const pIssue = document.createElement('p');
  pIssue.className = 'text-gray-700 text-xs';
  pIssue.innerHTML = `Issue: <span class="font-medium">${String(request["Issue"]||'')}</span>`;

  const remarkBox = document.createElement('div');
  remarkBox.className = 'remark-box mt-3 p-2 bg-blue-50 border border-blue-200 rounded-md';
  remarkBox.innerHTML = `<p class="text-xs font-semibold text-blue-800">Owner's Remark:</p>
                         <p class="text-xs text-blue-700 italic">${String(request["Owner Remark"]||'')}</p>`;

  const btnRow = document.createElement('div');
  btnRow.className = 'flex mt-4 space-x-1';

  // --- Dealer Claim ---
  if (request["Dealer CN Vch No"]) {
    const dealerLabel = document.createElement('span');
    dealerLabel.className = 'px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded';
    dealerLabel.textContent = 'Dealer Claim Done';
    btnRow.appendChild(dealerLabel);
  } else {
    const btnDealer = document.createElement('button');
    btnDealer.className = 'btn btn-dealer';
    btnDealer.dataset.id = request["REQ-ID"]||'';
    btnDealer.textContent = 'Dealer Claim';
    btnRow.appendChild(btnDealer);
  }

  // --- Supplier Claim ---
  if (request["Supplier Name"]) {
    const supplierLabel = document.createElement('span');
    supplierLabel.className = 'px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded';
    supplierLabel.textContent = 'Supplier Claim Done';
    btnRow.appendChild(supplierLabel);
  } else {
    const btnSupplier = document.createElement('button');
    btnSupplier.className = 'btn btn-supplier supplier-claim-btn';
    btnSupplier.dataset.id = request["REQ-ID"]||'';
    btnSupplier.textContent = 'Supplier Claim';
    btnRow.appendChild(btnSupplier);
  }

  // --- Clear button always visible ---
  const btnClear = document.createElement('button');
  btnClear.className = 'btn btn-clear';
  btnClear.dataset.id = request["REQ-ID"]||'';
  btnClear.textContent = 'Clear';
  btnRow.appendChild(btnClear);

  card.append(pReq, h2, pProduct, pQty, pCrm, pIssue, remarkBox, btnRow);
  requestsContainer.appendChild(card);
};

            // Main function to load and render requests
            const loadRequests = async () => {
                showLoader();
                requestsContainer.innerHTML = '';
                const requests = await getClaimRequests();
                hideLoader();

                if (requests.length > 0) {
                    requests.forEach(createClaimCard);
                } else {
                    requestsContainer.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10">
                        <p>No claim requests found.</p>
                    </div>`;
                }
            };

            loadRequests();

            // Function to close the supplier modal
            const closeSupplierModal = () => {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    supplierModal.classList.add('hidden');
                    if (tomSelectInstance) {
                        tomSelectInstance.destroy();
                        tomSelectInstance = null;
                    }
                }, 300);
            };

            // Function to close the email modal
            const closeEmailModal = () => {
                emailModalContent.classList.remove('scale-100', 'opacity-100');
                emailModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    emailModal.classList.add('hidden');
                    emailInput.value = ''; // Reset input field
                }, 300);
            };

            closeModalBtn.addEventListener('click', closeSupplierModal);
            closeEmailModalBtn.addEventListener('click', closeEmailModal);

            // Close the modals when clicking outside their content
            supplierModal.addEventListener('click', (e) => {
                if (e.target === supplierModal) {
                    closeSupplierModal();
                }
            });

            emailModal.addEventListener('click', (e) => {
                if (e.target === emailModal) {
                    closeEmailModal();
                }
            });


            // Handle "Supplier Claim Done" button click on the card
                requestsContainer.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.supplier-claim-btn');
                    if (!btn) return;
                
                    const reqId = btn.getAttribute('data-id');
                    if (!reqId) return;
                
                    currentReqId = reqId;
                    
                    // Show modal
                    supplierModal.classList.remove('hidden');
                    setTimeout(() => {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }, 10);

                    // Fetch data and initialize Tom Select
                    const suppliers = await getSupplierData();
                    
                    if (tomSelectInstance) {
                        tomSelectInstance.destroy();
                    }
                    
                    tomSelectInstance = new TomSelect('#supplier-select', {
                      create: true,
                      sortField: { field: "text", direction: "asc" },
                      options: suppliers.map(s => ({ value: s.name, text: s.name, email: s.email })),
                      plugins: ['dropdown_input'],
                      dropdownParent: document.body   // safer
                    });
                });

            // Handle the "Done" button click inside the supplier modal
                document.getElementById('done-btn').addEventListener('click', async () => {
                    const selectedValue = tomSelectInstance.getValue();
                    const selectedOption = tomSelectInstance.options[selectedValue];
                
                    currentSupplierName = selectedValue;
                    let supplierEmail = selectedOption ? selectedOption.email : null;
                
                    if (!supplierEmail) {
                        // ðŸ‘‰ This is a new custom supplier OR one without email
                        closeSupplierModal();
                        // Show email input modal
                        emailModal.classList.remove('hidden');
                        setTimeout(() => {
                            emailModalContent.classList.remove('scale-95', 'opacity-0');
                            emailModalContent.classList.add('scale-100', 'opacity-100');
                        }, 10);
                    } else {
                        // Existing supplier with an email â†’ send request directly
                        await sendPostRequest(currentReqId, currentSupplierName, supplierEmail);
                        closeSupplierModal();
                    }
                });


                submitEmailBtn.addEventListener('click', async () => {
                    const supplierEmail = emailInput.value.trim();
                
                    if (!supplierEmail) {
                        showMessageBox('Validation Error', 'Please enter a valid email address.');
                        return;
                    }
                
                    const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                    if (!emailPattern.test(supplierEmail)) {
                        showMessageBox('Validation Error', 'Please enter a valid email address.');
                        return;
                    }
                
                    // ðŸ‘‰ Use currentSupplierName (custom supplier) + provided email
                    await sendPostRequest(currentReqId, currentSupplierName, supplierEmail);
                    closeEmailModal();
                });


            // Function to send the POST request
                    const sendPostRequest = async (reqId, supplierName, supplierEmail) => {
                        showLoader('Sending data to server...');
                    
                        // Find the card by reqId
                        const card = document.querySelector(`.card[data-req-id="${reqId}"]`);
                        const product = card?.getAttribute("data-product") || "";
                        const qty = card?.getAttribute("data-qty") || "";
                        const issue = card?.getAttribute("data-issue") || "";
                    
                        const postUrl = 'https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec'; 
                        const payload = {
                            reqId: reqId,
                            supplierName: supplierName,
                            supplierEmail: supplierEmail,
                            product: product,
                            qty: qty,
                            issue: issue
                        };
                    
                        try {
                            const response = await fetch(postUrl, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                    
                            showMessageBox('Success!', `Submitted to server for REQ-ID ${reqId}.`);
                            await loadRequests();
                        } catch (error) {
                            console.error('Error sending POST request:', error);
                            showMessageBox('Error', 'Could not submit to server.');
                        } finally {
                            hideLoader();
                        }
                    };

// ---------------------- NEW CODE FOR DEALER CLAIM START ----------------------

            // Handle "Dealer Claim" button click on the card
            requestsContainer.addEventListener('click', async (e) => {
                const btn = e.target.closest('.btn-dealer');
                if (!btn) return;

                const reqId = btn.getAttribute('data-id');
                const card = btn.closest('.card');
                
                // Check if a form already exists to prevent duplicates
                if (card.querySelector('.cn-input-form')) {
                    return;
                }

                // Hide the original buttons
                const btnRow = card.querySelector('.flex.mt-4');
                btnRow.style.display = 'none';

                // Create the input form
                const formHtml = `
                    <div class="cn-input-form mt-4">
                        <label for="cn-input-${reqId}" class="block text-xs font-semibold text-gray-700 mb-1">Enter CN No.:</label>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="cn-input-${reqId}" class="flex-grow px-2 py-1 border border-gray-300 rounded-md text-xs focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="e.g., CN12345" required>
                            <button class="btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-md" data-req-id="${reqId}" id="submit-cn-btn">
                                <i class="fas fa-paper-plane mr-1"></i> Submit
                            </button>
                        </div>
                    </div>
                `;

                // Append the form to the card
                // FIX: Select the element with the class "remark-box"
                const remarkBox = card.querySelector('.remark-box');
                if (remarkBox) {
                    remarkBox.insertAdjacentHTML('afterend', formHtml);
                } else {
                    console.error('Remark box element not found.');
                    return;
                }

                // Event listener for the new submit button
                // Use a delegated event listener on the requestsContainer to handle dynamically created buttons
                requestsContainer.querySelector(`#submit-cn-btn[data-req-id="${reqId}"]`).addEventListener('click', async (submitEvent) => {
                    submitEvent.preventDefault();
                    const cnInput = document.getElementById(`cn-input-${reqId}`);
                    const cnNo = cnInput.value.trim();

                    if (cnNo === '') {
                        showMessageBox('Validation Error', 'Please enter a Credit Note number.');
                        return;
                    }

                    await sendDealerClaimRequest(reqId, cnNo);

                    // Clean up the card UI after submission
                    card.querySelector('.cn-input-form').remove();
                    btnRow.style.display = 'flex';
                });
            });

            // Function to send the POST request for dealer claims
            const sendDealerClaimRequest = async (reqId, cnNo) => {
                showLoader('Submitting CN No. for dealer claim...');
                const postUrl = 'https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec';
                const payload = {
                    reqId: reqId,
                    cnNo: cnNo,
                    action: 'dealerClaim'
                };

                try {
                    const response = await fetch(postUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    showMessageBox('Success!', `CN No. ${cnNo} submitted for REQ-ID ${reqId}.`);
                    await loadRequests(); // Reload the list to reflect the change
                } catch (error) {
                    console.error('Error sending dealer claim POST request:', error);
                    showMessageBox('Error', 'Could not submit dealer claim to server.');
                } finally {
                    hideLoader();
                }
            };
// Add this event listener within the main 'DOMContentLoaded' block
        requestsContainer.addEventListener('click', async (e) => {
            const clearBtn = e.target.closest('.btn-clear');
            if (!clearBtn) return;
        
            const reqId = clearBtn.getAttribute('data-id');
        
            // Prompt for Dealer Claim
            const dealerClaimCleared = confirm("Have you cleared Dealer Claim?");
            if (!dealerClaimCleared) {
                showMessageBox('Action Required', 'Clear dealer claim first');
                return;
            }
        
            // Prompt for Supplier Claim
            const supplierClaimCleared = confirm("Have you cleared Supplier Claim?");
            if (!supplierClaimCleared) {
                showMessageBox('Action Required', 'Clear Supplier Claim first');
                return;
            }
        
            // If both are cleared, send the POST request
            await sendClearRequest(reqId);
        });
        
        // Add this function within the main script block
        const sendClearRequest = async (reqId) => {
            showLoader('Clearing the claim request...');
            const postUrl = 'https://script.google.com/macros/s/AKfycbxKHLxhcxparrfNpCcC8jExol17fJjmL-uuMxia_uld7t8AcsMrDUxZkIrRT-GT9d1AJw/exec';
            const payload = {
                reqId: reqId,
                action: 'clear'
            };
        
            try {
                const response = await fetch(postUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
        
                showMessageBox('Success!', `Request ID ${reqId} has been cleared.`);
                await loadRequests();
            } catch (error) {
                console.error('Error sending clear request:', error);
                showMessageBox('Error', 'Could not clear claim on the server.');
            } finally {
                hideLoader();
            }
        };
            

// ---------------------- NEW CODE FOR DEALER CLAIM END ----------------------

        });
    </script>
</body>
</html>
