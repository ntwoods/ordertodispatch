<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level-1 CRM â€” Credibility & Stock</title>

  <!-- Tailwind -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Premium-ish fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:#f5f9ff; }

    /* Blue-white premium vibes */
    .app-shell {
      background:
        radial-gradient(1100px 500px at 10% -10%, rgba(37,99,235,.18), transparent 60%),
        radial-gradient(900px 500px at 90% -20%, rgba(59,130,246,.14), transparent 55%),
        linear-gradient(180deg, #f7fbff 0%, #f5f9ff 60%, #f7fbff 100%);
      min-height: 100vh;
    }
    .glass-bar {
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(147,197,253,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(2, 32, 71, .06);
    }
    .card {
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(148, 163, 184, .35);
      box-shadow: 0 18px 40px rgba(2, 32, 71, .07);
      transition: transform .18s ease, box-shadow .18s ease;
      border-radius: 16px;
      overflow: hidden;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 24px 50px rgba(2, 32, 71, .10); }

    /* Attention highlight when overdue */
    .overdue-card {
      border-color: rgba(239, 68, 68, .70) !important;
      box-shadow: 0 22px 60px rgba(239, 68, 68, .18), 0 18px 40px rgba(2, 32, 71, .07) !important;
    }
    .overdue-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 26px 70px rgba(239, 68, 68, .24), 0 24px 50px rgba(2, 32, 71, .10) !important;
    }


    .card-topline {
      height: 4px;
      background: linear-gradient(90deg, rgba(59,130,246,.9), rgba(147,197,253,.9));
    }
    .card-topline.red { background: linear-gradient(90deg, rgba(239,68,68,.95), rgba(248,113,113,.9)); }
    .card-topline.yellow { background: linear-gradient(90deg, rgba(245,158,11,.95), rgba(251,191,36,.9)); }
    .card-topline.green { background: linear-gradient(90deg, rgba(16,185,129,.95), rgba(52,211,153,.9)); }

    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    .btn-loading { position:relative; color:transparent!important; pointer-events:none; }
    .btn-loading::after { content:""; position:absolute; width:16px;height:16px; top:50%;left:50%; margin:-8px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite; }
    .status-loading { position:relative; pointer-events:none; }
    .status-loading::after { content:""; position:absolute; width:12px;height:12px; top:50%;left:50%; margin:-6px; border:1px solid #64748b; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite; }

    .modal-overlay { background: rgba(2, 18, 44, .50); backdrop-filter: blur(2px); }
    .success-notification { position:fixed; top:18px; right:18px; background:#10b981; color:#fff; padding:12px 16px; border-radius:10px;
      box-shadow:0 10px 26px rgba(2, 32, 71, .22); transform:translateX(120%); transition: transform .28s; z-index:1000; }
    .success-notification.show { transform:translateX(0); }
    .success-notification.hide { transform:translateX(120%); }

    .dealer-pill { display:inline-flex; align-items:center; gap:6px; padding:.25rem .65rem; border-radius:999px; font-size:.75rem; font-weight:700; color:#0b1220; border:1px solid rgba(148,163,184,.55); background: rgba(241,245,249,.8); }
    .dealer-pill.red { color:#7f1d1d; border-color: rgba(239,68,68,.35); background: rgba(254,226,226,.85); }
    .dealer-pill.yellow { color:#7c2d12; border-color: rgba(245,158,11,.35); background: rgba(254,243,199,.90); }
    .dealer-pill.green { color:#064e3b; border-color: rgba(16,185,129,.35); background: rgba(209,250,229,.90); }

    .mode-pill{display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px; font-size:12px; font-weight:700}
    .mode-view{background:#e8f3ff;color:#0b63b6;border:1px solid #bcdcff}
    .mode-crm{background:#eafff0;color:#0b7a2b;border:1px solid #bff0cf}
    .mode-ea{background:#fff6e8;color:#a05a00;border:1px solid #f2ddb9}

    .kv { display:flex; align-items:flex-start; justify-content:space-between; gap:14px; font-size:13px; }
    .kv .k { color:#64748b; }
    .kv .v { color:#0b1220; font-weight:600; text-align:right; word-break: break-word; }
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
  </style>
</head>

<body class="app-shell">

  <header class="max-w-6xl mx-auto px-4 pt-6">
    <div class="glass-bar rounded-2xl px-4 py-4 md:px-6 md:py-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight">
          Level-1 CRM Checks
        </h1>
        <p class="text-sm text-gray-600">Credit + Stock validation with deadline tracking (L1)</p>
      </div>
      <div class="flex items-center gap-2">
        <div id="modePill" class="mode-pill mode-ea" style="display:none;">EA Mode</div>
      </div>
    </div>
  </header>

  <!-- Success toast -->
  <div id="successNotification" class="success-notification">
    <div class="flex items-center space-x-2">
      <span class="font-semibold">âœ…</span>
      <span id="successMessage">Done</span>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 pb-12 mt-6">
    <div id="loadingContainer" class="flex justify-center items-center py-16">
      <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
    </div>

    <div id="ordersContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 hidden"></div>

    <div id="noDataContainer" class="text-center py-20 hidden">
      <div class="text-gray-400 text-6xl mb-4">ðŸ“‹</div>
      <h3 class="text-xl font-semibold text-gray-800 mb-1">No Orders Found</h3>
      <p class="text-gray-600">Abhi koi sales orders available nahi hai.</p>
    </div>
  </main>

  <!-- Stock Remark Modal -->
  <div id="stockModal" class="fixed inset-0 modal-overlay z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 border border-blue-100">
        <h3 class="text-lg font-extrabold text-gray-900 mb-2">Stock Status Remark</h3>
        <p class="text-gray-600 mb-3">Stock status ke liye remark mandatory hai:</p>
        <input id="stockRemark" type="text" maxlength="50"
               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
               placeholder="Enter stock remark...">
        <div class="text-xs text-gray-500 mt-1">Max 50 characters</div>
        <div class="flex justify-end space-x-3 mt-5">
          <button onclick="closeStockModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button id="stockSubmitBtn" onclick="submitStockStatus()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Proceed: Bill To Ship To? Modal -->
  <div id="proceedModal" class="fixed inset-0 modal-overlay z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 border border-blue-100">
        <h3 class="text-lg font-extrabold text-gray-900 mb-2">Bill To Ship To Order?</h3>
        <p class="text-gray-600 mb-4">Confirm karo â€” yahi selection approval payload me jayega.</p>
        <div class="flex items-center justify-end space-x-3">
          <button onclick="closeProceedModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button onclick="approveOrderPending('No')" class="px-5 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-xl font-semibold">No</button>
          <button onclick="approveOrderPending('Yes')" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Mode resolution from URL ===== */
    const urlParams = new URLSearchParams(location.search);
    const rawMode = (urlParams.get('mode') || '').toLowerCase();
    const crmParam = urlParams.get('crm');

    // Always give "view" top priority
    const MODE = (rawMode === 'view') ? 'view' : (crmParam ? 'crm' : 'ea');
    const isViewOnly = (rawMode === 'view');

    // Export flag so viewOnly.js can reuse
    window.__FORCE_VIEW__ = isViewOnly;

    /* ===== Config ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycby7o8IwfJ1vgI-_2Ad-epHZHmOdVqTbNVWnncuv4BnDIiIcWNmuzrEspA9jIvgy9G84eQ/exec';

    /* ===== State ===== */
    let ordersData = [];
    let countdownIntervals = [];
    let currentStockOrderId = null, currentStockStatus = null, currentStockIndex = null;
    let pendingProceed = { orderId: null, index: null };

    document.addEventListener('DOMContentLoaded', () => fetchOrders());

    /* ===== UI helpers ===== */
    function paintModePill(){
      const pill = document.getElementById('modePill');
      pill.style.display = 'inline-flex';
      if (MODE === 'crm') {
        pill.textContent = `CRM Mode â€” ${crmParam}`;
        pill.className = 'mode-pill mode-crm';
      } else if (MODE === 'view') {
        pill.textContent = 'View Mode â€” Read Only';
        pill.className = 'mode-pill mode-view';
      } else {
        pill.textContent = 'EA Mode â€” All CRMs, Editable';
        pill.className = 'mode-pill mode-ea';
      }
    }

    function showSuccessNotification(message) {
      const n = document.getElementById('successNotification');
      document.getElementById('successMessage').textContent = message || 'Done';
      n.classList.remove('hide'); n.classList.add('show');
      setTimeout(() => { n.classList.remove('show'); n.classList.add('hide'); }, 2800);
    }

    function showLoading(show){
      document.getElementById('loadingContainer').classList.toggle('hidden', !show);
      document.getElementById('ordersContainer').classList.toggle('hidden', show);
      document.getElementById('noDataContainer').classList.add('hidden');
    }

    function showNoData(){
      document.getElementById('loadingContainer').classList.add('hidden');
      document.getElementById('ordersContainer').classList.add('hidden');
      document.getElementById('noDataContainer').classList.remove('hidden');
    }

    /* ===== Data fetch ===== */
    async function fetchOrders(){
      try{
        paintModePill();
        showLoading(true);

        let requestUrl = API_URL;
        if (MODE === 'crm') {
          requestUrl += `?crm=${encodeURIComponent(crmParam)}`;
        } else if (MODE === 'view') {
          requestUrl += `?mode=view`;
        } // EA: no params

        const res = await fetch(requestUrl);
        const json = await res.json();
        ordersData = (json.status==='success' && Array.isArray(json.data)) ? json.data : [];
        renderOrders();

        // Apply read-only only in view mode if helper exists
        if (isViewOnly && typeof setReadOnlyMode === "function") setReadOnlyMode();

      } catch(e){
        console.error(e);
        showNoData();
      } finally{
        showLoading(false);
      }
    }

    /* ===== Render ===== */
    function renderOrders(){
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';
      if(!ordersData.length){ showNoData(); return; }

      countdownIntervals.forEach(clearInterval);
      countdownIntervals = [];

      ordersData.forEach((order, i) => container.appendChild(createOrderCard(order, i)));
      container.classList.remove('hidden');

      // Apply read-only if mode=view and script loaded
      if (window.__FORCE_VIEW__ && typeof setReadOnlyMode === "function") setReadOnlyMode();
    }

    function createOrderCard(order, index){
      const card = document.createElement('div');
      card.id = `card-${index}`;

      const type = (order.dealerType || '').toLowerCase();
      const typeClass = (type === 'red' || type === 'yellow' || type === 'green') ? type : '';
      const topLineClass = typeClass ? typeClass : '';

      const deadline = calculateDeadline(toDateSafe_(order.crmAssignedOnISO || order.crmAssignedOn));
      const countdownId = `countdown-${index}`;

      card.className = 'card';
      card.innerHTML = `
        <div class="card-topline ${topLineClass}"></div>

        <div class="p-5">
          <!-- Header -->
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-gray-500 font-semibold">Order ID</div>
              <div class="text-lg font-extrabold text-gray-900 tracking-tight break-words">${escapeHtml_(order.orderId || '-')}</div>
            </div>

            <div class="text-right">
              <div class="text-xs text-gray-500 font-semibold">Deadline</div>
              <div id="${countdownId}" class="mono text-sm font-extrabold px-2 py-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-100"></div>
            </div>
          </div>

          <!-- Timings -->
          <div class="mt-3 grid grid-cols-1 gap-2">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600 font-semibold">Order Received</span>
              <span class="mono font-bold text-gray-900">${escapeHtml_(order.orderReceivedOn || '')}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600 font-semibold">CRM Assigned</span>
              <span class="mono font-bold text-gray-900">${escapeHtml_(order.crmAssignedOn || '')}</span>
            </div>
          </div>

          <!-- Info -->
          <div class="mt-4 space-y-2">
            <div class="kv"><div class="k">Dealer Name</div><div class="v">${escapeHtml_(order.dealerName || '')}</div></div>
            <div class="kv"><div class="k">Marketing Person</div><div class="v">${escapeHtml_(order.marketingPersonName || '')}</div></div>
            <div class="kv"><div class="k">CRM</div><div class="v">${escapeHtml_(order.crmName || '')}</div></div>
            <div class="kv"><div class="k">Concerned Owner</div><div class="v">${escapeHtml_(order.concernedOwner || '')}</div></div>
            <div class="kv"><div class="k">Location</div><div class="v">${escapeHtml_(order.location || '')}</div></div>
            <div class="kv">
              <div class="k">Dealer Type</div>
              <div class="v">
                <span class="dealer-pill ${typeClass}">${escapeHtml_(order.dealerType || 'NA')}</span>
              </div>
            </div>
            <div class="kv">
              <div class="k">Raw Order</div>
              <div class="v">
                <button onclick="openMultipleDocuments('${escapeAttr_(order.rawOrderUrl || '')}')" class="text-blue-700 hover:text-blue-900 underline font-semibold">
                  View Document
                </button>
              </div>
            </div>
          </div>

          <!-- Editable controls -->
          <div class="editable mt-5">
            <div class="grid grid-cols-2 gap-3">
              <!-- Credit -->
              <div class="bg-white rounded-xl p-3 border border-blue-100">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-bold text-gray-800">Credit Status</span>
                </div>
                <div class="flex space-x-2">
                  <button onclick="toggleCreditStatus(${index}, 'approved')" class="p-1 rounded-full credit-approved-${index} bg-gray-200 hover:bg-green-100">
                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                  </button>
                  <button onclick="toggleCreditStatus(${index}, 'rejected')" class="p-1 rounded-full credit-rejected-${index} bg-gray-200 hover:bg-red-100">
                    <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                  </button>
                </div>
              </div>

              <!-- Stock -->
              <div class="bg-white rounded-xl p-3 border border-blue-100">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-bold text-gray-800">Stock Status</span>
                </div>
                <div class="flex space-x-2">
                  <button onclick="promptStockStatus('${escapeAttr_(order.orderId || '')}', ${index}, 'approved')" class="p-1 rounded-full stock-approved-${index} bg-gray-200 hover:bg-green-100">
                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                  </button>
                  <button onclick="promptStockStatus('${escapeAttr_(order.orderId || '')}', ${index}, 'rejected')" class="p-1 rounded-full stock-rejected-${index} bg-gray-200 hover:bg-red-100">
                    <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 0 010-1.414z" clip-rule="evenodd"/></svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <label for="proceedRemark-${index}" class="block text-sm font-bold text-gray-800 mb-2">Remark for Proceed</label>
              <input id="proceedRemark-${index}" maxlength="100" placeholder="Enter remark to proceed..."
                    class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
              <div class="text-xs text-gray-500 mt-1">Max 100 characters</div>
            </div>

            <div class="mt-4">
              <button id="approve-btn-${index}" onclick="openProceedDialog('${escapeAttr_(order.orderId || '')}', ${index})"
                      class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-xl font-extrabold tracking-wide">
                Proceed
              </button>
            </div>
          </div>
        </div>
      `;

      startCountdown(countdownId, deadline);
      return card;
    }

    /* ===== Deadline/Countdown (same logic as your existing HTML) ===== */
    const isSunday = d => d.getDay() === 0;

    function calculateDeadline(ts){
      const d = toDateSafe_(ts);
      if (!d) return new Date(0);

      const h = d.getHours(), m = d.getMinutes();
      const out = new Date(d);

      if ((h > 14 || (h === 14 && m >= 30)) && h < 24){
        do { out.setDate(out.getDate()+1); } while(isSunday(out));
        out.setHours(11,0,0,0);
      } else if (h < 9 || (h===9 && m<=30)){
        out.setHours(13,30,0,0);
      } else {
        out.setHours(out.getHours()+4);
      }
      return out;
    }

    function startCountdown(elId, deadline){
      const it = setInterval(() => {
        const el = document.getElementById(elId);
        if(!el){ clearInterval(it); return; }

        const diff = new Date(deadline) - new Date();
        if (diff <= 0){
          // Highlight whole card when overdue
          const card = document.getElementById(`card-${elId.split('-')[1]}`);
          if (card) card.classList.add('overdue-card');
          el.innerHTML = '<span class="text-red-600 font-extrabold">OVERDUE</span>';
          el.className = 'mono text-sm font-extrabold px-2 py-1 rounded-lg bg-red-50 text-red-700 border border-red-100';
          return;
        }

        const hh = Math.floor(diff/36e5);
        const mm = Math.floor((diff%36e5)/6e4);
        const ss = Math.floor((diff%6e4)/1000);

        const card = document.getElementById(`card-${elId.split('-')[1]}`);
        if (card) card.classList.remove('overdue-card');

        const urgent = diff <= 30*60*1000;
        el.className = urgent
          ? 'mono text-sm font-extrabold px-2 py-1 rounded-lg bg-red-50 text-red-700 border border-red-100'
          : 'mono text-sm font-extrabold px-2 py-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-100';

        el.innerHTML = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
      }, 1000);

      countdownIntervals.push(it);
    }

    /* ===== Proceed (Bill To Ship To?) ===== */
    function openProceedDialog(orderId, index) {
      pendingProceed.orderId = orderId;
      pendingProceed.index = index;

      const input = document.getElementById(`proceedRemark-${index}`);
      const remark = (input?.value || '').trim();
      if (!remark) {
        alert('Proceed ke liye remark mandatory hai.');
        input?.focus();
        return;
      }
      document.getElementById('proceedModal').classList.remove('hidden');
    }

    function closeProceedModal() {
      document.getElementById('proceedModal').classList.add('hidden');
      pendingProceed = { orderId: null, index: null };
    }

    async function approveOrderPending(billToShipTo) {
      try {
        const { orderId, index } = pendingProceed || {};
        if (!orderId && orderId !== 0) return;

        const input = document.getElementById(`proceedRemark-${index}`);
        const remark = (input?.value || '').trim();
        if (!remark) {
          alert('Proceed ke liye remark mandatory hai.');
          input?.focus(); return;
        }

        const btn = document.getElementById(`approve-btn-${index}`);
        btn?.classList.add('btn-loading');

        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'approveOrder',
            orderId,
            proceedRemark: remark,
            billToShipTo
          })
        });

        setTimeout(() => {
          btn?.classList.remove('btn-loading');
          showSuccessNotification(`Approved (BillToShipTo: ${billToShipTo})`);
          closeProceedModal();
          fetchOrders();
        }, 900);

      } catch (e) {
        console.error(e);
        closeProceedModal();
      }
    }

    /* ===== Credit/Stock toggles ===== */
    async function toggleCreditStatus(index, status){
      const a = document.querySelector(`.credit-approved-${index}`);
      const r = document.querySelector(`.credit-rejected-${index}`);
      const target = status==='approved'? a : r;

      target.classList.add('status-loading');
      target.disabled = true;

      [a,r].forEach(b => { b.classList.remove('bg-green-500','bg-red-500'); b.classList.add('bg-gray-200'); });

      const orderId = ordersData[index]?.orderId;

      try{
        await fetch(API_URL,{
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'updateCreditStatus',
            orderId,
            creditStatus: status==='approved'?'Yes':'No'
          })
        });

        setTimeout(() => {
          if(status==='approved'){ a.classList.replace('bg-gray-200','bg-green-500'); }
          else { r.classList.replace('bg-gray-200','bg-red-500'); }

          target.classList.remove('status-loading');
          target.disabled = false;
          showSuccessNotification(`Credit ${status==='approved'?'approved':'rejected'}!`);
        }, 650);

      } catch(e){
        console.error(e);
        target.classList.remove('status-loading');
        target.disabled = false;
      }
    }

    function promptStockStatus(orderId, index, status){
      currentStockOrderId = orderId;
      currentStockStatus = status;
      currentStockIndex = index;

      document.getElementById('stockModal').classList.remove('hidden');
      document.getElementById('stockRemark').focus();
    }

    function closeStockModal(){
      document.getElementById('stockModal').classList.add('hidden');
      document.getElementById('stockRemark').value = '';

      currentStockOrderId = null;
      currentStockStatus = null;
      currentStockIndex = null;
    }

    async function submitStockStatus(){
      const remark = document.getElementById('stockRemark').value.trim();
      if(!remark){ alert('Stock remark mandatory hai.'); return; }

      const btn = document.getElementById('stockSubmitBtn');
      btn.classList.add('btn-loading');

      const a = document.querySelector(`.stock-approved-${currentStockIndex}`);
      const r = document.querySelector(`.stock-rejected-${currentStockIndex}`);

      try{
        await fetch(API_URL,{
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'updateStockStatus',
            orderId: currentStockOrderId,
            stockStatus: currentStockStatus==='approved'?'Yes':'No',
            stockRemark: remark
          })
        });

        setTimeout(() => {
          [a,r].forEach(b => { b.classList.remove('bg-green-500','bg-red-500'); b.classList.add('bg-gray-200'); });
          if(currentStockStatus==='approved'){ a.classList.replace('bg-gray-200','bg-green-500'); }
          else { r.classList.replace('bg-gray-200','bg-red-500'); }

          btn.classList.remove('btn-loading');
          showSuccessNotification(`Stock ${currentStockStatus==='approved'?'approved':'rejected'}!`);
          closeStockModal();
        }, 650);

      } catch(e){
        console.error(e);
        btn.classList.remove('btn-loading');
        closeStockModal();
      }
    }

    /* ===== Helpers ===== */
    function openMultipleDocuments(urlString){
      const urls = (urlString||'').split(',').map(u=>u.trim()).filter(Boolean);
      if(!urls.length){ alert('No valid URLs found'); return; }
      if(urls.length>1 && !confirm(`This will open ${urls.length} documents in separate tabs. Continue?`)) return;
      urls.forEach((u,i)=> setTimeout(()=>window.open(u,'_blank'), i*100));
    }

    function toDateSafe_(v){
      if (!v) return null;
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    function escapeHtml_(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr_(s){
      // keep simple: escape quotes + backslashes
      return String(s ?? '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }
  </script>

  <!-- Your read-only helper: only has effect in View mode -->
  <script src="js/viewOnly.js"></script>
</body>
</html>
