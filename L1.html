<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Credibility & Stock Availability Check by CRM</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link src="js/styles.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background:#f8fafc; }
    .card-hover { transition: transform .2s, box-shadow .2s; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .btn-loading { position:relative; color:transparent!important; pointer-events:none; }
    .btn-loading::after { content:""; position:absolute; width:16px;height:16px; top:50%;left:50%; margin:-8px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite; }
    .status-loading { position:relative; pointer-events:none; }
    .status-loading::after { content:""; position:absolute; width:12px;height:12px; top:50%;left:50%; margin:-6px; border:1px solid #6b7280; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite; }
    .modal-overlay { background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
    .success-notification { position:fixed; top:20px; right:20px; background:#10b981; color:#fff; padding:12px 16px; border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.15); transform:translateX(120%); transition: transform .3s; z-index:1000; }
    .success-notification.show { transform:translateX(0); }
    .success-notification.hide { transform:translateX(120%); }
    .dealer-type-badge { display:inline-flex; align-items:center; padding:.25rem .6rem; border-radius:9999px; font-size:.75rem; font-weight:600; color:#fff; margin-left:.5rem; }
    /* mode pill */
    .mode-pill{display:inline-block;margin:0 auto 10px auto;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600}
    .mode-view{background:#e8f3ff;color:#0b63b6;border:1px solid #bcdcff}
    .mode-crm{background:#eafff0;color:#0b7a2b;border:1px solid #bff0cf}
    .mode-ea{background:#fff6e8;color:#a05a00;border:1px solid #f2ddb9}
  </style>
</head>

<body class="min-h-screen">
  <header class="px-4 py-5 text-center">
    <h1 class="text-xl md:text-2xl font-semibold text-black">
      Credibility & Stock Availability Check by CRM
    </h1>
    <div id="modePill" class="mode-pill mode-ea" style="display:none;">EA Mode</div>
  </header>

  <!-- Success toast -->
  <div id="successNotification" class="success-notification">
    <div class="flex items-center space-x-2">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
      <span id="successMessage">Action completed successfully!</span>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 pb-12">
    <div id="loadingContainer" class="flex justify-center items-center py-16">
      <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
    </div>

    <div id="ordersContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 hidden"></div>

    <div id="noDataContainer" class="text-center py-20 hidden">
      <div class="text-gray-400 text-6xl mb-4">ðŸ“‹</div>
      <h3 class="text-xl font-semibold text-gray-700 mb-1">No Orders Found</h3>
      <p class="text-gray-500">No sales orders are currently available.</p>
    </div>
  </main>

  <!-- Stock Remark Modal -->
  <div id="stockModal" class="fixed inset-0 modal-overlay z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Stock Status Remark</h3>
        <p class="text-gray-600 mb-3">Please provide a remark for the stock status:</p>
        <input id="stockRemark" type="text" maxlength="50"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
               placeholder="Enter stock remark...">
        <div class="text-xs text-gray-500 mt-1">Maximum 50 characters</div>
        <div class="flex justify-end space-x-3 mt-5">
          <button onclick="closeStockModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button id="stockSubmitBtn" onclick="submitStockStatus()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Proceed: Bill To Ship To? Modal -->
  <div id="proceedModal" class="fixed inset-0 modal-overlay z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Is Bill To Ship To Order?</h3>
        <p class="text-gray-600 mb-4">Please confirm. Your selection will be sent with the approval payload.</p>
        <div class="flex items-center justify-end space-x-3">
          <button onclick="closeProceedModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button onclick="approveOrderPending('No')" class="px-5 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg">No</button>
          <button onclick="approveOrderPending('Yes')" class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Mode resolution from URL ===== */
    const urlParams = new URLSearchParams(location.search);
    const rawMode = (urlParams.get('mode') || '').toLowerCase();
    const crmParam = urlParams.get('crm');
    // crm present -> CRM mode ; else if mode=view -> View ; else -> EA
    const MODE = crmParam ? 'crm' : (rawMode === 'view' ? 'view' : 'ea');
    const isViewOnly = MODE === 'view';

    /* ===== Config ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycby7o8IwfJ1vgI-_2Ad-epHZHmOdVqTbNVWnncuv4BnDIiIcWNmuzrEspA9jIvgy9G84eQ/exec';

    /* ===== State ===== */
    let ordersData = [];
    let countdownIntervals = [];
    let currentStockTimestamp = null, currentStockStatus = null, currentStockIndex = null;
    let pendingProceed = { timestamp: null, index: null };

    document.addEventListener('DOMContentLoaded', () => fetchOrders());

    /* ===== UI helpers ===== */
    function paintModePill(){
      const pill = document.getElementById('modePill');
      pill.style.display = 'inline-block';
      if (MODE === 'crm') {
        pill.textContent = `CRM Mode â€” ${crmParam}`;
        pill.className = 'mode-pill mode-crm';
      } else if (MODE === 'view') {
        pill.textContent = 'View Mode â€” Read Only';
        pill.className = 'mode-pill mode-view';
      } else {
        pill.textContent = 'EA Mode â€” All CRMs, Editable';
        pill.className = 'mode-pill mode-ea';
      }
    }
    function showSuccessNotification(message) {
      const n = document.getElementById('successNotification');
      document.getElementById('successMessage').textContent = message || 'Done';
      n.classList.remove('hide'); n.classList.add('show');
      setTimeout(() => { n.classList.remove('show'); n.classList.add('hide'); }, 3000);
    }
    function showLoading(show){
      document.getElementById('loadingContainer').classList.toggle('hidden', !show);
      document.getElementById('ordersContainer').classList.toggle('hidden', show);
      document.getElementById('noDataContainer').classList.add('hidden');
    }
    function showNoData(){
      document.getElementById('loadingContainer').classList.add('hidden');
      document.getElementById('ordersContainer').classList.add('hidden');
      document.getElementById('noDataContainer').classList.remove('hidden');
    }

    /* ===== Data fetch ===== */
    async function fetchOrders(){
      try{
        paintModePill();
        showLoading(true);

        let requestUrl = API_URL;
        if (MODE === 'crm') {
          requestUrl += `?crm=${encodeURIComponent(crmParam)}`;
        } else if (MODE === 'view') {
          requestUrl += `?mode=view`;
        } // EA: no params

        const res = await fetch(requestUrl);
        const json = await res.json();
        ordersData = (json.status==='success' && json.data) ? json.data : [];
        renderOrders();

        // Apply read-only only in view mode if helper exists
        if (isViewOnly && typeof setReadOnlyMode === "function") {
          setReadOnlyMode();
        }
      } catch(e){
        console.error(e); showNoData();
      } finally{
        showLoading(false);
      }
    }

    /* ===== Render ===== */
    function renderOrders(){
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';
      if(!ordersData.length){ showNoData(); return; }
      countdownIntervals.forEach(clearInterval); countdownIntervals = [];

      ordersData.forEach((order, i) => container.appendChild(createOrderCard(order, i)));
      container.classList.remove('hidden');
    }

    function createOrderCard(order, index){
      const card = document.createElement('div');
      card.className = 'rounded-xl shadow-lg p-6 card-hover border border-gray-200 bg-white';

      const deadline = calculateDeadline(new Date(order.timestamp));
      const countdownId = `countdown-${index}`;

      // Dealer type badge color
      const colorMap = { red:'bg-red-500', yellow:'bg-yellow-500', green:'bg-green-500' };
      const badge = order.dealerType
        ? `<span class="dealer-type-badge ${colorMap[(order.dealerType||'').toLowerCase()]||'bg-gray-500'}">${order.dealerType}</span>`
        : '';

      card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <div class="flex items-center">
            <h3 class="text-lg font-bold text-gray-900">${order.dealerName || ''}</h3>
            ${badge}
          </div>
          <div class="text-right"><div id="${countdownId}" class="text-sm font-mono bg-white px-2 py-1 rounded"></div></div>
        </div>

        <div class="space-y-3 mb-6">
          <div class="flex justify-between text-sm"><span class="text-gray-600">Marketing Person:</span><span class="font-medium">${order.marketingPersonName || ''}</span></div>
          <div class="flex justify-between text-sm"><span class="text-gray-600">Location:</span><span class="font-medium">${order.location || ''}</span></div>
          <div class="flex justify-between text-sm"><span class="text-gray-600">CRM:</span><span class="font-medium">${order.crmName || ''}</span></div>
          <div class="flex justify-between text-sm"><span class="text-gray-600">Concerned Owner:</span><span class="font-medium">${order.concernedOwner || ''}</span></div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">File:</span>
            <button onclick="openMultipleDocuments('${(order.fileUploadLink||'').replace(/'/g, "\\'")}', ${index})" class="text-blue-600 hover:text-blue-800 underline">View Document</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <!-- Credit -->
          <div class="bg-white rounded-lg p-3 border">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Credit Status</span>
            </div>
            <div class="flex space-x-2">
              <button onclick="toggleCreditStatus(${index}, 'approved')" class="p-1 rounded-full credit-approved-${index} bg-gray-200 hover:bg-green-100">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              </button>
              <button onclick="toggleCreditStatus(${index}, 'rejected')" class="p-1 rounded-full credit-rejected-${index} bg-gray-200 hover:bg-red-100">
                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
              </button>
            </div>
          </div>

          <!-- Stock -->
          <div class="bg-white rounded-lg p-3 border">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Stock Status</span>
            </div>
            <div class="flex space-x-2">
              <button onclick="promptStockStatus('${order.timestamp}', ${index}, 'approved')" class="p-1 rounded-full stock-approved-${index} bg-gray-200 hover:bg-green-100">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              </button>
              <button onclick="promptStockStatus('${order.timestamp}', ${index}, 'rejected')" class="p-1 rounded-full stock-rejected-${index} bg-gray-200 hover:bg-red-100">
                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
              </button>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label for="proceedRemark-${index}" class="block text-sm font-medium text-gray-700 mb-2">Remark for Proceed:</label>
          <input id="proceedRemark-${index}" maxlength="100" placeholder="Enter remark to proceed..."
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <div class="text-xs text-gray-500 mt-1">Maximum 100 characters</div>
        </div>

        <div class="flex space-x-3">
          <button id="approve-btn-${index}" onclick="openProceedDialog('${order.timestamp}', ${index})"
                  class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-medium">
            Proceed
          </button>
        </div>
      `;

      startCountdown(countdownId, deadline);
      return card;
    }

    /* ===== Deadline/Countdown ===== */
    const isSunday = d => d.getDay() === 0;
    function calculateDeadline(ts){
      const d = new Date(ts);
      const h = d.getHours(), m = d.getMinutes();
      const out = new Date(d);
      if ((h > 14 || (h === 14 && m >= 30)) && h < 24){
        do { out.setDate(out.getDate()+1); } while(isSunday(out));
        out.setHours(10,0,0,0);
      } else if (h < 9 || (h===9 && m<=30)){
        out.setHours(13,30,0,0);
      } else {
        out.setHours(out.getHours()+4);
      }
      return out;
    }

    function startCountdown(elId, deadline){
      const it = setInterval(() => {
        const el = document.getElementById(elId);
        if(!el){ clearInterval(it); return; }
        const diff = new Date(deadline) - new Date();
        if (diff <= 0){ el.innerHTML = '<span class="text-red-600 font-bold">OVERDUE</span>'; return; }
        const h = Math.floor(diff/36e5);
        const m = Math.floor((diff%36e5)/6e4);
        const s = Math.floor((diff%6e4)/1000);
        const urgent = diff <= 30*60*1000;
        el.innerHTML = `<span class="${urgent?'text-red-600':'text-blue-600'} font-bold">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span>`;
      }, 1000);
      countdownIntervals.push(it);
    }

    /* ===== Proceed (Bill To Ship To?) ===== */
    function openProceedDialog(timestamp, index) {
      pendingProceed.timestamp = timestamp;
      pendingProceed.index = index;

      const input = document.getElementById(`proceedRemark-${index}`);
      const remark = (input?.value || '').trim();
      if (!remark) {
        alert('Please provide a remark to proceed with the order.');
        input?.focus();
        return;
      }
      document.getElementById('proceedModal').classList.remove('hidden');
    }
    function closeProceedModal() {
      document.getElementById('proceedModal').classList.add('hidden');
      pendingProceed = { timestamp: null, index: null };
    }
    async function approveOrderPending(billToShipTo) {
      try {
        const { timestamp, index } = pendingProceed || {};
        if (timestamp == null || index == null) return;

        const input = document.getElementById(`proceedRemark-${index}`);
        const remark = (input?.value || '').trim();
        if (!remark) {
          alert('Please provide a remark to proceed with the order.');
          input?.focus(); return;
        }

        const btn = document.getElementById(`approve-btn-${index}`);
        btn?.classList.add('btn-loading');

        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'approveOrder',
            timestamp: timestamp,
            proceedRemark: remark,
            billToShipTo: billToShipTo
          })
        });

        setTimeout(() => {
          btn?.classList.remove('btn-loading');
          showSuccessNotification(`Order approved (BillToShipTo: ${billToShipTo})`);
          closeProceedModal();
          fetchOrders();
        }, 1000);
      } catch (e) {
        console.error(e);
        closeProceedModal();
      }
    }

    /* ===== Credit/Stock toggles ===== */
    async function toggleCreditStatus(index, status){
      const a = document.querySelector(`.credit-approved-${index}`);
      const r = document.querySelector(`.credit-rejected-${index}`);
      const target = status==='approved'? a : r;
      target.classList.add('status-loading'); target.disabled = true;

      [a,r].forEach(b => { b.classList.remove('bg-green-500','bg-red-500'); b.classList.add('bg-gray-200'); });

      try{
        await fetch(API_URL,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'updateCreditStatus', timestamp: ordersData[index].timestamp, creditStatus: status==='approved'?'Yes':'No' })
        });
        setTimeout(() => {
          if(status==='approved'){ a.classList.replace('bg-gray-200','bg-green-500'); } else { r.classList.replace('bg-gray-200','bg-red-500'); }
          target.classList.remove('status-loading'); target.disabled = false;
          showSuccessNotification(`Credit status ${status==='approved'?'approved':'rejected'} successfully!`);
        }, 800);
      } catch(e){
        console.error(e);
        target.classList.remove('status-loading'); target.disabled = false;
      }
    }

    function promptStockStatus(timestamp, index, status){
      currentStockTimestamp = timestamp; currentStockStatus = status; currentStockIndex = index;
      document.getElementById('stockModal').classList.remove('hidden');
      document.getElementById('stockRemark').focus();
    }
    function closeStockModal(){
      document.getElementById('stockModal').classList.add('hidden');
      document.getElementById('stockRemark').value = '';
      currentStockTimestamp = currentStockStatus = currentStockIndex = null;
    }
    async function submitStockStatus(){
      const remark = document.getElementById('stockRemark').value.trim();
      if(!remark){ alert('Please provide a remark for the stock status.'); return; }
      const btn = document.getElementById('stockSubmitBtn'); btn.classList.add('btn-loading');

      const a = document.querySelector(`.stock-approved-${currentStockIndex}`);
      const r = document.querySelector(`.stock-rejected-${currentStockIndex}`);

      try{
        await fetch(API_URL,{ method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'updateStockStatus', timestamp: currentStockTimestamp, stockStatus: currentStockStatus==='approved'?'Yes':'No', stockRemark: remark })
        });
        setTimeout(() => {
          [a,r].forEach(b => { b.classList.remove('bg-green-500','bg-red-500'); b.classList.add('bg-gray-200'); });
          if(currentStockStatus==='approved'){ a.classList.replace('bg-gray-200','bg-green-500'); } else { r.classList.replace('bg-gray-200','bg-red-500'); }
          btn.classList.remove('btn-loading');
          showSuccessNotification(`Stock status ${currentStockStatus==='approved'?'approved':'rejected'} successfully!`);
          closeStockModal();
        }, 800);
      } catch(e){
        console.error(e); btn.classList.remove('btn-loading'); closeStockModal();
      }
    }

    /* ===== Helpers ===== */
    function openMultipleDocuments(urlString){
      const urls = (urlString||'').split(',').map(u=>u.trim()).filter(Boolean);
      if(!urls.length){ alert('No valid URLs found'); return; }
      if(urls.length>1 && !confirm(`This will open ${urls.length} documents in separate tabs. Continue?`)) return;
      urls.forEach((u,i)=> setTimeout(()=>window.open(u,'_blank'), i*100));
    }
  </script>

  <!-- Your read-only helper: only has effect in View mode (we call it conditionally) -->
  <script src="js/viewOnly.js"></script>
</body>
</html>
