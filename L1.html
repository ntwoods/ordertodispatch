<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level-1 CRM â€” Credibility & Stock</title>

  <!-- Tailwind -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

  <!-- Premium fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@700;800;900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; 
      background: #f8fafc;
    }

    /* Enhanced gradient background */
    .app-shell {
      background:
        radial-gradient(circle at 20% 10%, rgba(59,130,246,.12), transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(99,102,241,.08), transparent 50%),
        radial-gradient(circle at 40% 90%, rgba(147,197,253,.10), transparent 50%),
        linear-gradient(180deg, #f8fafc 0%, #f1f5f9 50%, #f8fafc 100%);
      min-height: 100vh;
    }

    /* Glass morphism header */
    .glass-bar {
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(226,232,240,.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 
        0 4px 20px rgba(15, 23, 42, .04),
        0 1px 3px rgba(15, 23, 42, .06);
    }

    /* Enhanced card design */
    .card {
      background: #ffffff;
      border: 1px solid rgba(226, 232, 240, .8);
      box-shadow: 
        0 10px 30px -10px rgba(15, 23, 42, .08),
        0 4px 12px -2px rgba(15, 23, 42, .05);
      transition: all .25s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
    }
    
    .card:hover { 
      transform: translateY(-4px) scale(1.01); 
      box-shadow: 
        0 20px 40px -10px rgba(15, 23, 42, .12),
        0 8px 20px -4px rgba(15, 23, 42, .08);
      border-color: rgba(59,130,246,.3);
    }

    /* Attention highlight when overdue - more dramatic */
    .overdue-card {
      border: 2px solid rgba(239, 68, 68, .9) !important;
      box-shadow:
        0 0 0 4px rgba(254, 226, 226, .6),
        0 20px 50px rgba(239, 68, 68, .25),
        0 10px 30px rgba(15, 23, 42, .08) !important;
      animation: pulse-overdue 2s ease-in-out infinite;
    }
    
    @keyframes pulse-overdue {
      0%, 100% { box-shadow: 0 0 0 4px rgba(254, 226, 226, .6), 0 20px 50px rgba(239, 68, 68, .25), 0 10px 30px rgba(15, 23, 42, .08); }
      50% { box-shadow: 0 0 0 6px rgba(254, 226, 226, .4), 0 25px 60px rgba(239, 68, 68, .3), 0 12px 35px rgba(15, 23, 42, .1); }
    }

    .overdue-card:hover {
      transform: translateY(-4px) scale(1.01);
    }

    /* Enhanced top line with gradient shimmer */
    .card-topline {
      height: 5px;
      background: linear-gradient(90deg, rgba(59,130,246,.95), rgba(99,102,241,.95), rgba(147,197,253,.9));
      background-size: 200% 100%;
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .card-topline.red { 
      background: linear-gradient(90deg, rgba(239,68,68,.95), rgba(220,38,38,.95), rgba(248,113,113,.9)); 
      background-size: 200% 100%;
    }
    .card-topline.yellow { 
      background: linear-gradient(90deg, rgba(245,158,11,.95), rgba(217,119,6,.95), rgba(251,191,36,.9)); 
      background-size: 200% 100%;
    }
    .card-topline.green { 
      background: linear-gradient(90deg, rgba(16,185,129,.95), rgba(5,150,105,.95), rgba(52,211,153,.9)); 
      background-size: 200% 100%;
    }

    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

    .btn-loading { position:relative; color:transparent!important; pointer-events:none; }
    .btn-loading::after { content:""; position:absolute; width:16px;height:16px; top:50%;left:50%; margin:-8px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite; }
    .status-loading { position:relative; pointer-events:none; }
    .status-loading::after { content:""; position:absolute; width:12px;height:12px; top:50%;left:50%; margin:-6px; border:1px solid #64748b; border-top-color:transparent; border-radius:50%; animation: spin 1s linear infinite; }

    .modal-overlay { background: rgba(15, 23, 42, .65); backdrop-filter: blur(4px); }
    .success-notification { 
      position:fixed; top:24px; right:24px; 
      background: linear-gradient(135deg, #10b981, #059669);
      color:#fff; padding:14px 20px; border-radius:12px;
      box-shadow: 0 10px 30px rgba(16, 185, 129, .3), 0 4px 12px rgba(15, 23, 42, .15);
      transform:translateX(120%); 
      transition: transform .3s cubic-bezier(0.4, 0, 0.2, 1); 
      z-index:1000;
    }
    .success-notification.show { transform:translateX(0); }
    .success-notification.hide { transform:translateX(120%); }

    /* ENHANCED DEALER PILL - Main Focus */
    .dealer-pill { 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      padding:.4rem .9rem; 
      border-radius:999px; 
      font-size:.82rem; 
      font-weight:800; 
      color:#1e293b; 
      border:1.5px solid rgba(148,163,184,.6); 
      background: linear-gradient(135deg, rgba(241,245,249,.95), rgba(248,250,252,.95));
      box-shadow: 0 2px 8px rgba(15, 23, 42, .08);
      transition: all .2s ease;
    }
    .dealer-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, .12);
    }
    
    .dealer-pill.red { 
      color:#991b1b; 
      border-color: rgba(239,68,68,.5); 
      background: linear-gradient(135deg, rgba(254,226,226,.95), rgba(254,242,242,.95));
      box-shadow: 0 2px 10px rgba(239, 68, 68, .15);
    }
    .dealer-pill.yellow { 
      color:#92400e; 
      border-color: rgba(245,158,11,.5); 
      background: linear-gradient(135deg, rgba(254,243,199,.95), rgba(254,249,195,.95));
      box-shadow: 0 2px 10px rgba(245, 158, 11, .15);
    }
    .dealer-pill.green { 
      color:#064e3b; 
      border-color: rgba(16,185,129,.5); 
      background: linear-gradient(135deg, rgba(209,250,229,.95), rgba(236,253,245,.95));
      box-shadow: 0 2px 10px rgba(16, 185, 129, .15);
    }

    /* Mode pills */
    .mode-pill{
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      padding:8px 14px; 
      border-radius:999px; 
      font-size:13px; 
      font-weight:700;
      box-shadow: 0 2px 8px rgba(15, 23, 42, .06);
    }
    .mode-view{background:#e0f2fe;color:#075985;border:1px solid #7dd3fc}
    .mode-crm{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
    .mode-ea{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}

    /* Enhanced key-value pairs */
    .kv { 
      display:flex; 
      align-items:flex-start; 
      justify-content:space-between; 
      gap:16px; 
      font-size:13.5px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(226,232,240,.6);
      transition: background .2s ease;
    }
    .kv:hover {
      background: rgba(241,245,249,.4);
    }
    .kv:last-child {
      border-bottom: none;
    }
    .kv .k { 
      color:#64748b; 
      font-weight:600;
      min-width: 90px;
    }
    .kv .v { 
      color:#0f172a; 
      font-weight:600; 
      text-align:right; 
      word-break: break-word;
      flex: 1;
    }
    
    .mono { 
      font-variant-numeric: tabular-nums; 
      font-feature-settings: "tnum" 1; 
    }

    /* SUPER ENHANCED DEALER HERO SECTION */
    .dealer-hero{
      background: linear-gradient(135deg, 
        rgba(59,130,246,.12) 0%, 
        rgba(147,197,253,.08) 50%, 
        rgba(255,255,255,.95) 100%);
      border: 2px solid rgba(59,130,246,.25);
      box-shadow: 
        inset 0 2px 0 rgba(255,255,255,.9),
        0 4px 12px rgba(59, 130, 246, .08);
      border-radius: 16px;
      padding: 16px 18px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .dealer-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(59,130,246,.08) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .dealer-hero .label{ 
      color:#64748b; 
      font-weight:700; 
      font-size:11px; 
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      position: relative;
      z-index: 1;
    }
    
    .dealer-hero .name{
      color:#0f172a;
      font-family: 'Poppins', 'Inter', sans-serif;
      font-weight:900;
      letter-spacing:-0.02em;
      font-size:22px;
      line-height:1.2;
      text-shadow: 0 2px 4px rgba(15, 23, 42, .05);
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dealer-hero .name::before {
      content: 'ðŸ‘¤';
      font-size: 20px;
      filter: drop-shadow(0 2px 4px rgba(59, 130, 246, .2));
    }

    /* Enhanced mini-grid boxes */
    .mini-grid .box{
      background: linear-gradient(135deg, rgba(255,255,255,.95), rgba(248,250,252,.9));
      border: 1px solid rgba(226, 232, 240, .7);
      border-radius: 14px;
      padding: 12px 14px;
      transition: all .2s ease;
      box-shadow: 0 2px 6px rgba(15, 23, 42, .04);
    }
    .mini-grid .box:hover {
      border-color: rgba(59,130,246,.3);
      box-shadow: 0 4px 12px rgba(15, 23, 42, .08);
      transform: translateY(-2px);
    }
    .mini-grid .k{ 
      color:#64748b; 
      font-weight:700; 
      font-size:12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .mini-grid .v{ 
      color:#0f172a; 
      font-weight:600; 
      font-size:14px; 
      margin-top:4px; 
      word-break:break-word;
    }

    /* Compact inline rows */
    .kv-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      padding: 9px 0;
      border-bottom: 1px dashed rgba(226,232,240,.7);
      transition: all .2s ease;
    }
    .kv-row:hover {
      background: rgba(241,245,249,.3);
      padding-left: 8px;
      padding-right: 8px;
      margin-left: -8px;
      margin-right: -8px;
      border-radius: 8px;
    }
    .kv-row:last-child{ border-bottom: 0; }
    .kv-row .k{
      color:#64748b;
      font-weight:700;
      font-size:12.5px;
      white-space:nowrap;
    }
    .kv-row .v{
      color:#0f172a;
      font-weight:600;
      font-size:13.5px;
      text-align:right;
      word-break: break-word;
    }
    .kv-pair{
      display:flex;
      align-items:baseline;
      gap:8px;
      min-width:0;
    }
    .kv-pair .v{ min-width:0; }

    /* Enhanced button styles */
    button {
      transition: all .2s ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }

    /* Smooth fade-in animation for cards */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card {
      animation: fadeInUp 0.4s ease-out;
    }

    /* Enhanced input fields */
    input[type="text"], textarea {
      transition: all .2s ease;
    }
    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: rgba(59,130,246,.5);
      box-shadow: 0 0 0 3px rgba(59,130,246,.1);
    }

  </style>
</head>

<body class="app-shell">

  <header class="max-w-6xl mx-auto px-4 pt-6">
    <div class="glass-bar rounded-2xl px-5 py-5 md:px-7 md:py-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight">
          Level-1 CRM Checks
        </h1>
        <p class="text-sm text-gray-600 mt-1">Credit + Stock validation with deadline tracking (L1)</p>
      </div>
      <div class="flex items-center gap-2">
        <div id="modePill" class="mode-pill mode-ea" style="display:none;">EA Mode</div>
      </div>
    </div>
  </header>

  <!-- Success toast -->
  <div id="successNotification" class="success-notification">
    <div class="flex items-center space-x-2">
      <span class="font-semibold">âœ…</span>
      <span id="successMessage">Done</span>
    </div>
  </div>

  <main class="max-w-6xl mx-auto px-4 pb-12 mt-6">
    <div id="loadingContainer" class="flex justify-center items-center py-16">
      <div class="loading-spinner w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
    </div>

    <div id="ordersContainer" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 hidden"></div>

    <div id="noDataContainer" class="text-center py-20 hidden">
      <div class="text-gray-400 text-6xl mb-4">ðŸ“‹</div>
      <h3 class="text-xl font-semibold text-gray-800 mb-1">No Orders Found</h3>
      <p class="text-gray-600">Abhi koi sales orders available nahi hai.</p>
    </div>
  </main>

  <!-- Stock Remark Modal -->
  <div id="stockModal" class="fixed inset-0 modal-overlay z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 border border-blue-100">
        <h3 class="text-lg font-extrabold text-gray-900 mb-2">Stock Status Remark</h3>
        <p class="text-gray-600 mb-3">Stock status ke liye remark mandatory hai:</p>
        <input id="stockRemark" type="text" maxlength="50"
               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
               placeholder="Enter stock remark...">
        <div class="text-xs text-gray-500 mt-1">Max 50 characters</div>
        <div class="flex justify-end space-x-3 mt-5">
          <button onclick="closeStockModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button id="stockSubmitBtn" onclick="submitStockStatus()"
                  class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold">
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Proceed Modal (Bill To Ship To?) -->
  <div id="proceedModal" class="fixed inset-0 modal-overlay z-50 hidden">
    <div class="flex items-center justify-center min-h-screen px-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 border border-blue-100">
        <h3 class="text-lg font-extrabold text-gray-900 mb-2">Approve Pending Order</h3>
        <p class="text-gray-600 mb-4">Bill To Ship To flag set karo:</p>
        <div class="flex gap-3">
          <button onclick="approveOrderPending('NO')"
                  class="flex-1 px-5 py-3 bg-red-50 text-red-700 rounded-xl border-2 border-red-200 hover:bg-red-100 font-semibold">
            NO
          </button>
          <button onclick="approveOrderPending('YES')"
                  class="flex-1 px-5 py-3 bg-green-50 text-green-700 rounded-xl border-2 border-green-200 hover:bg-green-100 font-semibold">
            YES
          </button>
        </div>
        <div class="mt-4 text-center">
          <button onclick="closeProceedModal()" class="text-gray-500 hover:text-gray-700 text-sm">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyPrWZUhQSxWMNUeNU8q_QC5G-gRn_lZLdl0mN71uniF5fsJBLa9yfU2Tp454QLhMQ3wA/exec';
    let ordersData = [];
    let countdownIntervals = [];
    let currentStockOrderId = null;
    let currentStockStatus = null;
    let currentStockIndex = null;
    let pendingProceed = { orderId: null, index: null };

    window.addEventListener('DOMContentLoaded', () => {
      fetchOrders();
    });

    async function fetchOrders(){
      try {
        const resp = await fetch(`${API_URL}?cacheBuster=${Date.now()}`, { method:'GET' });
        const json = await resp.json();

        ordersData = json?.orders || [];

        document.getElementById('loadingContainer').classList.add('hidden');

        if(!ordersData.length){
          document.getElementById('noDataContainer').classList.remove('hidden');
          return;
        }

        const isEA = json?.currentUserRole === 'EA';
        if(isEA){
          const pill = document.getElementById('modePill');
          pill.classList.remove('mode-view','mode-crm');
          pill.classList.add('mode-ea');
          pill.textContent = 'EA Mode';
          pill.style.display = 'inline-flex';
        }

        renderOrders(isEA);
        document.getElementById('ordersContainer').classList.remove('hidden');

      } catch(e){
        console.error(e);
        document.getElementById('loadingContainer').classList.add('hidden');
        document.getElementById('noDataContainer').classList.remove('hidden');
      }
    }

    function renderOrders(isEA){
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';

      ordersData.forEach((ord, i) => {
        const cardDiv = document.createElement('div');
        cardDiv.id = `card-${i}`;
        cardDiv.className = 'card';

        const cStat = (ord.creditStatus||'').toLowerCase();
        const sStat = (ord.stockStatus||'').toLowerCase();

        const statusParts = [];
        if(cStat==='yes') statusParts.push('green');
        else if(cStat==='no') statusParts.push('red');
        if(sStat==='yes') statusParts.push('green');
        else if(sStat==='no') statusParts.push('red');

        let toplineClass = 'card-topline';
        if(statusParts.every(s=>s==='green')) toplineClass += ' green';
        else if(statusParts.includes('red')) toplineClass += ' red';
        else if(cStat==='yes'||sStat==='yes') toplineClass += ' yellow';

        const now = new Date();
        const dead = toDateSafe_(ord.deadline);
        const isOverdue = dead && dead < now;

        if(isOverdue) cardDiv.classList.add('overdue-card');

        const statusClass = (s) => {
          if(!s) return 'dealer-pill';
          const l = s.toLowerCase();
          if(l==='yes') return 'dealer-pill green';
          if(l==='no') return 'dealer-pill red';
          return 'dealer-pill';
        };

        const remarkVal = (r) => {
          if(!r) return '<em style="color:#94a3b8;">â€”</em>';
          return escapeHtml_(r);
        };

        const docBtnDisabled = !ord.documentLink;

        cardDiv.innerHTML = `
          <div class="${toplineClass}"></div>
          <div class="p-5">
            <!-- Dealer hero -->
            <div class="dealer-hero">
              <div class="label">Dealer Name</div>
              <div class="name">${escapeHtml_(ord.dealerName || 'â€”')}</div>
            </div>

            <!-- Order ID + Date -->
            <div class="mb-4">
              <div class="kv">
                <span class="k">Order ID</span>
                <span class="v mono">${escapeHtml_(ord.orderId)}</span>
              </div>
              <div class="kv">
                <span class="k">Order Date</span>
                <span class="v">${escapeHtml_(ord.orderDate||'â€”')}</span>
              </div>
              ${dead ? `
              <div class="kv">
                <span class="k">Countdown</span>
                <span class="v" id="countdown-${i}">â€”</span>
              </div>
              ` : ''}
            </div>

            <!-- Mini Grid: User + Doc -->
            <div class="mini-grid grid grid-cols-2 gap-3 mb-4">
              <div class="box">
                <div class="k">User</div>
                <div class="v">${escapeHtml_(ord.userName||'â€”')}</div>
              </div>
              <div class="box">
                <button
                  onclick="openMultipleDocuments('${escapeAttr_(ord.documentLink||'')}')"
                  ${docBtnDisabled?'disabled':''}
                  class="w-full px-3 py-2 rounded-lg font-semibold text-sm transition-all ${docBtnDisabled?'bg-gray-100 text-gray-400 cursor-not-allowed':'bg-blue-50 text-blue-700 hover:bg-blue-100'}"
                >
                  ðŸ“„ ${docBtnDisabled?'No Doc':'View Doc'}
                </button>
              </div>
            </div>

            <!-- Credit + Stock status pills -->
            <div class="mb-4 space-y-2">
              <div class="kv-pair">
                <span class="k text-xs font-bold text-gray-500 uppercase">Credit:</span>
                <span class="${statusClass(ord.creditStatus)}">
                  ${ord.creditStatus?escapeHtml_(ord.creditStatus):'Pending'}
                </span>
              </div>
              <div class="kv-pair">
                <span class="k text-xs font-bold text-gray-500 uppercase">Stock:</span>
                <span class="${statusClass(ord.stockStatus)}">
                  ${ord.stockStatus?escapeHtml_(ord.stockStatus):'Pending'}
                </span>
              </div>
            </div>

            <!-- Remarks -->
            <div class="mb-4 space-y-2">
              <div class="kv-row">
                <span class="k">Stock Remark</span>
                <span class="v">${remarkVal(ord.stockRemark)}</span>
              </div>
            </div>

            ${isEA ? `
            <!-- EA Controls -->
            <div class="pt-4 border-t border-gray-200 space-y-3">
              <!-- Credit toggles -->
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs font-bold text-gray-600 uppercase">Credit</span>
                <div class="flex gap-2">
                  <button
                    class="credit-approved-${i} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold transition-all ${cStat==='yes'?'bg-green-500':'bg-gray-200 hover:bg-green-400'}"
                    onclick="toggleCreditStatus(${i},'approved')"
                  >âœ“</button>
                  <button
                    class="credit-rejected-${i} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold transition-all ${cStat==='no'?'bg-red-500':'bg-gray-200 hover:bg-red-400'}"
                    onclick="toggleCreditStatus(${i},'rejected')"
                  >âœ•</button>
                </div>
              </div>

              <!-- Stock toggles -->
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs font-bold text-gray-600 uppercase">Stock</span>
                <div class="flex gap-2">
                  <button
                    class="stock-approved-${i} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold transition-all ${sStat==='yes'?'bg-green-500':'bg-gray-200 hover:bg-green-400'}"
                    onclick="promptStockStatus('${escapeAttr_(ord.orderId)}',${i},'approved')"
                  >âœ“</button>
                  <button
                    class="stock-rejected-${i} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold transition-all ${sStat==='no'?'bg-red-500':'bg-gray-200 hover:bg-red-400'}"
                    onclick="promptStockStatus('${escapeAttr_(ord.orderId)}',${i},'rejected')"
                  >âœ•</button>
                </div>
              </div>

              <!-- Proceed remark + button -->
              <div class="pt-2">
                <input
                  id="proceedRemark-${i}"
                  type="text"
                  maxlength="100"
                  placeholder="Proceed remark..."
                  class="w-full p-2.5 mb-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                <button
                  id="approve-btn-${i}"
                  onclick="openProceedDialog('${escapeAttr_(ord.orderId)}',${i})"
                  class="w-full px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 font-semibold transition-all shadow-md hover:shadow-lg"
                >
                  Approve & Proceed
                </button>
              </div>
            </div>
            ` : ''}
          </div>
        `;

        container.appendChild(cardDiv);

        if(dead) startCountdown(`countdown-${i}`, dead);
      });
    }

    function showSuccessNotification(msg){
      const notif = document.getElementById('successNotification');
      document.getElementById('successMessage').textContent = msg;
      notif.classList.remove('hide');
      notif.classList.add('show');
      setTimeout(() => {
        notif.classList.remove('show');
        notif.classList.add('hide');
      }, 2800);
    }

    function startCountdown(elId, deadline){
      const el = document.getElementById(elId);
      if(!el) return;

      const it = setInterval(() => {
        const now = new Date();
        const diff = deadline - now;

        if(diff<=0){
          clearInterval(it);
          el.innerHTML = '<span style="color:#dc2626;font-weight:900;">OVERDUE</span>';
          const card = document.getElementById(`card-${elId.split('-')[1]}`);
          if(card) card.classList.add('overdue-card');
          return;
        }

        const hh = Math.floor(diff/36e5);
        const mm = Math.floor((diff%36e5)/6e4);
        const ss = Math.floor((diff%6e4)/1000);

        const card = document.getElementById(`card-${elId.split('-')[1]}`);
        if (card) card.classList.remove('overdue-card');

        const urgent = diff <= 30*60*1000;
        el.className = urgent
          ? 'mono text-sm font-extrabold px-2 py-1 rounded-lg bg-red-50 text-red-700 border border-red-100'
          : 'mono text-sm font-extrabold px-2 py-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-100';

        el.innerHTML = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
      }, 1000);

      countdownIntervals.push(it);
    }

    /* ===== Proceed (Bill To Ship To?) ===== */
    function openProceedDialog(orderId, index) {
      pendingProceed.orderId = orderId;
      pendingProceed.index = index;

      const input = document.getElementById(`proceedRemark-${index}`);
      const remark = (input?.value || '').trim();
      if (!remark) {
        alert('Proceed ke liye remark mandatory hai.');
        input?.focus();
        return;
      }
      document.getElementById('proceedModal').classList.remove('hidden');
    }

    function closeProceedModal() {
      document.getElementById('proceedModal').classList.add('hidden');
      pendingProceed = { orderId: null, index: null };
    }

    async function approveOrderPending(billToShipTo) {
      try {
        const { orderId, index } = pendingProceed || {};
        if (!orderId && orderId !== 0) return;

        const input = document.getElementById(`proceedRemark-${index}`);
        const remark = (input?.value || '').trim();
        if (!remark) {
          alert('Proceed ke liye remark mandatory hai.');
          input?.focus(); return;
        }

        const btn = document.getElementById(`approve-btn-${index}`);
        btn?.classList.add('btn-loading');

        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'approveOrder',
            orderId,
            proceedRemark: remark,
            billToShipTo
          })
        });

        setTimeout(() => {
          btn?.classList.remove('btn-loading');
          showSuccessNotification(`Approved (BillToShipTo: ${billToShipTo})`);
          closeProceedModal();
          fetchOrders();
        }, 900);

      } catch (e) {
        console.error(e);
        closeProceedModal();
      }
    }

    /* ===== Credit/Stock toggles ===== */
    async function toggleCreditStatus(index, status){
      const a = document.querySelector(`.credit-approved-${index}`);
      const r = document.querySelector(`.credit-rejected-${index}`);
      const target = status==='approved'? a : r;

      target.classList.add('status-loading');
      target.disabled = true;

      [a,r].forEach(b => { b.classList.remove('bg-green-500','bg-red-500'); b.classList.add('bg-gray-200'); });

      const orderId = ordersData[index]?.orderId;

      try{
        await fetch(API_URL,{
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'updateCreditStatus',
            orderId,
            creditStatus: status==='approved'?'Yes':'No'
          })
        });

        setTimeout(() => {
          if(status==='approved'){ a.classList.replace('bg-gray-200','bg-green-500'); }
          else { r.classList.replace('bg-gray-200','bg-red-500'); }

          target.classList.remove('status-loading');
          target.disabled = false;
          showSuccessNotification(`Credit ${status==='approved'?'approved':'rejected'}!`);
        }, 650);

      } catch(e){
        console.error(e);
        target.classList.remove('status-loading');
        target.disabled = false;
      }
    }

    function promptStockStatus(orderId, index, status){
      currentStockOrderId = orderId;
      currentStockStatus = status;
      currentStockIndex = index;

      document.getElementById('stockModal').classList.remove('hidden');
      document.getElementById('stockRemark').focus();
    }

    function closeStockModal(){
      document.getElementById('stockModal').classList.add('hidden');
      document.getElementById('stockRemark').value = '';

      currentStockOrderId = null;
      currentStockStatus = null;
      currentStockIndex = null;
    }

    async function submitStockStatus(){
      const remark = document.getElementById('stockRemark').value.trim();
      if(!remark){ alert('Stock remark mandatory hai.'); return; }

      const btn = document.getElementById('stockSubmitBtn');
      btn.classList.add('btn-loading');

      const a = document.querySelector(`.stock-approved-${currentStockIndex}`);
      const r = document.querySelector(`.stock-rejected-${currentStockIndex}`);

      try{
        await fetch(API_URL,{
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            action:'updateStockStatus',
            orderId: currentStockOrderId,
            stockStatus: currentStockStatus==='approved'?'Yes':'No',
            stockRemark: remark
          })
        });

        setTimeout(() => {
          [a,r].forEach(b => { b.classList.remove('bg-green-500','bg-red-500'); b.classList.add('bg-gray-200'); });
          if(currentStockStatus==='approved'){ a.classList.replace('bg-gray-200','bg-green-500'); }
          else { r.classList.replace('bg-gray-200','bg-red-500'); }

          btn.classList.remove('btn-loading');
          showSuccessNotification(`Stock ${currentStockStatus==='approved'?'approved':'rejected'}!`);
          closeStockModal();
        }, 650);

      } catch(e){
        console.error(e);
        btn.classList.remove('btn-loading');
        closeStockModal();
      }
    }

    /* ===== Helpers ===== */
    function openMultipleDocuments(urlString){
      const urls = (urlString||'').split(',').map(u=>u.trim()).filter(Boolean);
      if(!urls.length){ alert('No valid URLs found'); return; }
      if(urls.length>1 && !confirm(`This will open ${urls.length} documents in separate tabs. Continue?`)) return;
      urls.forEach((u,i)=> setTimeout(()=>window.open(u,'_blank'), i*100));
    }

    function toDateSafe_(v){
      if (!v) return null;
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }

    function escapeHtml_(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr_(s){
      return String(s ?? '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }
  </script>

  <!-- Your read-only helper: only has effect in View mode -->
  <script src="js/viewOnly.js"></script>
</body>
</html>
