<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Orders • NT Woods</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7fbff;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#5b6b88;
    --brand:#1e66f5;
    --brand-900:#134bb1;
    --brand-50:#e9f1ff;
    --ok:#18a957;
    --warn:#f59f00;
    --err:#e03131;
    --ring: 0 0 0 3px rgba(30,102,245,.2);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(180deg,var(--bg),#eef5ff);
    color:var(--ink);
  }
  .shell{max-width:1400px;margin:0 auto;padding:20px 20px 48px;}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;}
  .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px;color:var(--brand-900);}
  .badge{background:var(--brand-50);color:var(--brand-900);font-weight:600;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #d6e6ff;}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;align-items:start;}
  .card{
    background:var(--panel);border:1px solid #e6efff;border-radius:16px;
    box-shadow:0 4px 16px rgba(16,59,138,0.06);padding:14px;
    display:flex;flex-direction:column;gap:10px;transition:transform .12s ease, box-shadow .12s ease;
  }
  .card:hover{ transform:translateY(-2px); box-shadow:0 6px 22px rgba(16,59,138,0.08);}
  .kv{display:grid;grid-template-columns:88px 1fr;row-gap:6px;column-gap:10px;font-size:13px}
  .k{color:var(--muted)}
  .v{font-weight:600}
  .filegrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:2px}
  .btn{
    appearance:none;border:1px solid transparent;background:var(--brand);color:#fff;border-radius:12px;
    padding:10px 12px;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  }
  .btn:focus{outline:none;box-shadow:var(--ring)}
  .btn.secondary{background:#fff;border-color:#d8e7ff;color:var(--brand-900)}
  .btn.ghost{background:#fff;border-color:#e7eefc;color:var(--muted)}
  .btn.ok{background:var(--ok)}
  .btn.warn{background:var(--brand)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
  .tag{
    display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;
    border:1px solid #dbe7ff;background:#f6faff;color:#1d3b78;
  }
  .tag.ok{border-color:#cdebd9;background:#f3fcf6;color:#0f5c33}
  .tag.info{border-color:#d6e6ff;background:#eef5ff;color:#17499a}
  .empty{border:1px dashed #cfe0ff;background:linear-gradient(180deg,#fff,#f7fbff);padding:28px;border-radius:16px;color:var(--muted);text-align:center}
  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.18);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
  .spinner{width:58px;height:58px;border-radius:50%;border:6px solid #d9e6ff;border-top-color:var(--brand);animation:spin .9s linear infinite;background:#fff;box-shadow:0 8px 28px rgba(16,59,138,.18);border-bottom-color:transparent;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:60}
  .toast{background:#fff;border:1px solid #e6efff;border-left:5px solid var(--brand);border-radius:12px;padding:12px 14px;min-width:260px;box-shadow:0 10px 30px rgba(16,59,138,.08);font-size:13px}
  .toast.ok{border-left-color:var(--ok)}
  .toast.err{border-left-color:var(--err)}
  .toast.warn{border-left-color:var(--warn)}
  .sr{position:absolute;left:-9999px}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.32);z-index:70}
  .modal .panel{width:min(92vw,420px);background:#fff;border:1px solid #e6efff;border-radius:16px;box-shadow:0 16px 44px rgba(16,59,138,.18);padding:16px}
  .modal h3{margin:0 0 10px 0;font-size:16px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .input{border:1px solid #dbe7ff;border-radius:12px;padding:10px 12px;font-size:14px}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  /* --- Expected Dispatch / Overdue styles --- */
  .countdown{ font-variant-numeric: tabular-nums; font-weight:700; }
  .tag.overdue{ border-color:#ffd6d6; background:#fff2f2; color:#a61b1b; }
  .card.overdue{
    background:#fff5f5;
    border-color:#ffd6d6;
    box-shadow:0 4px 16px rgba(224,49,49,.08);
  }
  
</style>
</head>
<body>
  <div class="overlay" id="overlay"><div class="spinner" aria-hidden="true"></div><span class="sr">Loading…</span></div>
  <div class="shell">
    <div class="topbar">
      <div class="brand">NT Woods • Orders <span class="badge" id="crmBadge">CRM: …</span></div>
      <div class="toolbar">
        <button class="btn ghost" id="refreshBtn" title="Reload from API">Refresh</button>
        <span class="hint">Tip: pass <code>?crm=Name</code> in URL</span>
      </div>
    </div>
    <div id="cards" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No orders found for this CRM.</div>
  </div>
  <div class="toasts" id="toasts"></div>

  <!-- Tentative Dispatch Modal -->
  <div class="modal" id="tentativeModal" aria-hidden="true">
    <div class="panel">
      <h3>Select Tentative Dispatch Date &amp; Time</h3>
      <div class="field">
        <label for="tentativeDT">Tentative Dispatch</label>
        <input id="tentativeDT" type="datetime-local" class="input" />
      </div>
      <div class="row">
        <button class="btn ghost" id="cancelTentative">Cancel</button>
        <button class="btn ok" id="saveTentative">Submit</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const API_BASE = 'https://script.google.com/macros/s/AKfycbw-Wh4YZ4zWjMa0msQ6aA00kbJrclRKModm1spzOQzfj7MxmMtAGU7o2bx7jK4QSgj6/exec';
  const $ = sel => document.querySelector(sel);
  const overlay = $('#overlay');
  const cardWrap = $('#cards');
  const empty = $('#empty');
  const toasts = $('#toasts');
  const refreshBtn = $('#refreshBtn');
  const crm = new URLSearchParams(location.search).get('crm') || '';
  $('#crmBadge').textContent = 'CRM: ' + (crm || '— (missing)');

  // Modal refs
  const modal = $('#tentativeModal');
  const tentativeInput = $('#tentativeDT');
  const cancelBtn = $('#cancelTentative');
  const saveBtn = $('#saveTentative');
  let modalTimestamp = null;   // which order's timestamp we are acting on
  let modalBtnRef = null;      // button ref to disable during submit

  if(!crm){
    empty.style.display='block';
    empty.innerHTML = 'Please provide <b>?crm=Your Name</b> in the URL.';
    return;
  }

  // Toasts
  function toast(msg, type='ok', timeout=3000){
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    toasts.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; }, timeout-300);
    setTimeout(()=> t.remove(), timeout);
  }

  function showOverlay(v){ overlay.style.display = v ? 'flex' : 'none'; }

  function openModal(ts, btn){
    modalTimestamp = ts;
    modalBtnRef = btn || null;
    // default value: next working day 18:00 IST
    const d = new Date();
    d.setDate(d.getDate() + 1);
    d.setHours(18,0,0,0);
    tentativeInput.value = toLocalInputValue(d);
    modal.style.display = 'flex';
    tentativeInput.focus();
  }
  function closeModal(){
    modal.style.display = 'none';
    modalTimestamp = null;
    modalBtnRef = null;
  }
  function toLocalInputValue(dateObj){
    // returns "YYYY-MM-DDTHH:mm" in local time
    const pad = n => String(n).padStart(2,'0');
    const y = dateObj.getFullYear();
    const m = pad(dateObj.getMonth()+1);
    const d = pad(dateObj.getDate());
    const h = pad(dateObj.getHours());
    const mi = pad(dateObj.getMinutes());
    return `${y}-${m}-${d}T${h}:${mi}`;
  }

  async function load(){
    try{
      showOverlay(true);
      const url = `${API_BASE}?crm=${encodeURIComponent(crm)}`;
      const res = await fetch(url, { method:'GET' });
      if(!res.ok) throw new Error('API error ' + res.status);
      const json = await res.json();
      const data = Array.isArray(json?.data) ? json.data : [];
      render(data);
    }catch(err){
      console.error(err);
      empty.style.display='block';
      empty.innerHTML = 'Failed to load orders. Please try again.';
      toast('Failed to load orders', 'err');
    }finally{
      showOverlay(false);
    }
  }

  function safe(txt){ return (txt ?? '').toString().trim(); }

  function render(data){
    cardWrap.innerHTML='';
    if(!data.length){
      empty.style.display='block';
      return;
    }
    empty.style.display='none';

    const frag = document.createDocumentFragment();
    data.forEach(item=>{
      const card = document.createElement('div');
      card.className = 'card';

      const kv = document.createElement('div');
      kv.className='kv';
      kv.innerHTML = `
        <div class="k">Dealer</div><div class="v">${safe(item.dealerName)}</div>
        <div class="k">Marketing</div><div class="v">${safe(item.marketingPersonName)}</div>
        <div class="k">Location</div><div class="v">${safe(item.location)}</div>
        <div class="k">CRM</div><div class="v">${safe(item.crmName)}</div>
      `;
      card.appendChild(kv);

      const files = document.createElement('div');
      files.className = 'filegrid';
      const rawBtn = document.createElement('button');
      rawBtn.className = 'btn secondary';
      rawBtn.textContent = 'Raw Order';
      rawBtn.onclick = ()=> openFile(safe(item.rawOrderFile));
      const finalBtn = document.createElement('button');
      finalBtn.className = 'btn secondary';
      finalBtn.textContent = 'Final Order';
      finalBtn.onclick = ()=> openFile(safe(item.finalOrderFile));
      files.append(rawBtn, finalBtn);
      card.appendChild(files);

      const tags = document.createElement('div');
      tags.className = 'tags';
      const nextree = safe(item.nextreeInformed);
      const dispatch = safe(item.dispatchConfirmed);

      if(nextree){
        const t = document.createElement('span');
        t.className = 'tag info';
        t.textContent = 'NexTree Informed';
        tags.appendChild(t);
      }
      if(dispatch){
        const t = document.createElement('span');
        t.className = 'tag ok';
        t.textContent = 'Dispatch Confirmed';
        tags.appendChild(t);
      }
      if(tags.children.length){ card.appendChild(tags); }

      const actions = document.createElement('div');
      actions.className='actions';

      if(!nextree){
        const informBtn = document.createElement('button');
        informBtn.className='btn warn';
        informBtn.textContent='Inform NexTree';
        informBtn.onclick = ()=> openModal(item.timestamp, informBtn);
        actions.append(informBtn);
      } else {
        const spacer=document.createElement('div'); spacer.style.visibility='hidden'; actions.append(spacer);
      }

      if(!dispatch){
        const dispatchBtn = document.createElement('button');
        dispatchBtn.className='btn ok';
        dispatchBtn.textContent='Confirm Dispatch';
        dispatchBtn.onclick = ()=> act('confirmDispatch', item.timestamp, dispatchBtn);
        actions.append(dispatchBtn);
      }

      if(actions.children.length){ card.appendChild(actions); }
      frag.appendChild(card);
    });
    cardWrap.appendChild(frag);
  }

  // 👇 add this right after nextree/dispatch tags logic (before appending tags)
  const expectedISO = safe(item.dispatchDateAndTime);
  if (expectedISO) {
    const expectedTag = document.createElement('span');
    expectedTag.className = 'tag info expectedTag';
  
    const d = new Date(expectedISO);
    const human = isNaN(d) ? '—' : d.toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
  
    // We will live-update the <span class="countdown"> below
    expectedTag.innerHTML = `Expected Dispatch: <strong>${human}</strong> • <span class="countdown" data-target="${isNaN(d)?'':d.toISOString()}">calculating…</span>`;
    tags.prepend(expectedTag); // keep it first
  }

  
  function openFile(url){
    if(!url){ toast('No file URL', 'warn'); return; }
    const parts = String(url).split(',').map(s=>s.trim()).filter(Boolean);
    parts.forEach(u => window.open(u, '_blank', 'noopener'));
  }

  let inFlight = false;
  async function act(action, timestamp, btn, tentativeISO=null){
    if(inFlight) return;
    inFlight = true;
    if(btn) btn.disabled = true;
    showOverlay(true);
    try{
      const payload = { action, timestamp };
      if(action === 'informNextree' && tentativeISO){
        // Convert local "YYYY-MM-DDTHH:mm" to ISO string
        const local = new Date(tentativeISO);
        if(!isNaN(local)) payload.tentativeDispatch = local.toISOString();
      }
      await fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        mode: 'no-cors'
      });
      location.reload();
    }catch(err){
      console.error(err);
      toast('Action failed', 'err');
    }finally{
      inFlight = false;
      showOverlay(false);
    }
  }

  // Modal events
  cancelBtn.addEventListener('click', closeModal);
  saveBtn.addEventListener('click', ()=>{
    const val = tentativeInput.value?.trim();
    if(!val){ toast('Please select tentative date & time', 'warn'); return; }
    act('informNextree', modalTimestamp, modalBtnRef, val);
  });

  refreshBtn.addEventListener('click', load);
  load();
})();
</script>
</body>
</html>
