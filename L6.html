<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Goods Receiving from Dealer</title>
    <style>
        /* Base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff;
            min-height: 100vh;
            padding: 20px;
            color: #334155;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        .header {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 30px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
            text-align: center; border: 1px solid #e0e7ff;
        }
        .header h1 { color:#1e3a8a; font-size:2.8rem; margin-bottom: 15px; font-weight:800; }
        .crm-name { color:#3b82f6; font-size:1.1rem; font-weight:700; }
        .mode-badge {
            display:inline-block; margin-top:8px; padding:6px 12px; border-radius:9999px;
            border:1px solid; font-weight:600; font-size:.85rem;
        }

        /* Loading / Empty */
        .loading,.empty-state{ text-align:center; padding:60px; color:#4a5568; font-size:1.2rem; }
        .loading::after{
            content:''; display:inline-block; width:20px;height:20px; border:3px solid rgba(74,85,104,.3);
            border-radius:50%; border-top-color:#3b82f6; animation:spin 1s ease-in-out infinite; margin-left:10px;
        }
        @keyframes spin { to{ transform: rotate(360deg); } }

        /* Grid */
        .orders-grid{
            display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
            gap:25px; margin-top:20px; justify-content:center;
        }

        /* Card */
        .order-card {
            background:#fff; border-radius:12px; padding:25px;
            box-shadow:0 8px 20px rgba(0,0,0,.06); transition:all .3s ease;
            border:1px solid #e2e8f0; display:flex; flex-direction:column;
        }
        .order-card:hover{ transform: translateY(-8px); box-shadow:0 15px 35px rgba(0,0,0,.10); }
        .order-card.overdue{ border-left:5px solid #ef4444; background:#fffafa; }

        .order-header{
            display:flex; justify-content:space-between; align-items:center;
            margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #ebf4ff;
        }
        .order-id{ background:#3b82f6; color:#fff; padding:8px 16px; border-radius:8px; font-weight:600; font-size:.9rem; }
        .order-status{ background:#bfdbfe; color:#1e40af; padding:6px 12px; border-radius:20px; font-size:.8rem; font-weight:600; }
        .order-status.overdue{ background:#fca5a5; color:#b91c1c; animation:pulse 2s infinite; }
        @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:.7} }

        .countdown-container{
            background:#e0f2fe; color:#1e3a8a; padding:15px; border-radius:12px; margin-bottom:20px; text-align:center;
            box-shadow:0 2px 10px rgba(0,0,0,.05); border:1px solid #bfdbfe;
        }
        .countdown-container.overdue{ background:#fee2e2; color:#991b1b; }
        .countdown-container.warning{ background:#fef3c7; color:#92400e; }
        .countdown-label{ font-size:.9rem; font-weight:600; margin-bottom:8px; opacity:.9; }
        .countdown-timer{ font-size:1.6rem; font-weight:bold; font-family:'Courier New', monospace; letter-spacing:1px; }
        .countdown-deadline{ font-size:.8rem; opacity:.8; margin-top:5px; color:#4a5568; }

        .order-details{ margin-bottom:20px; flex-grow:1; }
        .detail-row{ display:flex; margin-bottom:12px; align-items:center; }
        .detail-label{ font-weight:600; color:#475569; min-width:120px; font-size:.9rem; }
        .detail-value{ color:#64748b; font-size:.9rem; flex:1; display:flex; align-items:center; flex-wrap:wrap; }
        .detail-value.dealer-name{ color:#1e3a8a; font-weight:700; }
        .detail-value.location{ color:#059669; font-weight:500; }
        .timestamp{ background:#e0f2fe; padding:8px 12px; border-radius:8px; font-family:'Courier New', monospace; font-size:.8rem; color:#475569; }

        .order-actions{ display:flex; gap:15px; margin-top:20px; padding-top:15px; border-top:1px solid #ebf4ff; }
        .btn{
            padding:12px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:.3s;
            text-decoration:none; display:inline-flex; align-items:center; justify-content:center; font-size:.95rem; flex:1;
        }
        .btn-primary{ background:#3b82f6; color:#fff; box-shadow:0 4px 12px rgba(59,130,246,.3); }
        .btn-primary:hover{ background:#2563eb; transform: translateY(-2px); box-shadow:0 6px 16px rgba(59,130,246,.4); }
        .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none !important; box-shadow:none !important; }
        .btn-icon{ margin-right:8px; font-size:1.1rem; }

        .error-message{
            background:#fef2f2; color:#ef4444; padding:20px; border-radius:12px; text-align:center; margin:20px 0; border:1px solid #fca5a5;
        }
        .success-message{
            background:#ecfdf5; color:#10b981; padding:15px; border-radius:8px; margin:10px 0; text-align:center; opacity:0; transition:.3s; border:1px solid #a7f3d0;
        }
        .success-message.show{ opacity:1; }

        /* Dealer Type Badge (circular) */
        .dealer-type-badge{
            display:inline-flex; align-items:center; justify-content:center; width:50px; height:50px; border-radius:50%;
            font-size:.75rem; font-weight:600; color:#fff; margin-left:10px; flex-shrink:0;
        }
        .bg-red-500{ background:#ef4444; } .bg-yellow-500{ background:#f59e0b; } .bg-green-500{ background:#22c55e; } .bg-gray-500{ background:#6b7280; }

        @media (max-width:1024px){ .orders-grid{ grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); } }
        @media (max-width:768px){
            body{ padding:15px; }
            .header h1{ font-size:2.2rem; }
            .crm-name{ font-size:1rem; }
            .orders-grid{ grid-template-columns:1fr; }
            .order-actions{ flex-direction:column; }
            .countdown-timer{ font-size:1.4rem; }
            .order-card{ padding:20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Confirm Goods Receiving from Dealer</h1>
            <div class="crm-name" id="crmName">Loading...</div>
            <div id="modeBadge" class="mode-badge" style="display:none;"></div>
        </div>

        <div id="loadingDiv" class="loading">Loading your orders...</div>
        <div id="errorDiv" class="error-message" style="display:none;"></div>
        <div id="successDiv" class="success-message"></div>
        <div id="ordersContainer" class="orders-grid" style="display:none;"></div>
        <div id="emptyState" class="empty-state" style="display:none;">
            <h3>üéâ All caught up!</h3>
            <p>No pending orders at the moment.</p>
        </div>
    </div>

    <script>
        // ================== CONFIG ==================
        const API_URL = 'https://script.google.com/macros/s/AKfycbyJ1CdfyAhTOhvxCYrE16rBYAfdVlrYpBLHMJj1UBB_xJvdcrUE3RBwNC9TDNMJpaZlWg/exec';

        let ordersData = [];
        let completedToday = 0;
        let countdownIntervals = {};

        // ================== URL PARAM MODES ==================
        const params = new URLSearchParams(window.location.search);
        const modeParam = (params.get('mode') || '').trim().toLowerCase();
        const crmParam = (params.get('crm') || '').trim();

        // Modes:
        // 1) ?crm=...      -> CRM filtered + editable
        // 2) ?mode=view    -> ALL + view-only
        // 3) no params     -> ALL + editable
        const IS_VIEW_ONLY = modeParam === 'view';
        const FETCH_ALL = IS_VIEW_ONLY || !crmParam;

        const API_WITH_CRM = `${API_URL}?crm=${encodeURIComponent(crmParam)}`;
        const API_FETCH_URL = FETCH_ALL ? API_URL : API_WITH_CRM;

        function setHeaderMode() {
            const crmEl = document.getElementById('crmName');
            const badge = document.getElementById('modeBadge');

            if (IS_VIEW_ONLY) {
                crmEl.textContent = `Showing: ALL CRMs`;
                badge.textContent = 'View-Only Mode';
                badge.style.display = 'inline-block';
                badge.style.borderColor = '#f59e0b';
                badge.style.color = '#92400e';
                badge.style.background = '#fef3c7';
            } else if (!FETCH_ALL) {
                crmEl.textContent = `Welcome, ${decodeURIComponent(crmParam)}`;
                badge.textContent = 'Editable ‚Ä¢ CRM Filter Applied';
                badge.style.display = 'inline-block';
                badge.style.borderColor = '#93c5fd';
                badge.style.color = '#1d4ed8';
                badge.style.background = '#eff6ff';
            } else {
                crmEl.textContent = `Showing: ALL CRMs`;
                badge.textContent = 'Editable';
                badge.style.display = 'inline-block';
                badge.style.borderColor = '#86efac';
                badge.style.color = '#166534';
                badge.style.background = '#ecfdf5';
            }
        }

        // ================== HELPERS ==================
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            });
        }

        let orderCounter = 0;
        function generateOrderId() {
            orderCounter++;
            return `Order-${orderCounter}`;
        }

        // Helper: Add working hours, skipping Sundays
        function addWorkingHoursSkippingSundays(startDate, hoursToAdd) {
            const result = new Date(startDate);
            let remaining = hoursToAdd;
        
            while (remaining > 0) {
                // ek-ek ghanta badhao
                result.setHours(result.getHours() + 1);
        
                const day = result.getDay(); // 0 = Sunday, 1 = Monday, ... 6 = Saturday
        
                // Agar Sunday nahi hai to is ghante ko working hour count karo
                if (day !== 0) {
                    remaining--;
                }
            }
        
            return result;
        }
        
        function calculateDeadline(expectedDeliveryDate) {
            const deliveryDate = new Date(expectedDeliveryDate);
        
            // Yahan 36 working hours add kar rahe hain, Sunday ko skip karke
            const deadline = addWorkingHoursSkippingSundays(deliveryDate, 36);
        
            return deadline;
        }


        function formatCountdown(timeDiff) {
            if (timeDiff <= 0) return "OVERDUE";
            const days = Math.floor(timeDiff / 86400000);
            const hours = Math.floor((timeDiff % 86400000) / 3600000);
            const minutes = Math.floor((timeDiff % 3600000) / 60000);
            const seconds = Math.floor((timeDiff % 60000) / 1000);
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
            return `${minutes}m ${seconds}s`;
        }

        function updateCountdown(orderId, deadline, countdownElement, statusElement, cardElement) {
            const now = Date.now();
            const timeDiff = deadline.getTime() - now;
            countdownElement.querySelector('.countdown-timer').textContent = formatCountdown(timeDiff);

            if (timeDiff <= 0) {
                countdownElement.classList.add('overdue');
                statusElement.textContent = 'Overdue';
                statusElement.classList.add('overdue');
                cardElement.classList.add('overdue');
                if (countdownIntervals[orderId]) {
                    clearInterval(countdownIntervals[orderId]);
                    delete countdownIntervals[orderId];
                }
            } else if (timeDiff <= 2 * 60 * 60 * 1000) {
                countdownElement.classList.add('warning');
            }
        }

        function startCountdown(orderId, expectedDeliveryDate, countdownElement, statusElement, cardElement) {
            const deadline = calculateDeadline(expectedDeliveryDate);
            updateCountdown(orderId, deadline, countdownElement, statusElement, cardElement);
            countdownIntervals[orderId] = setInterval(() => {
                updateCountdown(orderId, deadline, countdownElement, statusElement, cardElement);
            }, 1000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successDiv');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            setTimeout(() => successDiv.classList.remove('show'), 3000);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loadingDiv').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('ordersContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function applyViewOnly() {
            // Disable all elements inside .editable
            document.querySelectorAll('.editable input, .editable button, .editable textarea, .editable select')
              .forEach(el => { el.disabled = true; el.classList.add('cursor-not-allowed'); });
            document.querySelectorAll('.editable').forEach(el => el.style.opacity = 0.6);
        }

        // ================== ACTIONS ==================
        async function markAsReceived(timestampForMap, orderElement) {
            if (IS_VIEW_ONLY) return; // safety

            const button = orderElement.querySelector('.btn-primary');
            const originalText = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<span class="btn-icon">‚è≥</span>Processing...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `timestampForMap=${encodeURIComponent(timestampForMap)}`
                });

                // Try to parse JSON; if fails, assume success (GAS no-cors fallback)
                let ok = false;
                try {
                    const result = await response.json();
                    ok = result && result.status === 'success';
                } catch (e) {
                    ok = true;
                }

                if (ok) {
                    // clear countdown
                    const orderId = orderElement.querySelector('.order-id').textContent;
                    if (countdownIntervals[orderId]) {
                        clearInterval(countdownIntervals[orderId]);
                        delete countdownIntervals[orderId];
                    }

                    orderElement.style.transition = 'all .5s ease';
                    orderElement.style.opacity = '0.5';
                    orderElement.style.transform = 'scale(0.95)';

                    setTimeout(() => {
                        orderElement.remove();
                        completedToday++;
                        if (document.querySelectorAll('.order-card').length === 0) showEmptyState();
                    }, 500);

                    showSuccess('‚úÖ Order marked as received successfully!');
                } else {
                    throw new Error('Failed to update order');
                }
            } catch (error) {
                console.error('Error:', error);
                button.disabled = false;
                button.innerHTML = originalText;
                showError('Failed to mark order as received. Please try again.');
            }
        }

        function openMultipleDocuments(urlString) {
            const urls = String(urlString || '').split(',').map(u => u.trim()).filter(Boolean);
            if (!urls.length) { alert('No valid URLs found'); return; }
            if (urls.length > 1) {
                const confirmed = confirm(`This will open ${urls.length} documents in separate tabs. Continue?`);
                if (!confirmed) return;
            }
            urls.forEach((u,i)=> setTimeout(()=> window.open(u,'_blank'), i*100));
        }

        function createOrderCard(order, index) {
            const orderId = generateOrderId();
            const deadline = calculateDeadline(order.expectedDeliveryDate);
            const el = document.createElement('div');
            el.className = 'order-card';
            el.style.animationDelay = `${index * 0.1}s`;

            // Dealer Type Badge
            let dealerTypeBadge = '';
            if (order.dealerType) {
                let c = 'bg-gray-500';
                switch (String(order.dealerType).toLowerCase()) {
                    case 'red': c='bg-red-500'; break;
                    case 'yellow': c='bg-yellow-500'; break;
                    case 'green': c='bg-green-500'; break;
                }
                dealerTypeBadge = `<div class="dealer-type-badge ${c}">${order.dealerType}</div>`;
            }

            el.innerHTML = `
                <div class="order-header">
                    <div class="order-id">${orderId}</div>
                    <div class="order-status">Pending</div>
                </div>

                <div class="countdown-container">
                    <div class="countdown-label">‚è∞ Time to Deadline</div>
                    <div class="countdown-timer">Calculating...</div>
                    <div class="countdown-deadline">
                        Deadline: ${deadline.toLocaleString('en-US', {
                            weekday: 'short', month: 'short', day: 'numeric',
                            hour: '2-digit', minute: '2-digit', hour12: true
                        })}
                    </div>
                </div>

                <div class="order-details">
                    <div class="detail-row">
                        <div class="detail-label">üë§ Dealer:</div>
                        <div class="detail-value dealer-name">${order.dealerName} ${dealerTypeBadge}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">üè¢ Marketing:</div>
                        <div class="detail-value">${order.marketingPersonName}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">üìç Location:</div>
                        <div class="detail-value location">${order.location}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">üì¶ Expected:</div>
                        <div class="detail-value"><div class="timestamp">${formatTimestamp(order.expectedDeliveryDate)}</div></div>
                    </div>

                    <span class="text-m text-black-600">Final Order:</span>
                    <button onclick="openMultipleDocuments('${(order.finalOrder||'').replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">Final Order File</button>

                    <span class="text-m text-black-600">Dispatch Details:</span>
                    <button onclick="openMultipleDocuments('${(order.dispatchDetails||'').replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">Dispatch Details</button>

                    <span class="text-m text-black-600">Invoice:</span>
                    <button onclick="openMultipleDocuments('${(order.invoiceURL||'').replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">View Invoice</button>

                    ${order.rawOrder ? `
                      <span class="text-m text-red-600">Raw Order:</span>
                      <button onclick="openMultipleDocuments('${(order.rawOrder||'').replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
                        Click for Raw
                      </button>` : ''}

                    ${order.additionalOrder ? `
                      <span class="text-m text-red-600">Additional Order:</span>
                      <button onclick="openMultipleDocuments('${(order.additionalOrder||'').replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
                        Additional Order File
                      </button>` : ''}
                </div>

                <div class="editable">
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="markAsReceived('${order.timestampForMap}', this.closest('.order-card'))">
                            <span class="btn-icon">‚úÖ</span>Mark as Received
                        </button>
                    </div>
                </div>
            `;

            // Start countdown after append
            setTimeout(() => {
                const countdownElement = el.querySelector('.countdown-container');
                const statusElement = el.querySelector('.order-status');
                startCountdown(orderId, order.expectedDeliveryDate, countdownElement, statusElement, el);
            }, 100);

            return el;
        }

        // ================== FETCH (smart JSON/text) ==================
        async function parseSmart(resp){
            const ct = (resp.headers.get('content-type') || '').toLowerCase();
            if (ct.includes('application/json')) return {kind:'json', body: await resp.json()};
            return {kind:'text', body: await resp.text()};
        }

        async function fetchOrders() {
            setHeaderMode();

            try {
                let resp = await fetch(API_FETCH_URL, { cache: 'no-store' });
                let parsed = await parseSmart(resp);

                // If backend sent plain text "CRM name missing", retry ALL
                if (parsed.kind === 'text' && /crm name missing/i.test(parsed.body) && API_FETCH_URL !== API_URL) {
                    resp = await fetch(API_URL, { cache: 'no-store' });
                    parsed = await parseSmart(resp);
                }

                document.getElementById('loadingDiv').style.display = 'none';

                if (parsed.kind === 'json' && parsed.body && parsed.body.status === 'success') {
                    ordersData = parsed.body.data || [];

                    if (ordersData.length === 0) {
                        showEmptyState();
                    } else {
                        const container = document.getElementById('ordersContainer');
                        container.style.display = 'grid';
                        container.innerHTML = '';

                        ordersData.forEach((order, index) => {
                            const card = createOrderCard(order, index);
                            container.appendChild(card);
                        });

                        // Apply view only if needed
                        if (IS_VIEW_ONLY) applyViewOnly();

                        // If you also load an external viewOnly.js that toggles read-only,
                        // it will be safe; our applyViewOnly already ensures disabling.
                        if (IS_VIEW_ONLY && typeof setReadOnlyMode === "function") {
                            setReadOnlyMode();
                        }
                    }
                } else {
                    showError('‚ùå Failed to fetch orders. Please try again later.');
                }
            } catch (err) {
                console.error('Error fetching orders:', err);
                showError('‚ùå Network error. Please check your connection and try again.');
            }
        }

        // ================== INIT ==================
        document.addEventListener('DOMContentLoaded', fetchOrders);

        // Cleanup
        window.addEventListener('beforeunload', () => {
            Object.values(countdownIntervals).forEach(clearInterval);
        });
    </script>
    <!-- Optional external script (safe to keep) -->
    <script src="https://ntwoods.github.io/ordertodispatch/js/viewOnly.js"></script>
</body>
</html>
