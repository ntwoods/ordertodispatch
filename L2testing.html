<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <title>Sales Orders Dashboard</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Arial, sans-serif;background-color:#e0f2f7;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .gola-section{margin-top:15px;margin-bottom:15px}
        h2{text-align:center;color:#01579b;margin-bottom:20px}
        .mode-chip{display:inline-block;margin:0 auto 20px auto;background:#e3f2fd;color:#1565c0;font-weight:600;border:1px solid #90caf9;padding:6px 12px;border-radius:999px}
        .loading{text-align:center;font-size:18px;color:#0277bd}
        .error{background:#bbdefb;color:#c62828;padding:15px;border-radius:5px;text-align:center;margin-bottom:20px}
        .orders-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(350px, 1fr));gap:20px}
        .order-card{background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px;transition:transform .2s}
        .order-card:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.15)}
        .order-header{border-bottom:2px solid #90caf9;padding-bottom:10px;margin-bottom:15px}
        .dealer-name{font-size:20px;font-weight:bold;color:#1976d2;margin-bottom:5px}
        .timestamp{color:#424242;font-size:14px}
        .order-details{margin-bottom:15px}
        .detail-row{display:flex;justify-content:space-between;margin-bottom:8px;padding:5px 0}
        .detail-label{font-weight:bold;color:#212121;flex:1}
        .detail-value{color:#424242;flex:2;text-align:right}
        .file-link{color:#1976d2;text-decoration:none}
        .file-link:hover{text-decoration:underline}
        .countdown-section{background:#e3f2fd;border-radius:5px;padding:15px;text-align:center}
        .countdown-label{font-size:14px;color:#424242;margin-bottom:5px}
        .countdown-timer{font-size:24px;font-weight:bold;font-family:monospace}
        .countdown-urgent{color:#d32f2f;animation:pulse 1s infinite}
        .countdown-warning{color:#f57c00}
        .countdown-normal{color:#2e7d32}
        .countdown-expired{color:#d32f2f;background:#ffebee}
        @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
        .refresh-btn{background:#1976d2;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:16px;margin-bottom:20px}
        .refresh-btn:hover{background:#1565c0}
        .action-section{border-top:2px solid #90caf9;padding-top:15px;margin-top:15px}
        .file-upload-section{margin-bottom:15px}
        .file-upload-label{display:block;font-weight:bold;color:#212121;margin-bottom:8px}
        .file-input{width:100%;padding:8px;border:2px dashed #90caf9;border-radius:5px;background:#e3f2fd;cursor:pointer;transition:border-color .3s}
        .file-input:hover{border-color:#1976d2}
        .file-selected{color:#2e7d32;font-size:14px;margin-top:5px;display:none}
        .radio-section{margin-bottom:15px}
        .radio-label{font-weight:bold;color:#212121;margin-bottom:8px;display:block}
        .radio-group{display:flex;gap:15px}
        .radio-option{display:flex;align-items:center;gap:5px}
        .button-group{display:flex;gap:10px;margin-top:15px}
        .submit-btn,.hold-btn,.cancel-btn{color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px;flex-grow:1;transition:background-color .3s}
        .submit-btn{background:#1976d2}
        .submit-btn:hover{background:#1565c0}
        .submit-btn:disabled{background:#90caf9;cursor:not-allowed}
        .hold-btn{background:#2196f3}
        .hold-btn:hover{background:#1e88e5}
        .hold-btn:disabled{background:#90caf9;cursor:not-allowed}
        .cancel-btn{background:#ef5350}
        .hold-until-section{margin-top:15px;margin-bottom:15px;display:none}
        .hold-until-label{display:block;font-weight:bold;color:#212121;margin-bottom:8px}
        .hold-until-input{width:100%;padding:8px;border:1px solid #90caf9;border-radius:5px}
        .success-message{background:#e3f2fd;color:#1976d2;padding:10px;border-radius:5px;margin-top:10px;display:none}
        .error-message{background:#ffebee;color:#c62828;padding:10px;border-radius:5px;margin-top:10px;display:none}
        .remark-section{margin-top:15px;margin-bottom:15px}
        .remark-label{display:block;font-weight:bold;color:#212121;margin-bottom:8px}
        .remark-input{width:100%;padding:8px;border:1px solid #90caf9;border-radius:5px}
        .dealer-type-badge{min-width:72px}
    </style>
</head>
<body>
<div class="container">
    <h2>Send To Owners</h2>
    <div id="modeChip" class="mode-chip" style="display:none;"></div>
    <button class="refresh-btn" onclick="fetchOrders()">Refresh Orders</button>
    <div id="content"><div class="loading">Loading orders...</div></div>
</div>

<script>
    let orders = [];
    let countdownInterval;
    let VIEW_ONLY = false; // runtime flag

    // API endpoint
    const API_URL = 'https://script.google.com/macros/s/AKfycbyA-Q0NczExlSQmU9ZSNqFsUzVU5u3mK1gQewekQA2L7VOL7rJzTiI-Vmhqc3fiu9bb/exec';

    // ---- URL param helpers ----
    function getParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const crm = (urlParams.get('crm') || '').trim();
        const mode = (urlParams.get('mode') || '').trim().toLowerCase();
        return { crm, mode };
    }

    function computeRequestUrl() {
        const { crm, mode } = getParams();

        // Mode logic:
        // 1) mode=view => show ALL (no crm param), VIEW_ONLY = true
        // 2) only crm given => filtered by CRM, VIEW_ONLY = false
        // 3) no params => ALL (no crm param), VIEW_ONLY = false
        if (mode === 'view') {
            VIEW_ONLY = true;
            return API_URL; // no crm -> all data
        }
        VIEW_ONLY = false;
        if (crm) {
            return `${API_URL}?crm=${encodeURIComponent(crm)}`; // filtered
        }
        return API_URL; // all
    }

    function updateModeChip() {
        const chip = document.getElementById('modeChip');
        const { crm, mode } = getParams();

        let text = '';
        if (mode === 'view') {
            text = 'View Only • All CRMs';
        } else if (crm) {
            text = `Editable • CRM: ${crm}`;
        } else {
            text = 'Editable • All CRMs';
        }
        chip.textContent = text;
        chip.style.display = 'inline-block';
    }

    // ---- Fetch Orders ----
    async function fetchOrders() {
        try {
            document.getElementById('content').innerHTML = '<div class="loading">Loading orders...</div>';
            const requestUrl = computeRequestUrl();
            updateModeChip();

            const response = await fetch(requestUrl);
            const result = await response.json();

            if (result.status === 'success') {
                orders = result.data || [];
                displayOrders();
                if (VIEW_ONLY) applyViewOnly();
                if (typeof setReadOnlyMode === "function" && VIEW_ONLY) {
                    // If external viewOnly.js exists, let it run too
                    setReadOnlyMode();
                }
                startCountdown();
            } else {
                throw new Error('Failed to fetch orders');
            }
        } catch (error) {
            console.error('Error fetching orders:', error);
            document.getElementById('content').innerHTML =
                '<div class="error">Error loading orders. Please check your API URL and try again.</div>';
        }
    }

    // ---- Render ----
    function displayOrders() {
        const content = document.getElementById('content');
        if (!orders.length) {
            content.innerHTML = '<div class="loading">No orders found.</div>';
            return;
        }

        const ordersHTML = orders.map((order, index) => {
            // Dealer type badge
            let dealerTypeBadge = '';
            if (order.dealerType) {
                let badgeColorClass = 'bg-gray-500';
                switch ((order.dealerType || '').toLowerCase()) {
                    case 'red': badgeColorClass = 'bg-red-500'; break;
                    case 'yellow': badgeColorClass = 'bg-yellow-500'; break;
                    case 'green': badgeColorClass = 'bg-green-500'; break;
                }
                dealerTypeBadge = `
                    <div class="dealer-type-badge ${badgeColorClass} text-white text-xs font-semibold px-3 py-1 rounded-full flex items-center justify-center ml-2">
                        ${order.dealerType}
                    </div>`;
            }

            return `
            <div class="order-card" id="order-${index}">
                <div class="order-header">
                    <div class="flex items-center">
                        <div class="dealer-name">${order.dealerName || ''}</div>
                        ${dealerTypeBadge}
                    </div>
                    <div class="timestamp">Order Time: ${formatDateTime(order.timestamp)}</div>
                </div>

                <div class="order-details">
                    <div class="detail-row">
                        <span class="detail-label">Marketing:</span>
                        <span class="detail-value">${order.marketingPersonName || ''}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value">${order.location || ''}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">CRM Name:</span>
                        <span class="detail-value">${order.crmName || ''}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Concerned Owner:</span>
                        <span class="detail-value">${order.concernedOwner || ''}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">L-1 Remark:</span>
                        <span class="detail-value">${order.level1Remark || ''}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">File:</span>
                        <span class="detail-value">
                            ${order.fileUploadLink ? `<a href="${order.fileUploadLink}" target="_blank" class="file-link">View File</a>` : '-'}
                        </span>
                    </div>
                </div>

                <div class="countdown-section">
                    <div class="countdown-label">Time Remaining:</div>
                    <div class="countdown-timer" id="countdown-${index}">Calculating...</div>
                </div>

                <div class="editable">
                    <div class="action-section">
                        <div class="file-upload-section" id="file-upload-section-${index}">
                            <label class="file-upload-label">Attach Final Order Here:</label>
                            <input type="file" class="file-input" id="file-${index}" onchange="handleFileSelect(${index})">
                            <div class="file-selected" id="file-selected-${index}">✓ File selected</div>
                        </div>

                        <div class="remark-section">
                            <label class="remark-label">Remark:</label>
                            <input type="text" class="remark-input" id="remark-${index}" placeholder="Enter remark here">
                        </div>

                        <div class="gola-section">
                            <label class="remark-label">Gola Options:</label>
                            <select class="remark-input" id="gola-${index}" required>
                                <option value="" disabled selected>Select Gola Option</option>
                                <option value="GOLA">NexTree</option>
                                <option value="NON-GOLA">NT Woods</option>
                            </select>
                        </div>

                        <div class="radio-section">
                            <label class="radio-label">Status:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" id="owners-informed-yes-${index}" name="owners-informed-${index}" value="yes">
                                    <span>Owners Informed</span>
                                </label>
                            </div>
                        </div>

                        <div class="hold-until-section" id="hold-until-section-${index}">
                            <label class="hold-until-label">Hold Until:</label>
                            <input type="date" class="hold-until-input" id="hold-until-${index}">
                            <label class="hold-until-label">Hold Remark:</label>
                            <input type="text" class="hold-until-input" id="hold-until-remark-${index}">
                        </div>

                        <div class="button-group">
                            <button class="submit-btn" onclick="submitOrder(${index}, 'Approve')">Approve</button>
                            <button class="hold-btn" onclick="submitOrder(${index}, 'Hold')">Hold</button>
                            <button class="cancel-btn" onclick="submitOrder(${index}, 'Cancel')">Cancel</button>
                        </div>

                        <div class="success-message" id="success-${index}">Order submitted successfully!</div>
                        <div class="error-message" id="error-${index}">Error submitting order. Please try again.</div>
                    </div>
                </div>
            </div>`;
        }).join('');

        content.innerHTML = `<div class="orders-grid">${ordersHTML}</div>`;
    }

    // View-only apply (hide editable sections + disable buttons/inputs)
    function applyViewOnly() {
        document.querySelectorAll('.editable').forEach(el => el.style.display = 'none');
        // Safeguard: also disable all interactive elements if any remain visible
        document.querySelectorAll('button, input, select, textarea').forEach(el => {
            if (!el.closest('.editable')) return; // only those inside editable would be hidden anyway
            el.disabled = true;
        });
    }

    // ---- Business rules for countdown ----
    function calculateDeadline(timestamp) {
        const orderTime = new Date(timestamp);
        const hour = orderTime.getHours();
        let deadline;
        if (hour >= 17) {
            deadline = getNextBusinessDay(orderTime);
            deadline.setHours(10, 0, 0, 0);
        } else {
            deadline = new Date(orderTime.getTime() + (60 * 60 * 1000));
        }
        return deadline;
    }

    function getNextBusinessDay(date) {
        const nextDay = new Date(date);
        nextDay.setDate(nextDay.getDate() + 1);
        while (nextDay.getDay() === 0 || nextDay.getDay() === 6) {
            nextDay.setDate(nextDay.getDate() + 1);
        }
        return nextDay;
    }

    function formatDateTime(timestamp) {
        const d = new Date(timestamp);
        return isNaN(d) ? '-' : d.toLocaleString();
    }

    function formatCountdown(ms) {
        if (ms <= 0) return 'OVERDUE';
        const totalSec = Math.floor(ms / 1000);
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function updateCountdowns() {
        const now = new Date();
        orders.forEach((order, i) => {
            const deadline = calculateDeadline(order.timestamp);
            const remaining = deadline.getTime() - now.getTime();
            const el = document.getElementById(`countdown-${i}`);
            if (!el) return;
            el.textContent = formatCountdown(remaining);
            el.className = 'countdown-timer';
            if (remaining <= 0) {
                el.classList.add('countdown-expired');
            } else if (remaining <= 30 * 60 * 1000) {
                el.classList.add('countdown-urgent');
            } else if (remaining <= 60 * 60 * 1000) {
                el.classList.add('countdown-warning');
            } else {
                el.classList.add('countdown-normal');
            }
        });
    }

    function startCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        updateCountdowns();
        countdownInterval = setInterval(updateCountdowns, 1000);
    }

    // ---- File + Submit logic (unchanged except safety) ----
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = err => reject(err);
        });
    }

    function handleFileSelect(orderIndex) {
        const input = document.getElementById(`file-${orderIndex}`);
        const info = document.getElementById(`file-selected-${orderIndex}`);
        if (input.files.length) {
            const f = input.files[0];
            info.style.display = 'block';
            info.textContent = `✓ ${f.name} selected (${(f.size/1024).toFixed(1)} KB)`;
        } else {
            info.style.display = 'none';
        }
    }

    function toggleHoldUntilField(orderIndex, actionType) {
        const fileUploadSection = document.getElementById(`file-upload-section-${orderIndex}`);
        const holdUntilSection = document.getElementById(`hold-until-section-${orderIndex}`);
        const ownersYes = document.getElementById(`owners-informed-yes-${orderIndex}`);
        const remarkSection = document.querySelector(`#order-${orderIndex} .remark-section`);

        if (actionType === 'Hold') {
            holdUntilSection.style.display = 'block';
            fileUploadSection.style.display = 'none';
            if (ownersYes) ownersYes.checked = false;
            if (remarkSection) remarkSection.style.display = 'none';
        } else {
            holdUntilSection.style.display = 'none';
            fileUploadSection.style.display = 'block';
            if (remarkSection) remarkSection.style.display = 'block';
        }
    }

    async function submitOrder(orderIndex, actionType) {
        const fileInput = document.getElementById(`file-${orderIndex}`);
        const ownersInformedRadio = document.querySelector(`input[name="owners-informed-${orderIndex}"]:checked`);
        const approveBtn = document.querySelector(`#order-${orderIndex} .submit-btn`);
        const holdBtn = document.querySelector(`#order-${orderIndex} .hold-btn`);
        const cancelBtn = document.querySelector(`#order-${orderIndex} .cancel-btn`);
        const holdUntilInput = document.getElementById(`hold-until-${orderIndex}`);
        const holdUntilRemark = document.getElementById(`hold-until-remark-${orderIndex}`);
        const remarkInput = document.getElementById(`remark-${orderIndex}`);
        const golaSelect = document.getElementById(`gola-${orderIndex}`);
        const successMessage = document.getElementById(`success-${orderIndex}`);
        const errorMessage = document.getElementById(`error-${orderIndex}`);

        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';

        approveBtn.disabled = true; holdBtn.disabled = true; cancelBtn.disabled = true;
        toggleHoldUntilField(orderIndex, actionType);

        let submitData = {
            action: actionType,
            orderIndex,
            dealerName: orders[orderIndex].dealerName,
            timestamp: orders[orderIndex].timestamp,
            marketingPersonName: orders[orderIndex].marketingPersonName,
            location: orders[orderIndex].location,
            holdRemark: holdUntilRemark.value,
            remark: remarkInput.value,
            golaOption: golaSelect.value,
            crmName: orders[orderIndex].crmName,
            ownersInformed: ownersInformedRadio ? ownersInformedRadio.value : ''
        };

        try {
            if (actionType === 'Approve') {
                approveBtn.textContent = 'Converting & Approving...';
                if (!golaSelect.value) { alert('Please select a Gola Option before proceeding.'); throw new Error('Gola Option is required'); }
                if (!fileInput.files.length) { alert('Please attach a file before approving.'); throw new Error('File is required for approval'); }
                if (!ownersInformedRadio) { alert('Please select the owners informed status for approval.'); throw new Error('Owner informed status required'); }
                if (!remarkInput.value.trim()) { alert('Please provide a remark for approval.'); throw new Error('Remark is required for approval'); }

                const file = fileInput.files[0];
                const base64 = await fileToBase64(file);
                submitData.file = { name:file.name, type:file.type, size:file.size, base64 };
            } else if (actionType === 'Hold') {
                holdBtn.textContent = 'Holding...';
                if (!holdUntilInput.value || !holdUntilRemark.value) { alert('Please provide a "Hold Until" date and remark.'); throw new Error('Hold details missing'); }
                if (!ownersInformedRadio) { alert('Please select the owners informed status for holding the order.'); throw new Error('Owner informed status required'); }
                submitData.holdUntil = holdUntilInput.value;
            } else if (actionType === 'Cancel') {
                cancelBtn.textContent = 'Cancelling...';
                if (!remarkInput.value.trim()) { alert('Please provide a remark for cancellation.'); throw new Error('Remark is required for cancellation'); }
            }

            console.log('Submitting order data:', {
                ...submitData,
                file: submitData.file ? { ...submitData.file, base64: (submitData.file.base64||'').slice(0,50)+'...' } : undefined
            });

            await postData(submitData);

            successMessage.style.display = 'block';
            setTimeout(() => successMessage.style.display = 'none', 5000);

            // reset
            fileInput.value = '';
            document.getElementById(`file-selected-${orderIndex}`).style.display = 'none';
            if (ownersInformedRadio) ownersInformedRadio.checked = false;
            holdUntilInput.value = '';
            holdUntilRemark.value = '';
            remarkInput.value = '';
            document.getElementById(`hold-until-section-${orderIndex}`).style.display = 'none';
            document.getElementById(`file-upload-section-${orderIndex}`).style.display = 'block';
            document.querySelector(`#order-${orderIndex} .remark-section`).style.display = 'block';

        } catch (err) {
            console.error('Error submitting order:', err);
            errorMessage.textContent = `Error: ${err.message}`;
            errorMessage.style.display = 'block';
            setTimeout(() => errorMessage.style.display = 'none', 5000);
        } finally {
            approveBtn.disabled = false; holdBtn.disabled = false; cancelBtn.disabled = false;
            approveBtn.textContent = 'Approve'; holdBtn.textContent = 'Hold'; cancelBtn.textContent = 'Cancel';
        }
    }

    async function postData(data) {
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            // assume success in no-cors
            setTimeout(fetchOrders, 1000);
        } catch (error) {
            console.error('Network error during submission:', error);
            throw error;
        }
    }

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', () => {
        fetchOrders();
        // Auto-refresh every 10 minutes
        setInterval(fetchOrders, 10 * 60 * 1000);
    });

    window.addEventListener('beforeunload', () => {
        if (countdownInterval) clearInterval(countdownInterval);
    });
</script>

<!-- Optional external: if you already have custom viewOnly.js it will still run via setReadOnlyMode() call -->
<script src="js/viewOnly.js"></script>
</body>
</html>
