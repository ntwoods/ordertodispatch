<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dispatch Team - Sales Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .file-upload-label { display:block; font-size:.875rem; font-weight:500; margin-bottom:.25rem; color:#374151; }
    .file-input { width:100%; border:1px solid #d1d5db; border-radius:.375rem; padding:.5rem .75rem; font-size:.875rem; }
    .file-selected { display:none; margin-top:.25rem; font-size:.75rem; color:#10b981; font-weight:500; }
    .modal-overlay { background-color:rgba(0,0,0,.5); backdrop-filter:blur(4px); transition:opacity .3s ease-in-out; }
    .modal-content { transition:transform .3s ease-in-out, opacity .3s ease-in-out; }
    .modal-open { transform:translateY(0)!important; opacity:1!important; }
    .animate-spin-fast { animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .order-card { transition: all .3s ease; }
    .order-card:hover { transform: translateY(-2px); }
    .chev { transition: transform .2s ease; }
    .chev.rot { transform: rotate(90deg); }
    .tiny-table th, .tiny-table td { padding:0.5rem; text-align:left; }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50">
  <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-3xl font-bold">üöÄ Dispatch Dashboard</h1>
      <div class="flex items-center space-x-4">
        <span id="last-updated" class="text-sm opacity-80"></span>
        <div id="refresh-indicator" class="flex items-center space-x-2 text-sm">
          <svg class="animate-spin-fast h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display:none;">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span id="refresh-text" class="hidden">Refreshing...</span>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto p-6 flex-grow">
    <h2 class="text-3xl font-semibold text-gray-800 mb-6">Approved Sales Orders</h2>

    <div class="editable">
      <a href="https://ntwoods.github.io/audit/warehouseManager" target="_blank"
         class="inline-block px-4 py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition duration-200 shadow">
        üßëüèª‚Äçüè´ Audit Portal
      </a>
    </div>

    <div id="loading-spinner" class="flex justify-center items-center py-10" style="display:none;">
      <div class="animate-spin-fast rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p class="ml-4 text-xl text-gray-600">Fetching latest orders...</p>
    </div>

    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert" style="display:none;">
      <strong class="font-bold">Oops!</strong>
      <span class="block sm:inline" id="error-text">Something went wrong while fetching data. Please try again later.</span>
      <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('error-message').style.display='none'">
        <svg class="fill-current h-6 w-6 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M14.348 14.849a1.2 1.2 0 01-1.697 0L10 11.414l-2.651 2.651a1.2 1.2 0 11-1.697-1.697L8.586 10 5.935 7.348a1.2 1.2 0 011.697-1.697L10 8.586l2.651-2.651a1.2 1.2 0 011.697 1.697L11.414 10l2.651 2.651a1.2 1.2 0 010 1.698z"/></svg>
      </span>
    </div>

    <div id="no-orders-message" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-6" style="display:none;">
      <strong class="font-bold">Heads Up!</strong>
      <span class="block sm:inline">No approved sales orders found at the moment.</span>
    </div>

    <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </main>

  <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-auto">
    <div class="container mx-auto">&copy; <span id="current-year"></span> Dispatch Team Dashboard. All rights reserved.</div>
  </footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbygRGmvL8xyEl0hCSkQdUBGLWG1xHIcY-sNVaPsj97WV0Y7fsOWNjtAJ-bo40xZweh7/exec";
    const ordersGrid = document.getElementById("orders-grid");
    const loadingSpinner = document.getElementById("loading-spinner");
    const errorMessage = document.getElementById("error-message");
    const errorText = document.getElementById("error-text");
    const noOrdersMessage = document.getElementById("no-orders-message");
    const lastUpdatedSpan = document.getElementById("last-updated");
    const refreshIndicator = document.getElementById("refresh-indicator");
    const refreshSpinner = refreshIndicator.querySelector("svg");
    const refreshText = document.getElementById("refresh-text");
    let allOrdersData = [];

    function formatTimestamp(iso) {
      if (!iso) return "N/A";
      const d = new Date(iso);
      return isNaN(d) ? iso : d.toLocaleString("en-IN");
    }
    function formatDispatchDate(dateStr) {
      if (!dateStr) return "N/A";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
    }
    function isPastDate(dateStr){
      if(!dateStr) return false;
      const d=new Date(dateStr); if(isNaN(d)) return false;
      const now=new Date(); now.setHours(0,0,0,0);
      const target=new Date(d); target.setHours(0,0,0,0);
      return target<now;
    }

    async function fetchOrders(){
      loadingSpinner.style.display="flex";
      errorMessage.style.display="none"; noOrdersMessage.style.display="none";
      ordersGrid.innerHTML="";
      try{
        const res=await fetch(API_URL);
        const result=await res.json();
        if(result.status==="success" && result.data?.length){
          allOrdersData=result.data;
          renderOrders(result.data);
          noOrdersMessage.style.display="none";
        }else if(result.status==="success"){ noOrdersMessage.style.display="block"; }
        lastUpdatedSpan.textContent="Last updated: "+new Date().toLocaleTimeString();
      }catch(e){
        console.error(e);
        errorText.textContent=`Error: ${e.message}`; errorMessage.style.display="block";
      }finally{
        loadingSpinner.style.display="none";
        refreshSpinner.style.display="none"; refreshText.classList.add("hidden");
        setTimeout(()=>{ initEnhancements(); },800);
      }
    }

    function renderOrders(orders){
      ordersGrid.innerHTML="";
      orders.forEach((order,index)=>{
        const isLate=isPastDate(order.dispatchDate);
        const isHighlighted = order.invoice || order.dispatchReceipt;
        const bgClass = isHighlighted ? "bg-yellow-100" : (isLate?"bg-red-100":"bg-white");
        const card=document.createElement("div");
        card.className=`order-card rounded-lg shadow-md p-6 hover:shadow-xl ${bgClass}`;
        card.setAttribute("data-order-index",index);
        card.innerHTML=`
          <h3 class="text-xl font-semibold text-blue-700 mb-2">${order.dealerName||"N/A"}</h3>
          <p class="text-gray-600"><b>Marketing:</b> ${order.marketingPersonName||"N/A"}</p>
          <p class="text-gray-600"><b>CRM:</b> ${order.crmName||"N/A"}</p>
          <p class="text-gray-600"><b>Location:</b> ${order.location||"N/A"}</p>
          <div class="mt-3 text-sm text-gray-600">
            <p><b>Dispatch:</b> ${formatDispatchDate(order.dispatchDate)}</p>
            <p><b>Timestamp:</b> ${formatTimestamp(order.timestamp)}</p>
          </div>
          <div class="mt-4 border-t pt-3">
            <label class="block text-sm font-medium mb-1">Expected Delivery:</label>
            <input type="date" id="delivery-${index}" class="w-full border rounded px-2 py-1"/>
            <label class="block mt-2 text-sm font-medium">Attach LR Receipt:</label>
            <input type="file" id="file-${index}" class="w-full border rounded px-2 py-1"/>
            <label class="block mt-2 text-sm font-medium">Attach Invoice:</label>
            <input type="file" id="file1-${index}" class="w-full border rounded px-2 py-1"/>
            <button onclick="markDone(${index})" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Submit Details</button>
            <button id="simpleMark-${index}" class="mt-2 w-full bg-green-600 text-white py-2 rounded opacity-50 cursor-not-allowed" disabled>Mark Done</button>
          </div>`;
        ordersGrid.appendChild(card);
      });
    }

    async function markDone(orderIndex){
      const order=allOrdersData[orderIndex];
      if(!order) return;
      const payload={action:"markDoneFull", timestamp:order.timestamp};
      await fetch(API_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      showMessageBox("Details submitted","success");
    }

    function showMessageBox(msg,type="info"){
      const el=document.createElement("div");
      el.className=`fixed top-4 right-4 p-3 text-white rounded shadow-lg z-50 ${type==="success"?"bg-green-500":"bg-blue-500"}`;
      el.textContent=msg; document.body.appendChild(el);
      setTimeout(()=>el.remove(),2500);
    }

    async function handleSimpleMark(orderIndex){
      const order=allOrdersData[orderIndex];
      if(!order) return;
      const btn=document.getElementById(`simpleMark-${orderIndex}`);
      btn.disabled=true; btn.textContent="Processing...";
      try{
        const payload={action:"markDone", timestamp:order.timestamp};
        await fetch(API_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        showMessageBox("Order marked done","success");
        document.querySelector(`[data-order-index="${orderIndex}"]`)?.remove();
      }catch(e){console.error(e); showMessageBox("Error","error");}
    }

    function initEnhancements(){
      allOrdersData.forEach((order,index)=>{
        const btn=document.getElementById(`simpleMark-${index}`);
        if(!btn) return;
        if(order.invoice && order.dispatchReceipt){
          btn.disabled=false;
          btn.classList.remove("opacity-50","cursor-not-allowed");
          btn.classList.add("hover:bg-green-700","transition");
          btn.addEventListener("click",()=>handleSimpleMark(index));
        }
      });
    }

    fetchOrders();
    setInterval(()=>{refreshSpinner.style.display="block";refreshText.classList.remove("hidden");fetchOrders();},300000);
    document.getElementById("current-year").textContent=new Date().getFullYear();
  </script>
</body>
</html>
