<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <title>Sales Orders Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#e0f2f7; padding:20px; }
    .container { max-width:1200px; margin:0 auto; }
    .gola-section { margin:15px 0; }

    h1,h2 { text-align:center; color:#01579b; margin-bottom:30px; }
    .loading { text-align:center; font-size:18px; color:#0277bd; }
    .error { background:#bbdefb; color:#c62828; padding:15px; border-radius:5px; text-align:center; margin-bottom:20px; }

    .orders-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:20px; }
    .order-card { background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:20px; transition:transform .2s; }
    .order-card:hover { transform:translateY(-2px); box-shadow:0 4px 20px rgba(0,0,0,0.15); }

    .order-header { border-bottom:2px solid #90caf9; padding-bottom:10px; margin-bottom:15px; }
    .dealer-name { font-size:20px; font-weight:bold; color:#1976d2; margin-bottom:5px; }
    .timestamp { color:#424242; font-size:14px; }

    .order-details { margin-bottom:15px; }
    .detail-row { display:flex; justify-content:space-between; margin-bottom:8px; padding:5px 0; }
    .detail-label { font-weight:bold; color:#212121; flex:1; }
    .detail-value { color:#424242; flex:2; text-align:right; }

    .file-link { color:#1976d2; text-decoration:none; }
    .file-link:hover { text-decoration:underline; }

    .countdown-section { background:#e3f2fd; border-radius:5px; padding:15px; text-align:center; }
    .countdown-label { font-size:14px; color:#424242; margin-bottom:5px; }
    .countdown-timer { font-size:24px; font-weight:bold; font-family:monospace; }
    .countdown-urgent { color:#d32f2f; animation:pulse 1s infinite; }
    .countdown-warning { color:#f57c00; }
    .countdown-normal { color:#2e7d32; }
    .countdown-expired { color:#d32f2f; background:#ffebee; }

    @keyframes pulse { 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }

    .refresh-btn { background:#1976d2; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:16px; margin-bottom:20px; }
    .refresh-btn:hover { background:#1565c0; }

    .action-section { border-top:2px solid #90caf9; padding-top:15px; margin-top:15px; }
    .file-upload-section { margin-bottom:15px; }
    .file-upload-label { display:block; font-weight:bold; color:#212121; margin-bottom:8px; }
    .file-input { width:100%; padding:8px; border:2px dashed #90caf9; border-radius:5px; background:#e3f2fd; cursor:pointer; transition:border-color .3s; }
    .file-input:hover { border-color:#1976d2; }
    .file-selected { color:#2e7d32; font-size:14px; margin-top:5px; display:none; }

    .radio-section { margin-bottom:15px; }
    .radio-label { font-weight:bold; color:#212121; margin-bottom:8px; display:block; }
    .radio-group { display:flex; gap:15px; }
    .radio-option { display:flex; align-items:center; gap:5px; }
    .radio-option label { color:#424242; cursor:pointer; font-weight:normal; }

    .button-group { display:flex; gap:10px; margin-top:15px; }
    .submit-btn,.hold-btn,.cancel-btn { color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:14px; flex-grow:1; transition:background-color .3s; }
    .submit-btn { background:#1976d2; } .submit-btn:hover { background:#1565c0; }
    .submit-btn:disabled { background:#90caf9; cursor:not-allowed; }
    .hold-btn { background:#2196f3; } .hold-btn:hover { background:#1e88e5; }
    .hold-btn:disabled { background:#90caf9; cursor:not-allowed; }
    .cancel-btn { background:#ef5350; }

    .hold-until-section { margin:15px 0; display:none; }
    .hold-until-label { display:block; font-weight:bold; color:#212121; margin-bottom:8px; }
    .hold-until-input { width:100%; padding:8px; border:1px solid #90caf9; border-radius:5px; }

    .success-message { background:#e3f2fd; color:#1976d2; padding:10px; border-radius:5px; margin-top:10px; display:none; }
    .error-message { background:#ffebee; color:#c62828; padding:10px; border-radius:5px; margin-top:10px; display:none; }

    .remark-section { margin:15px 0; }
    .remark-label { display:block; font-weight:bold; color:#212121; margin-bottom:8px; }
    .remark-input { width:100%; padding:8px; border:1px solid #90caf9; border-radius:5px; }

    /* Dealer type badge */
    .dealer-type-badge {
      display:inline-flex; align-items:center; justify-content:center;
      padding:0.25rem 0.75rem; border-radius:9999px;
      font-size:0.75rem; font-weight:600; color:#fff; margin-left:0.5rem; white-space:nowrap; z-index:30;
    }
    .bg-red-500{background:#ef4444} .bg-yellow-500{background:#f59e0b} .bg-green-500{background:#22c55e} .bg-gray-500{background:#6b7280}
  </style>
</head>
<body>
  <div class="container">
    <h2>Send To Owners</h2>

    <!-- Mode banner -->
    <div id="modeBanner" class="hidden mb-4 px-4 py-2 rounded-lg text-sm font-semibold border"></div>

    <button class="refresh-btn" onclick="fetchOrders()">Refresh Orders</button>
    <div id="content"><div class="loading">Loading orders...</div></div>
  </div>

  <script>
    let orders = [];
    let countdownInterval;

    // ===== URL mode detection =====
    const params = new URLSearchParams(window.location.search);
    const modeParam = (params.get('mode') || '').trim().toLowerCase();
    const crmParam  = (params.get('crm')  || '').trim();

    // 3 behaviors:
    // 1) ?crm=...  => CRM-filtered + edit
    // 2) ?mode=view => ALL + view-only (ignore crm)
    // 3) no params  => ALL + edit
    const IS_VIEW_ONLY = modeParam === 'view';
    const FETCH_ALL    = IS_VIEW_ONLY || !crmParam;

    // Your API endpoint URL (returns ALL if no crm param)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyA-Q0NczExlSQmU9ZSNqFsUzVU5u3mK1gQewekQA2L7VOL7rJzTiI-Vmhqc3fiu9bb/exec';
    const apiFetchUrl = FETCH_ALL ? API_URL : `${API_URL}?crm=${encodeURIComponent(crmParam)}`;

    // Banner
    function setModeBanner(){
      const el = document.getElementById('modeBanner');
      let text = '', cls = '';
      if (IS_VIEW_ONLY) {
        text = 'Mode: View Only • Showing orders for ALL CRMs';
        cls  = 'bg-yellow-100 text-yellow-800 border-yellow-300';
      } else if (!FETCH_ALL) {
        text = `Mode: Normal • CRM Filter: ${crmParam}`;
        cls  = 'bg-blue-100 text-blue-800 border-blue-300';
      } else {
        text = 'Mode: Normal • Showing orders for ALL CRMs';
        cls  = 'bg-green-100 text-green-800 border-green-300';
      }
      el.textContent = text;
      el.className = `mb-4 px-4 py-2 rounded-lg text-sm font-semibold border ${cls}`;
      el.classList.remove('hidden');
    }
    setModeBanner();

    // ========= Fetch =========
    async function fetchOrders() {
      try {
        document.getElementById('content').innerHTML = '<div class="loading">Loading orders...</div>';

        const response = await fetch(apiFetchUrl);
        const result = await response.json();

        if (result.status === 'success') {
          orders = result.data || [];
          displayOrders();
          startCountdown();

          // if external viewOnly.js provides this, call in view-only
          if (IS_VIEW_ONLY && typeof setReadOnlyMode === 'function') setReadOnlyMode();
        } else {
          throw new Error('Failed to fetch orders');
        }
      } catch (error) {
        console.error('Error fetching orders:', error);
        document.getElementById('content').innerHTML =
          '<div class="error">Error loading orders. Please check your API URL and try again.</div>';
      }
    }

    // ===== Helpers =====
    function formatDateTime(ts){ const d = new Date(ts); return d.toLocaleString(); }

    // Dealer type badge
    function dealerBadge(type){
      if(!type) return '';
      let c = 'bg-gray-500';
      switch(String(type).toLowerCase()){
        case 'red': c='bg-red-500'; break;
        case 'yellow': c='bg-yellow-500'; break;
        case 'green': c='bg-green-500'; break;
      }
      return `<div class="dealer-type-badge ${c}">${type}</div>`;
    }

    // ========= Render =========
    function displayOrders() {
      const content = document.getElementById('content');

      if (!orders.length) {
        content.innerHTML = '<div class="loading">No orders found.</div>';
        return;
      }

      const html = orders.map((order, index) => {
        const editableBlock = IS_VIEW_ONLY ? `
          <div class="mt-3 text-sm italic text-gray-600">View Only Mode: Editing controls are disabled.</div>
        ` : `
          <div class="action-section editable">
            <div class="file-upload-section" id="file-upload-section-${index}">
              <label class="file-upload-label">Attach Final Order Here:</label>
              <input type="file" class="file-input" id="file-${index}" onchange="handleFileSelect(${index})">
              <div class="file-selected" id="file-selected-${index}">✓ File selected</div>
            </div>

            <div class="remark-section">
              <label class="remark-label">Remark:</label>
              <input type="text" class="remark-input" id="remark-${index}" placeholder="Enter remark here">
            </div>

            <div class="gola-section">
              <label class="remark-label">Gola Options:</label>
              <select class="remark-input" id="gola-${index}" required>
                <option value="" disabled selected>Select Gola Option</option>
                <option value="GOLA">GOLA</option>
                <option value="NON-GOLA">NON-GOLA</option>
              </select>
            </div>

            <div class="radio-section">
              <label class="radio-label">Status:</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="owners-informed-yes-${index}" name="owners-informed-${index}" value="yes">
                  <label for="owners-informed-yes-${index}">Owners Informed</label>
                </div>
              </div>
            </div>

            <div class="hold-until-section" id="hold-until-section-${index}">
              <label class="hold-until-label">Hold Until:</label>
              <input type="date" class="hold-until-input" id="hold-until-${index}">
              <label class="hold-until-label">Hold Remark:</label>
              <input type="text" class="hold-until-input" id="hold-until-remark-${index}">
            </div>

            <div class="button-group">
              <button class="submit-btn" onclick="submitOrder(${index}, 'Approve')">Approve</button>
              <button class="hold-btn"   onclick="submitOrder(${index}, 'Hold')">Hold</button>
              <button class="cancel-btn" onclick="submitOrder(${index}, 'Cancel')">Cancel</button>
            </div>

            <div class="success-message" id="success-${index}">Order submitted successfully!</div>
            <div class="error-message"   id="error-${index}">Error submitting order. Please try again.</div>
          </div>
        `;

        return `
          <div class="order-card" id="order-${index}">
            <div class="order-header">
              <div class="flex items-center">
                <div class="dealer-name">${order.dealerName}</div>
                ${dealerBadge(order.dealerType)}
              </div>
              <div class="timestamp">Order Time: ${formatDateTime(order.timestamp)}</div>
            </div>

            <div class="order-details">
              <div class="detail-row"><span class="detail-label">Marketing:</span><span class="detail-value">${order.marketingPersonName}</span></div>
              <div class="detail-row"><span class="detail-label">Location:</span><span class="detail-value">${order.location}</span></div>
              <div class="detail-row"><span class="detail-label">CRM Name:</span><span class="detail-value">${order.crmName}</span></div>
              <div class="detail-row"><span class="detail-label">Concerned Owner:</span><span class="detail-value">${order.concernedOwner}</span></div>
              <div class="detail-row"><span class="detail-label">L-1 Remark:</span><span class="detail-value">${order.level1Remark ?? ''}</span></div>
              <div class="detail-row">
                <span class="detail-label">File:</span>
                <span class="detail-value">
                  ${order.fileUploadLink ? `<a href="${order.fileUploadLink}" target="_blank" class="file-link">View File</a>` : 'N/A'}
                </span>
              </div>
            </div>

            <div class="countdown-section">
              <div class="countdown-label">Time Remaining:</div>
              <div class="countdown-timer" id="countdown-${index}">Calculating...</div>
            </div>

            ${editableBlock}
          </div>
        `;
      }).join('');

      content.innerHTML = `<div class="orders-grid">${html}</div>`;

      if (IS_VIEW_ONLY) applyViewOnly(); // hard-disable controls as extra safety
    }

    // ===== View-only hardening (disable inputs/buttons) =====
    function applyViewOnly(){
      // Hide editable sections entirely
      document.querySelectorAll('.editable').forEach(el => { el.style.opacity = .6; });
      // Disable all inputs + buttons inside editable
      document.querySelectorAll('.editable input, .editable select, .editable button, .editable textarea')
        .forEach(ctrl => { ctrl.disabled = true; ctrl.classList.add('cursor-not-allowed'); });
    }

    // ===== Deadline & countdown =====
    function getNextBusinessDay(date){
      const d = new Date(date);
      d.setDate(d.getDate()+1);
      while (d.getDay()===0 || d.getDay()===6){ d.setDate(d.getDate()+1); }
      return d;
    }
    function calculateDeadline(ts){
      const orderTime = new Date(ts);
      const hour = orderTime.getHours();
      let deadline;
      if (hour >= 17){
        deadline = getNextBusinessDay(orderTime);
        deadline.setHours(10,0,0,0);
      } else {
        deadline = new Date(orderTime.getTime() + 60*60*1000);
      }
      return deadline;
    }
    function formatCountdown(ms){
      if (ms<=0) return 'OVERDUE';
      const totalSec = Math.floor(ms/1000);
      const h = Math.floor(totalSec/3600);
      const m = Math.floor((totalSec%3600)/60);
      const s = totalSec%60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    function updateCountdowns(){
      const now = new Date();
      orders.forEach((order, i) => {
        const deadline = calculateDeadline(order.timestamp);
        const ms = deadline.getTime() - now.getTime();
        const el = document.getElementById(`countdown-${i}`);
        if (!el) return;
        el.textContent = formatCountdown(ms);
        el.className = 'countdown-timer';
        if (ms<=0) el.classList.add('countdown-expired');
        else if (ms<=30*60*1000) el.classList.add('countdown-urgent');
        else if (ms<=60*60*1000) el.classList.add('countdown-warning');
        else el.classList.add('countdown-normal');
      });
    }
    function startCountdown(){
      if (countdownInterval) clearInterval(countdownInterval);
      updateCountdowns();
      countdownInterval = setInterval(updateCountdowns, 1000);
    }

    // ===== File / submit helpers =====
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = ()=> resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
      });
    }
    function handleFileSelect(i){
      const input = document.getElementById(`file-${i}`);
      const info  = document.getElementById(`file-selected-${i}`);
      if (input.files.length){
        const f = input.files[0];
        info.style.display='block';
        info.textContent = `✓ ${f.name} selected (${(f.size/1024).toFixed(1)} KB)`;
      } else {
        info.style.display='none';
      }
    }
    function toggleHoldUntilField(i, action){
      const up = document.getElementById(`file-upload-section-${i}`);
      const hold = document.getElementById(`hold-until-section-${i}`);
      const informedYes = document.getElementById(`owners-informed-yes-${i}`);
      const remarkSec = document.querySelector(`#order-${i} .remark-section`);
      if (action==='Hold'){
        hold.style.display='block';
        up.style.display='none';
        if (informedYes) informedYes.checked = false;
        if (remarkSec) remarkSec.style.display='none';
      } else {
        hold.style.display='none';
        up.style.display='block';
        if (remarkSec) remarkSec.style.display='block';
      }
    }

    async function submitOrder(i, actionType){
      if (IS_VIEW_ONLY){ alert('View Only mode mein submission allowed nahi hai.'); return; }

      const fileInput = document.getElementById(`file-${i}`);
      const ownersInformed = document.querySelector(`input[name="owners-informed-${i}"]:checked`);
      const approveBtn = document.querySelector(`#order-${i} .submit-btn`);
      const holdBtn = document.querySelector(`#order-${i} .hold-btn`);
      const cancelBtn = document.querySelector(`#order-${i} .cancel-btn`);
      const holdUntilInput = document.getElementById(`hold-until-${i}`);
      const holdUntilRemark = document.getElementById(`hold-until-remark-${i}`);
      const remarkInput = document.getElementById(`remark-${i}`);
      const golaSelect = document.getElementById(`gola-${i}`);
      const success = document.getElementById(`success-${i}`);
      const error = document.getElementById(`error-${i}`);

      success.style.display='none'; error.style.display='none';
      approveBtn.disabled = holdBtn.disabled = cancelBtn.disabled = true;
      toggleHoldUntilField(i, actionType);

      let payload = {
        action: actionType,
        orderIndex: i,
        dealerName: orders[i].dealerName,
        timestamp: orders[i].timestamp,
        marketingPersonName: orders[i].marketingPersonName,
        location: orders[i].location,
        holdRemark: holdUntilRemark.value,
        remark: (remarkInput && remarkInput.value) || '',
        golaOption: (golaSelect && golaSelect.value) || '',
        crmName: orders[i].crmName,
        ownersInformed: ownersInformed ? ownersInformed.value : ''
      };

      try{
        if (actionType==='Approve'){
          approveBtn.textContent='Converting & Approving...';
          if (!golaSelect.value){ alert('Please select a Gola Option before proceeding.'); throw new Error('Gola Option is required'); }
          if (!fileInput.files.length){ alert('Please attach a file before approving.'); throw new Error('File is required for approval'); }
          if (!ownersInformed){ alert('Please select the owners informed status for approval.'); throw new Error('Owner informed status required'); }
          if (!remarkInput.value.trim()){ alert('Please provide a remark for approval.'); throw new Error('Remark is required for approval'); }
          const f = fileInput.files[0];
          const base64 = await fileToBase64(f);
          payload.file = { name:f.name, type:f.type, size:f.size, base64 };
        } else if (actionType==='Hold'){
          holdBtn.textContent='Holding...';
          if (!holdUntilInput.value || !holdUntilRemark.value){ alert('Please provide a "Hold Until" date and remark.'); throw new Error('Hold details missing'); }
          if (!ownersInformed){ alert('Please select the owners informed status for holding the order.'); throw new Error('Owner informed status required'); }
          payload.holdUntil = holdUntilInput.value;
        } else if (actionType==='Cancel'){
          cancelBtn.textContent='Cancelling...';
          if (!remarkInput.value.trim()){ alert('Please provide a remark for cancellation.'); throw new Error('Remark is required for cancellation'); }
        }

        await postData(payload);

        success.style.display='block';
        setTimeout(()=> success.style.display='none', 5000);

        // Reset
        fileInput.value='';
        document.getElementById(`file-selected-${i}`).style.display='none';
        if (ownersInformed) ownersInformed.checked = false;
        holdUntilInput.value='';
        holdUntilRemark.value='';
        remarkInput.value='';
        document.getElementById(`hold-until-section-${i}`).style.display='none';
        document.getElementById(`file-upload-section-${i}`).style.display='block';
        document.querySelector(`#order-${i} .remark-section`).style.display='block';

      } catch(err){
        console.error('Error submitting order:', err);
        error.textContent = `Error: ${err.message}`;
        error.style.display='block';
        setTimeout(()=> error.style.display='none', 5000);
      } finally {
        approveBtn.disabled = holdBtn.disabled = cancelBtn.disabled = false;
        approveBtn.textContent='Approve';
        holdBtn.textContent='Hold';
        cancelBtn.textContent='Cancel';
      }
    }

    async function postData(data){
      await fetch(API_URL, {
        method:'POST',
        mode:'no-cors',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(data)
      });
      // no-cors => assume success
      setTimeout(fetchOrders, 1000);
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      fetchOrders();
      // Auto-refresh every 10 minutes
      setInterval(fetchOrders, 10 * 60 * 1000);
    });

    window.addEventListener('beforeunload', ()=>{
      if (countdownInterval) clearInterval(countdownInterval);
    });
  </script>

  <script src="js/viewOnly.js"></script>
</body>
</html>
