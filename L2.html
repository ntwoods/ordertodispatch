<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <title>Sales Orders Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background-color:#f5f9ff;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    h2{color:#0b63b6;text-align:center;margin-bottom:8px}
    .mode-pill{display:inline-block;margin:0 auto 20px auto;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600}
    .mode-view{background:#e8f3ff;color:#0b63b6;border:1px solid #bcdcff}
    .mode-crm{background:#eafff0;color:#0b7a2b;border:1px solid #bff0cf}
    .mode-ea{background:#fff6e8;color:#a05a00;border:1px solid #f2ddb9}

    .loading{text-align:center;font-size:16px;color:#0b63b6}
    .error{background:#fdecee;color:#b10016;padding:14px;border-radius:8px;text-align:center;margin-bottom:16px;border:1px solid #ffd3d8}
    .orders-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px}
    .order-card{background:white;border-radius:12px;box-shadow:0 4px 16px rgba(8,47,73,0.06);padding:18px;border:1px solid #e7eef7;transition:transform .2s}
    .order-card:hover{transform:translateY(-2px)}
    .order-header{border-bottom:2px solid #e6f1ff;padding-bottom:10px;margin-bottom:12px}
    .dealer-name{font-size:20px;font-weight:800;color:#0b63b6;margin-bottom:4px}
    .timestamp{color:#475569;font-size:13px}
    .order-details{margin-bottom:12px}
    .detail-row{display:flex;justify-content:space-between;margin-bottom:6px;padding:3px 0}
    .detail-label{font-weight:700;color:#1e293b;flex:1}
    .detail-value{color:#334155;flex:2;text-align:right}
    .file-link{color:#0b63b6;text-decoration:none}
    .file-link:hover{text-decoration:underline}

    .countdown-section{background:#f0f7ff;border-radius:10px;padding:12px;text-align:center;border:1px solid #dbe9ff}
    .countdown-label{font-size:12px;color:#0f172a;margin-bottom:4px}
    .countdown-timer{font-size:22px;font-weight:800;font-family:monospace}
    .countdown-urgent{color:#c1121f;animation:pulse 1s infinite}
    .countdown-warning{color:#f59e0b}
    .countdown-normal{color:#15803d}
    .countdown-expired{color:#b91c1c;background:#fff1f2;border-radius:8px;padding:4px 8px;display:inline-block}

    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

    .action-section{border-top:2px solid #e6f1ff;padding-top:12px;margin-top:12px}
    .file-upload-label,.radio-label,.remark-label,.hold-until-label{display:block;font-weight:700;color:#1e293b;margin-bottom:6px}
    .file-input{width:100%;padding:8px;border:2px dashed #cfe3ff;border-radius:8px;background:#f5f9ff;cursor:pointer}
    .file-selected{color:#15803d;font-size:13px;margin-top:4px;display:none}
    .radio-section{margin-bottom:12px}
    .radio-group{display:flex;gap:14px}
    .radio-option{display:flex;align-items:center;gap:6px}
    .remark-input,.hold-until-input, .select-input {width:100%;padding:8px;border:1px solid #cfe3ff;border-radius:8px}
    .button-group{display:flex;gap:10px;margin-top:12px}
    .submit-btn,.hold-btn,.cancel-btn{color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-size:14px;flex-grow:1}
    .submit-btn{background:#0b63b6}.submit-btn:hover{background:#0a57a0}.submit-btn:disabled{background:#bcdcff;cursor:not-allowed}
    .hold-btn{background:#2196f3}.hold-btn:hover{background:#1e88e5}.hold-btn:disabled{background:#bcdcff;cursor:not-allowed}
    .cancel-btn{background:#ef5350}
    .success-message{background:#eef7ff;color:#0b63b6;padding:10px;border-radius:8px;margin-top:8px;display:none;border:1px solid #d3e7ff}
    .error-message{background:#fff1f2;color:#b10016;padding:10px;border-radius:8px;margin-top:8px;display:none;border:1px solid #ffd3d8}
    .dealer-type-badge{height:24px}
    .refresh-btn{background:#0b63b6;color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;font-size:14px;margin:10px auto 18px auto;display:block}
    .gola-section{margin:12px 0}
  </style>
</head>
<body>
  <div class="container">
    <h2>Send To Owners</h2>
    <div id="modePill" class="mode-pill mode-ea" style="display:none;">EA Mode</div>
    <button class="refresh-btn" onclick="fetchOrders()">Refresh Orders</button>
    <div id="content"><div class="loading">Loading orders...</div></div>
  </div>

<script>
  let orders = [];
  let countdownInterval;

  // ====== URL Mode Resolution ======
  const urlParams = new URLSearchParams(window.location.search);
  const rawMode = (urlParams.get('mode') || '').toLowerCase();
  const crmParam = urlParams.get('crm');
  // If crm present => crm mode; else if mode=view => view; else => ea
  const MODE = crmParam ? 'crm' : (rawMode === 'view' ? 'view' : 'ea');
  const isViewOnly = MODE === 'view';
  const modePill = document.getElementById('modePill');

  // ====== API endpoint ======
  const API_URL = 'https://script.google.com/macros/s/AKfycbyA-Q0NczExlSQmU9ZSNqFsUzVU5u3mK1gQewekQA2L7VOL7rJzTiI-Vmhqc3fiu9bb/exec';

  // Pretty label on top
  function paintModePill() {
    if (MODE === 'crm') {
      modePill.textContent = `CRM Mode — ${crmParam}`;
      modePill.className = 'mode-pill mode-crm';
      modePill.style.display = 'inline-block';
    } else if (MODE === 'view') {
      modePill.textContent = 'View Mode — Read Only';
      modePill.className = 'mode-pill mode-view';
      modePill.style.display = 'inline-block';
    } else {
      modePill.textContent = 'EA Mode — All CRMs, Editable';
      modePill.className = 'mode-pill mode-ea';
      modePill.style.display = 'inline-block';
    }
  }

  // ====== Fetch Orders ======
  async function fetchOrders() {
    try {
      document.getElementById('content').innerHTML = '<div class="loading">Loading orders...</div>';

      // Build URL per mode
      let requestUrl = API_URL;
      if (MODE === 'crm') {
        requestUrl += `?crm=${encodeURIComponent(crmParam)}`;
      } else if (MODE === 'view') {
        requestUrl += `?mode=view`;
      } // EA mode sends no params

      const response = await fetch(requestUrl);
      const result = await response.json();

      if (result.status === 'success') {
        orders = result.data || [];
        displayOrders();
        // Apply read-only only in view mode (and only if the helper exists)
        if (isViewOnly && typeof setReadOnlyMode === 'function') {
          setReadOnlyMode();
        }
        startCountdown();
      } else {
        throw new Error(result.message || 'Failed to fetch orders');
      }
    } catch (error) {
      console.error('Error fetching orders:', error);
      document.getElementById('content').innerHTML =
        '<div class="error">Error loading orders. Please check your deployment and try again.</div>';
    }
  }

  // ====== Render ======
  function displayOrders() {
    paintModePill();

    const content = document.getElementById('content');
    if (!orders || orders.length === 0) {
      content.innerHTML = '<div class="loading">No orders found.</div>';
      return;
    }

    const ordersHTML = orders.map((order, index) => {
      // Dealer Type badge color
      let dealerTypeBadge = '';
      if (order.dealerType) {
        let badgeColorClass = 'bg-gray-500';
        const d = String(order.dealerType).toLowerCase();
        if (d === 'red') badgeColorClass = 'bg-red-500';
        else if (d === 'yellow') badgeColorClass = 'bg-yellow-500';
        else if (d === 'green') badgeColorClass = 'bg-green-500';

        dealerTypeBadge = `
          <div class="dealer-type-badge ${badgeColorClass} text-white text-xs font-semibold px-3 py-1 rounded-full flex items-center justify-center ml-2">
            ${order.dealerType}
          </div>
        `;
      }

      const editableWrapperStart = `<div class="editable">`;
      const editableWrapperEnd = `</div>`;

      return `
        <div class="order-card" id="order-${index}">
          <div class="order-header">
            <div class="flex items-center">
              <div class="dealer-name">${order.dealerName || ''}</div>
              ${dealerTypeBadge}
            </div>
            <div class="timestamp">Order Time: ${formatDateTime(order.timestamp)}</div>
          </div>

          <div class="order-details">
            <div class="detail-row"><span class="detail-label">Marketing:</span><span class="detail-value">${order.marketingPersonName || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Location:</span><span class="detail-value">${order.location || ''}</span></div>
            <div class="detail-row"><span class="detail-label">CRM Name:</span><span class="detail-value">${order.crmName || ''}</span></div>
            <div class="detail-row"><span class="detail-label">Concerned Owner:</span><span class="detail-value">${order.concernedOwner || ''}</span></div>
            <div class="detail-row"><span class="detail-label">L-1 Remark:</span><span class="detail-value">${order.level1Remark || ''}</span></div>
            <div class="detail-row"><span class="detail-label">File:</span><span class="detail-value"><a href="${order.fileUploadLink || '#'}" target="_blank" class="file-link">View File</a></span></div>
          </div>

          <div class="countdown-section">
            <div class="countdown-label">Time Remaining:</div>
            <div class="countdown-timer" id="countdown-${index}">Calculating...</div>
          </div>

          ${isViewOnly ? '' : editableWrapperStart}
            ${isViewOnly ? '' : `
            <div class="action-section">
              <div class="file-upload-section" id="file-upload-section-${index}">
                <label class="file-upload-label">Attach Final Order Here:</label>
                <input type="file" class="file-input" id="file-${index}" onchange="handleFileSelect(${index})">
                <div class="file-selected" id="file-selected-${index}">✓ File selected</div>
              </div>

              <div class="remark-section">
                <label class="remark-label">Remark:</label>
                <input type="text" class="remark-input" id="remark-${index}" placeholder="Enter remark here">
              </div>

              <div class="gola-section">
                <label class="remark-label">Gola Options:</label>
                <select class="select-input" id="gola-${index}" required>
                  <option value="" disabled selected>Select Gola Option</option>
                  <option value="GOLA">NexTree</option>
                  <option value="NON-GOLA">NT Woods</option>
                </select>
              </div>

              <div class="radio-section">
                <label class="radio-label">Status:</label>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="owners-informed-yes-${index}" name="owners-informed-${index}" value="yes">
                    <label for="owners-informed-yes-${index}">Owners Informed</label>
                  </div>
                </div>
              </div>

              <div class="hold-until-section" id="hold-until-section-${index}" style="display:none;">
                <label class="hold-until-label">Hold Until:</label>
                <input type="date" class="hold-until-input" id="hold-until-${index}">
                <label class="hold-until-label">Hold Remark:</label>
                <input type="text" class="hold-until-input" id="hold-until-remark-${index}">
              </div>

              <div class="button-group">
                <button class="submit-btn" onclick="submitOrder(${index}, 'Approve')">Approve</button>
                <button class="hold-btn" onclick="submitOrder(${index}, 'Hold')">Hold</button>
                <button class="cancel-btn" onclick="submitOrder(${index}, 'Cancel')">Cancel</button>
              </div>

              <div class="success-message" id="success-${index}">Order submitted successfully!</div>
              <div class="error-message" id="error-${index}">Error submitting order. Please try again.</div>
            </div>`}
          ${isViewOnly ? '' : editableWrapperEnd}
        </div>
      `;
    }).join('');

    content.innerHTML = `<div class="orders-grid">${ordersHTML}</div>`;
  }

  // ====== Business rules (unchanged) ======
  function calculateDeadline(timestamp) {
    const orderTime = new Date(timestamp);
    const hour = orderTime.getHours();
    let deadline;

    if (hour >= 17) {
      deadline = getNextBusinessDay(orderTime);
      deadline.setHours(10, 0, 0, 0);
    } else {
      deadline = new Date(orderTime.getTime() + (60 * 60 * 1000));
    }
    return deadline;
  }

  function getNextBusinessDay(date) {
    const nextDay = new Date(date);
    nextDay.setDate(nextDay.getDate() + 1);
    while (nextDay.getDay() === 0 || nextDay.getDay() === 6) {
      nextDay.setDate(nextDay.getDate() + 1);
    }
    return nextDay;
  }

  function formatDateTime(timestamp) {
    if (!timestamp) return '';
    const d = new Date(timestamp);
    if (isNaN(d)) return '';
    return d.toLocaleString();
  }

  function formatCountdown(ms) {
    if (ms <= 0) return 'OVERDUE';
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  }

  function updateCountdowns() {
    const now = new Date();
    orders.forEach((order, index) => {
      const deadline = calculateDeadline(order.timestamp);
      const timeRemaining = deadline.getTime() - now.getTime();
      const el = document.getElementById(`countdown-${index}`);
      if (!el) return;

      el.textContent = formatCountdown(timeRemaining);
      el.className = 'countdown-timer';
      if (timeRemaining <= 0) el.classList.add('countdown-expired');
      else if (timeRemaining <= 30 * 60 * 1000) el.classList.add('countdown-urgent');
      else if (timeRemaining <= 60 * 60 * 1000) el.classList.add('countdown-warning');
      else el.classList.add('countdown-normal');
    });
  }

  function startCountdown() {
    if (countdownInterval) clearInterval(countdownInterval);
    updateCountdowns();
    countdownInterval = setInterval(updateCountdowns, 1000);
  }

  // ====== Helpers for actions (unchanged) ======
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = err => reject(err);
    });
  }

  function handleFileSelect(orderIndex) {
    const fileInput = document.getElementById(`file-${orderIndex}`);
    const fileSelectedDiv = document.getElementById(`file-selected-${orderIndex}`);
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      fileSelectedDiv.style.display = 'block';
      fileSelectedDiv.textContent = `✓ ${file.name} selected (${(file.size/1024).toFixed(1)} KB)`;
    } else {
      fileSelectedDiv.style.display = 'none';
    }
  }

  function toggleHoldUntilField(orderIndex, actionType) {
    const fileUploadSection = document.getElementById(`file-upload-section-${orderIndex}`);
    const holdUntilSection = document.getElementById(`hold-until-section-${orderIndex}`);
    const ownersInformedYes = document.getElementById(`owners-informed-yes-${orderIndex}`);
    const remarkSection = document.querySelector(`#order-${orderIndex} .remark-section`);

    if (actionType === 'Hold') {
      holdUntilSection.style.display = 'block';
      fileUploadSection.style.display = 'none';
      if (ownersInformedYes) ownersInformedYes.checked = false;
      if (remarkSection) remarkSection.style.display = 'none';
    } else {
      holdUntilSection.style.display = 'none';
      fileUploadSection.style.display = 'block';
      if (remarkSection) remarkSection.style.display = 'block';
    }
  }

  async function submitOrder(orderIndex, actionType) {
    const fileInput = document.getElementById(`file-${orderIndex}`);
    const ownersInformedRadio = document.querySelector(`input[name="owners-informed-${orderIndex}"]:checked`);
    const approveBtn = document.querySelector(`#order-${orderIndex} .submit-btn`);
    const holdBtn = document.querySelector(`#order-${orderIndex} .hold-btn`);
    const cancelBtn = document.querySelector(`#order-${orderIndex} .cancel-btn`);
    const holdUntilInput = document.getElementById(`hold-until-${orderIndex}`);
    const holdUntilRemark = document.getElementById(`hold-until-remark-${orderIndex}`);
    const remarkInput = document.getElementById(`remark-${orderIndex}`);
    const golaSelect = document.getElementById(`gola-${orderIndex}`);
    const successMessage = document.getElementById(`success-${orderIndex}`);
    const errorMessage = document.getElementById(`error-${orderIndex}`);

    successMessage.style.display = 'none';
    errorMessage.style.display = 'none';

    approveBtn.disabled = true;
    holdBtn.disabled = true;
    cancelBtn.disabled = true;

    toggleHoldUntilField(orderIndex, actionType);

    let submitData = {
      action: actionType,
      orderIndex: orderIndex,
      dealerName: orders[orderIndex].dealerName,
      timestamp: orders[orderIndex].timestamp,
      marketingPersonName: orders[orderIndex].marketingPersonName,
      location: orders[orderIndex].location,
      holdRemark: holdUntilRemark ? holdUntilRemark.value : '',
      remark: remarkInput ? remarkInput.value : '',
      golaOption: golaSelect ? golaSelect.value : '',
      crmName: orders[orderIndex].crmName,
      ownersInformed: ownersInformedRadio ? ownersInformedRadio.value : ''
    };

    try {
      if (actionType === 'Approve') {
        approveBtn.textContent = 'Converting & Approving...';
        if (!golaSelect.value) { alert('Please select a Gola Option before proceeding.'); throw new Error('Gola Option is required'); }
        if (!fileInput.files.length) { alert('Please attach a file before approving.'); throw new Error('File is required for approval'); }
        if (!ownersInformedRadio) { alert('Please select the owners informed status for approval.'); throw new Error('Owner informed status required'); }
        if (!remarkInput.value.trim()) { alert('Please provide a remark for approval.'); throw new Error('Remark is required for approval'); }

        const file = fileInput.files[0];
        const fileBase64 = await fileToBase64(file);
        submitData.file = {
          name: file.name,
          type: file.type,
          size: file.size,
          base64: fileBase64
        };

      } else if (actionType === 'Hold') {
        holdBtn.textContent = 'Holding...';
        if (!holdUntilInput.value || !holdUntilRemark.value) {
          alert('Please provide a "Hold Until" date and remark.');
          throw new Error('Hold details missing');
        }
        if (!ownersInformedRadio) {
          alert('Please select the owners informed status for holding the order.');
          throw new Error('Owner informed status required');
        }
        submitData.holdUntil = holdUntilInput.value;

      } else if (actionType === 'Cancel') {
        cancelBtn.textContent = 'Cancelling...';
        if (!remarkInput.value.trim()) { alert('Please provide a remark for cancellation.'); throw new Error('Remark is required for cancellation'); }
      }

      console.log('Submitting order data:', {
        ...submitData,
        file: submitData.file ? { ...submitData.file, base64: submitData.file.base64.substring(0, 50) + '...' } : undefined
      });

      await postData(submitData);

      successMessage.style.display = 'block';
      setTimeout(() => { successMessage.style.display = 'none'; }, 4000);

      // Reset
      if (fileInput) fileInput.value = '';
      const fs = document.getElementById(`file-selected-${orderIndex}`);
      if (fs) fs.style.display = 'none';
      if (ownersInformedRadio) ownersInformedRadio.checked = false;
      if (holdUntilInput) holdUntilInput.value = '';
      if (holdUntilRemark) holdUntilRemark.value = '';
      if (remarkInput) remarkInput.value = '';
      const holdSec = document.getElementById(`hold-until-section-${orderIndex}`);
      if (holdSec) holdSec.style.display = 'none';
      const fuSec = document.getElementById(`file-upload-section-${orderIndex}`);
      if (fuSec) fuSec.style.display = 'block';
      const rSec = document.querySelector(`#order-${orderIndex} .remark-section`);
      if (rSec) rSec.style.display = 'block';

    } catch (error) {
      console.error('Error submitting order:', error);
      errorMessage.textContent = `Error: ${error.message}`;
      errorMessage.style.display = 'block';
      setTimeout(() => { errorMessage.style.display = 'none'; }, 5000);
    } finally {
      approveBtn.disabled = false;
      holdBtn.disabled = false;
      cancelBtn.disabled = false;
      approveBtn.textContent = 'Approve';
      holdBtn.textContent = 'Hold';
      cancelBtn.textContent = 'Cancel';
    }
  }

  async function postData(data) {
    try {
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      // no-cors: assume success
      setTimeout(fetchOrders, 1000);
    } catch (error) {
      console.error('Network error during submission:', error);
      throw error;
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    fetchOrders();
    setInterval(fetchOrders, 10 * 60 * 1000); // every 10 minutes
  });

  window.addEventListener('beforeunload', function(){
    if (countdownInterval) clearInterval(countdownInterval);
  });
</script>

<!-- Keep this include the same; it will only be applied in view mode -->
<script src="js/viewOnly.js"></script>
</body>
</html>
