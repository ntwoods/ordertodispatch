<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders – Final / Additional Sales Orders</title>
  <style>
    :root{
      --bg:#f6f9ff;
      --bg-alt:#eef4ff;
      --card:#ffffff;
      --ink:#0b2545;
      --muted:#5b7aa6;
      --primary:#1f6feb;
      --primary-600:#1a61cf;
      --primary-700:#184ea7;
      --ring:#b3d1ff;
      --ok:#12a150;
      --warn:#eb8a1f;
      --err:#d13b3b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg,var(--bg),var(--bg-alt)); color:var(--ink);
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(circle at 30% 30%, #7fb3ff, #2d6cdf); box-shadow:0 6px 16px rgba(31,111,235,.35)}
    h1{font-size:clamp(18px,2.6vw,26px); margin:0}
    .sub{color:var(--muted); font-size:12px}

    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{border:0; background:var(--primary); color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; letter-spacing:.2px; box-shadow:0 6px 14px rgba(31,111,235,.35); transition:.18s transform,.18s box-shadow,.18s background}
    .btn:hover{transform:translateY(-1px); background:var(--primary-600); box-shadow:0 8px 18px rgba(31,111,235,.4)}
    .btn:active{transform:translateY(0)}
    .btn.secondary{background:#e6efff; color:var(--primary-700); box-shadow:none}
    .btn.secondary:hover{background:#d8e6ff}
    .btn.ghost{background:transparent; color:var(--primary-700); box-shadow:none}

    .meta{font-size:12px; color:var(--muted)}

    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:18px}

    .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(10,37,69,.07); border:1px solid #e7efff; display:flex; flex-direction:column; min-height:280px; overflow:hidden}
    .card .head{display:flex; align-items:center; justify-content:space-between; padding:16px 16px 0 16px}
    .badge{font-size:11px; font-weight:700; color:#184ea7; background:#e9f1ff; border:1px solid #d3e3ff; padding:6px 10px; border-radius:999px}
    .title{font-size:15px; font-weight:800; color:#123; margin:0}
    .body{padding:12px 16px 16px 16px; display:grid; grid-template-columns:1fr; gap:10px}

    .kv{display:flex; gap:10px; align-items:flex-start}
    .kv .k{min-width:120px; font-size:12px; color:var(--muted)}
    .kv .v{font-weight:600; font-size:13px; word-break:break-word}

    .split{margin:6px 16px; height:1px; background:#eaf1ff}

    .actions{display:flex; flex-direction:column; gap:8px; padding:0 16px 16px 16px}
    .link-btn{display:inline-flex; align-items:center; gap:8px; font-size:12px; font-weight:700; color:var(--primary-700); background:#eaf2ff; border:1px solid #d8e6ff; padding:8px 10px; border-radius:10px; text-decoration:none; justify-content:center}
    .link-btn:hover{background:#dfeaff}

    .filebox{display:flex; flex-direction:column; gap:6px}
    .filebox label{font-size:12px; color:var(--muted)}
    input[type="file"]{border:1px dashed #cfe0ff; padding:10px; border-radius:12px; background:#f6faff}

    .submit-row{display:flex; gap:8px; align-items:center; justify-content:space-between}
    .submit-row .btn{width:100%; font-size:12px; padding:10px}
    /* Hide all elements marked as edit-only when in view mode */
    .view-mode [data-edit-only] {
      display: none !important;
    }
    /* === Countdown styles === */
    .countdown {
      font-weight: 800;
      color: var(--err);
      font-variant-numeric: tabular-nums;
    }
    .badge.deadline {
      color: #b02525;
      background: #ffeaea;
      border-color: #ffd0d0;
    }
    .badge.overdue {
      color: #fff;
      background: #d13b3b;
      border-color: #b62f2f;
    }
    
    

    .empty, .error, .loader{background:#fff; border:1px dashed #d8e6ff; color:var(--muted); padding:18px; border-radius:14px; text-align:center}
    .loader{display:flex; gap:10px; align-items:center; justify-content:center}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--primary); box-shadow:0 0 0 0 rgba(31,111,235,.4); animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%{transform:scale(.9); box-shadow:0 0 0 0 rgba(31,111,235,.5)}70%{transform:scale(1); box-shadow:0 0 0 10px rgba(31,111,235,0)}100%{transform:scale(.9); box-shadow:0 0 0 0 rgba(31,111,235,0)}}

    .footer-note{margin-top:24px; text-align:center; font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Orders Dashboard</h1>
          <div class="sub">White & Blue card UI · Auto refresh every 5 minutes</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="refreshBtn" title="Refresh now">Refresh</button>
        <button class="btn secondary" id="toggleAutoBtn" title="Toggle auto refresh">Auto: On</button>
        <span class="meta" id="lastUpdated">Last updated: —</span>
      </div>
    </header>

    <main id="content">
      <div class="loader" id="loader" role="status" aria-live="polite">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <span>Loading orders…</span>
      </div>
      <div class="grid" id="grid" hidden></div>
      <div class="empty" id="empty" hidden>No orders found.</div>
      <div class="error" id="error" hidden>Could not load orders. Please try again.</div>
    </main>
  </div>

<script>
  function getSearchParam(name) {
    const url = new URL(window.location.href);
    const v = url.searchParams.get(name);
    return v ? v.trim() : "";
    }
  const MODE = getSearchParam('mode'); // optional: "view" or default
  const CRM  = getSearchParam('crm');  // e.g. "Km Kalpana"
  const IS_VIEW_MODE = (MODE || '').toLowerCase() === 'view';
  if (IS_VIEW_MODE) document.documentElement.classList.add('view-mode');  

  const API_BASE = "https://script.google.com/macros/s/AKfycbzIg93-NvjqrLEgr6zmk-weztixnBf1JiMko0wNkly9IQvdkU2LiUtgkbDcy99kCYZwQw/exec";
  const qs = new URLSearchParams();
  if (CRM) qs.set('crm', CRM);
  const API_URL = qs.toString() ? `${API_BASE}?${qs.toString()}` : API_BASE;  

  const el = sel => document.querySelector(sel);
  const grid = el('#grid');
  const loader = el('#loader');
  const emptyState = el('#empty');
  const errState = el('#error');

  let auto = true;
  let timer = null;
  let fetching = false;

  function setLoading(on){
    loader.hidden = !on; grid.hidden = on;
    emptyState.hidden = true; errState.hidden = true;
  }
  function setError(msg){
    errState.textContent = msg || 'Could not load orders. Please try again.';
    errState.hidden = false; loader.hidden = true; grid.hidden = true; emptyState.hidden = true;
  }
  function setEmpty(){
    emptyState.hidden = false; loader.hidden = true; grid.hidden = true; errState.hidden = true;
  }

  const LABEL_MAP = {
    DealerName: 'Dealer Name',
    MarketingPerson: 'Marketing Person',
    Location: 'Location',
    CRMName: 'CRM Name',
    FinalOrder: 'Final Order URL',
    URLs: 'Additional Order URL',
    keyTimestamp: 'Key Timestamp'
  };

  function prettyLabel(key){
    if(LABEL_MAP[key]) return LABEL_MAP[key];
    return key.replace(/_/g,' ')
              .replace(/([a-z])([A-Z])/g,'$1 $2')
              .replace(/^./, c => c.toUpperCase());
  }

  function isTruthyUrl(v){ return typeof v === 'string' && v.trim() !== ''; }

  function createKV(k, v){
    const row = document.createElement('div'); row.className = 'kv';
    const kEl = document.createElement('div'); kEl.className = 'k'; kEl.textContent = prettyLabel(k);
    const vEl = document.createElement('div'); vEl.className = 'v'; vEl.textContent = (v ?? '')+'';
    row.append(kEl, vEl); return row;
  }

function createCard(order, index){
  const card = document.createElement('article'); card.className = 'card';

  const head = document.createElement('div'); head.className = 'head';
  const title = document.createElement('h3'); title.className = 'title';
  title.textContent = order.DealerName || `Order #${index+1}`;
  const badge = document.createElement('div'); badge.className = 'badge';
  badge.textContent = order.CRMName ? `CRM: ${order.CRMName}` : 'Order';
  head.append(title, badge);

  const body = document.createElement('div'); body.className = 'body';
  const HIDDEN_KEYS = new Set(['FinalOrder','URLs','Key', 'Timestamp']);
  Object.keys(order).forEach(key => {
    if (!HIDDEN_KEYS.has(key)) body.appendChild(createKV(key, order[key]));
  });

  const actions = document.createElement('div'); actions.className='actions';

  const finalUrl = order.FinalOrder || '';
  const addlUrl = order.URLs || '';
  const hasFinal = isTruthyUrl(finalUrl);
  const hasAddl = !hasFinal && isTruthyUrl(addlUrl);

  if(hasFinal){
    const a = document.createElement('a'); a.href = finalUrl; a.target='_blank'; a.className='link-btn'; a.textContent = 'View Final Order';
    actions.appendChild(a);
  } else if(hasAddl){
    const a = document.createElement('a'); a.href = addlUrl; a.target='_blank'; a.className='link-btn'; a.textContent = 'View Additional Order';
    actions.appendChild(a);
  }

  // --- EDIT-ONLY: file input box ---
  const fileBox = document.createElement('div'); fileBox.className='filebox';
  fileBox.setAttribute('data-edit-only','');               // <-- hide in view mode
  const fileLabel = document.createElement('label'); fileLabel.textContent = 'Attach file'; fileLabel.setAttribute('for', `file-${index}`);
  const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.id=`file-${index}`;
  fileBox.append(fileLabel, fileInput);
  actions.appendChild(fileBox);

  // --- EDIT-ONLY: submit row + button ---
  const submitRow = document.createElement('div'); submitRow.className='submit-row';
  submitRow.setAttribute('data-edit-only','');             // <-- hide in view mode
  const submitBtn = document.createElement('button'); submitBtn.className='btn';
  if(hasFinal){ submitBtn.textContent = 'Submit Final Sales Order'; submitBtn.dataset.kind = 'final'; }
  else if(hasAddl){ submitBtn.textContent = 'Submit Additional Sales Order'; submitBtn.dataset.kind = 'additional'; }
  else { submitBtn.textContent = 'Submit Sales Order'; submitBtn.dataset.kind = 'generic'; }
  submitRow.appendChild(submitBtn);
  actions.appendChild(submitRow);

  // Only wire up submit logic when NOT in view mode
  if (!IS_VIEW_MODE) {
    submitBtn.addEventListener('click', async () => {
      try{
        const file = fileInput.files?.[0] || null;
        if(!file && !confirm('No file selected. Submit without attachment?')) return;

        submitBtn.disabled = true; submitBtn.textContent = 'Submitting…';

        // Build payload
        const payload = { ...order, Key: order.Key };
        let actionVal = 'submitOrder';
        if(submitBtn.dataset.kind === 'final') actionVal = 'finalSalesOrder';
        else if(submitBtn.dataset.kind === 'additional') actionVal = 'additionalSalesOrder';

        const bodyData = { action: actionVal, payload };

        if(file){
          // Convert file to base64
          const base64Data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
          bodyData.file = {
            fileName: file.name,
            fileType: file.type,
            fileData: base64Data
          };
        }

        await fetch(API_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(bodyData)
        });
        alert('Submitted successfully!');
      }catch(err){
        console.error(err);
        alert('Submission failed: '+err.message);
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = submitBtn.dataset.kind === 'final' ? 'Submit Final Sales Order' :
                                (submitBtn.dataset.kind === 'additional' ? 'Submit Additional Sales Order' : 'Submit Sales Order');
      }
    });
  }

  card.append(head, body, document.createElement('div'), actions);
  return card;
}
  
async function fetchOrders(){
  if(fetching) return;
  fetching = true; setLoading(true);
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    render(data);
  }catch(err){
    console.error(err); setError(err.message || 'Failed to fetch');
  }finally{
    fetching = false; setLoading(false);
  }
}

  function render(rows){
    grid.innerHTML = '';
    if(!Array.isArray(rows) || rows.length===0){ setEmpty(); return; }
    rows.forEach((row,i)=> grid.appendChild(createCard(row,i)));
    grid.hidden = false; emptyState.hidden = true; errState.hidden = true;
  }

  function startAuto(){ clearInterval(timer); timer = setInterval(fetchOrders, 5*60*1000); }
  function stopAuto(){ clearInterval(timer); }

  // Initial load
  fetchOrders();
  startAuto();
</script>
<script src="js/viewOnly.js"></script>
</body>
</html>
