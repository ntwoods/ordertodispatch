<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders – Final / Additional Sales Orders</title>
  <style>
    :root{
      --bg:#f6f9ff;
      --bg-alt:#eef4ff;
      --card:#ffffff;
      --ink:#0b2545;
      --muted:#5b7aa6;
      --primary:#1f6feb;
      --primary-600:#1a61cf;
      --primary-700:#184ea7;
      --ring:#b3d1ff;
      --ok:#12a150;
      --warn:#eb8a1f;
      --err:#d13b3b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg,var(--bg),var(--bg-alt)); color:var(--ink);
    }
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(circle at 30% 30%, #7fb3ff, #2d6cdf); box-shadow:0 6px 16px rgba(31,111,235,.35)}
    h1{font-size:clamp(18px,2.6vw,26px); margin:0}
    .sub{color:var(--muted); font-size:12px}

    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{border:0; background:var(--primary); color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; letter-spacing:.2px; box-shadow:0 6px 14px rgba(31,111,235,.35); transition:.18s transform,.18s box-shadow,.18s background}
    .btn:hover{transform:translateY(-1px); background:var(--primary-600); box-shadow:0 8px 18px rgba(31,111,235,.4)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{background:var(--muted); box-shadow:none; cursor:wait; transform:none;}
    .btn.secondary{background:#e6efff; color:var(--primary-700); box-shadow:none}
    .btn.secondary:hover{background:#d8e6ff}
    .btn.ghost{background:transparent; color:var(--primary-700); box-shadow:none}

    .meta{font-size:12px; color:var(--muted)}

    .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:18px}

    .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(10,37,69,.07); border:1px solid #e7efff; display:flex; flex-direction:column; min-height:280px; overflow:hidden}
    .card .head{display:flex; align-items:center; justify-content:space-between; padding:16px 16px 0 16px}
    .badge{font-size:11px; font-weight:700; color:#184ea7; background:#e9f1ff; border:1px solid #d3e3ff; padding:6px 10px; border-radius:999px}
    .title{font-size:15px; font-weight:800; color:#123; margin:0}
    .body{padding:12px 16px 16px 16px; display:grid; grid-template-columns:1fr; gap:10px}

    .kv{display:flex; gap:10px; align-items:flex-start}
    .kv .k{min-width:120px; font-size:12px; color:var(--muted)}
    .kv .v{font-weight:600; font-size:13px; word-break:break-word}

    .split{margin:6px 16px; height:1px; background:#eaf1ff}

    .actions{display:flex; flex-direction:column; gap:8px; padding:0 16px 16px 16px}
    .link-btn{display:inline-flex; align-items:center; gap:8px; font-size:12px; font-weight:700; color:var(--primary-700); background:#eaf2ff; border:1px solid #d8e6ff; padding:8px 10px; border-radius:10px; text-decoration:none; justify-content:center}
    .link-btn:hover{background:#dfeaff}

    .filebox{display:flex; flex-direction:column; gap:6px}
    .filebox label{font-size:12px; color:var(--muted)}
    input[type="file"]{border:1px dashed #cfe0ff; padding:10px; border-radius:12px; background:#f6faff}

    .submit-row{display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:space-between}
    .submit-row .btn{width:100%; font-size:12px; padding:10px}

    .empty, .error, .loader{background:#fff; border:1px dashed #d8e6ff; color:var(--muted); padding:18px; border-radius:14px; text-align:center}
    .loader{display:flex; gap:10px; align-items:center; justify-content:center}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--primary); box-shadow:0 0 0 0 rgba(31,111,235,.4); animation:pulse 1.4s infinite}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes pulse{0%{transform:scale(.9); box-shadow:0 0 0 0 rgba(31,111,235,.5)}70%{transform:scale(1); box-shadow:0 0 0 10px rgba(31,111,235,0)}100%{transform:scale(.9); box-shadow:0 0 0 0 rgba(31,111,235,0)}}

    .status-message {
      font-size: 12px; font-weight: 600; padding: 10px; border-radius: 10px; margin-top: 4px;
      text-align: center; border: 1px solid transparent; transition: all 0.3s ease;
      min-height: 20px; /* Ensure space for message */
    }
    .status-message.success { color: var(--ok); background: #e0f8e9; border-color: #c0f0d1; }
    .status-message.failure { color: var(--err); background: #ffebeb; border-color: #ffc6c6; }

    .footer-note{margin-top:24px; text-align:center; font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Orders Dashboard</h1>
          <div class="sub">White & Blue card UI · Auto refresh every 5 minutes</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="refreshBtn" title="Refresh now">Refresh</button>
        <button class="btn secondary" id="toggleAutoBtn" title="Toggle auto refresh">Auto: On</button>
        <span class="meta" id="lastUpdated">Last updated: —</span>
      </div>
    </header>

    <main id="content">
      <div class="loader" id="loader" role="status" aria-live="polite">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        <span>Loading orders…</span>
      </div>
      <div class="grid" id="grid" hidden></div>
      <div class="empty" id="empty" hidden>No orders found.</div>
      <div class="error" id="error" hidden>Could not load orders. Please try again.</div>
    </main>
  </div>

<script>
  // Ensure the API URL is correct and deployed for the script below.
  const API_URL = "https://script.google.com/macros/s/AKfycbyMeNpAlA_IFpQ5F7Uif9k7dOuYheDkO9Qrcs4nKJkxB8VdrvK4HJCUH54Vc6u5Kl-uLQ/exec";

  const el = sel => document.querySelector(sel);
  const grid = el('#grid');
  const loader = el('#loader');
  const emptyState = el('#empty');
  const errState = el('#error');
  const lastUpdatedEl = el('#lastUpdated');
  const refreshBtn = el('#refreshBtn');
  const toggleAutoBtn = el('#toggleAutoBtn');

  let auto = true;
  let timer = null;
  let fetching = false;

  function setLoading(on){
    loader.hidden = !on; 
    if(on) { 
      grid.hidden = true; 
      emptyState.hidden = true; 
      errState.hidden = true; 
    }
  }
  function setError(msg){
    errState.textContent = msg || 'Could not load orders. Please try again.';
    errState.hidden = false; loader.hidden = true; grid.hidden = true; emptyState.hidden = true;
  }
  function setEmpty(){
    emptyState.hidden = false; loader.hidden = true; grid.hidden = true; errState.hidden = true;
  }

  const LABEL_MAP = {
    DealerName: 'Dealer Name',
    MarketingPerson: 'Marketing Person',
    Location: 'Location',
    CRMName: 'CRM Name',
    FinalOrder: 'Final Order URL',
    URLs: 'Additional Order URL',
    Timestamp: 'Order Timestamp',
    Key: 'Key Timestamp (Match Field)' // Key is the field with the ISO timestamp
  };

  function prettyLabel(key){
    if(LABEL_MAP[key]) return LABEL_MAP[key];
    return key.replace(/_/g,' ')
              .replace(/([a-z])([A-Z])/g,'$1 $2')
              .replace(/^./, c => c.toUpperCase());
  }

  function isTruthyUrl(v){ return typeof v === 'string' && v.trim() !== ''; }

  function createKV(k, v){
    const row = document.createElement('div'); row.className = 'kv';
    const kEl = document.createElement('div'); kEl.className = 'k'; kEl.textContent = prettyLabel(k);
    const vEl = document.createElement('div'); vEl.className = 'v'; vEl.textContent = (v ?? '')+'';
    row.append(kEl, vEl); return row;
  }

  function createCard(order, index){
    const card = document.createElement('article'); card.className = 'card';

    const head = document.createElement('div'); head.className = 'head';
    const title = document.createElement('h3'); title.className = 'title';
    title.textContent = order.DealerName || `Order #${index+1}`;
    const badge = document.createElement('div'); badge.className = 'badge';
    badge.textContent = order.CRMName ? `CRM: ${order.CRMName}` : 'Order';
    head.append(title, badge);

    // Body
    const body = document.createElement('div'); body.className = 'body';
    // Only display fields relevant to the user's view, except the key which is for the backend
    const DISPLAY_KEYS = ['DealerName', 'MarketingPerson', 'Location', 'CRMName', 'Timestamp']; 
    DISPLAY_KEYS.forEach(key => {
      if (order[key]) body.appendChild(createKV(key, order[key]));
    });

    // Actions
    const actions = document.createElement('div'); actions.className='actions';

    const finalUrl = order.FinalOrder || '';
    const addlUrl = order.URLs || '';
    const hasFinal = isTruthyUrl(finalUrl);
    const hasAddl = isTruthyUrl(addlUrl); // Only check if there's any URL in the Additional field

    if(hasFinal){
      const a = document.createElement('a'); a.href = finalUrl; a.target='_blank'; a.className='link-btn'; a.textContent = 'View Final Order'; 
      actions.appendChild(a);
    } 
    if(hasAddl){
      // This is slightly complex since addlUrl could be comma-separated, but we'll link to the first one for simplicity.
      const firstUrl = addlUrl.split(',')[0].trim();
      const a = document.createElement('a'); a.href = firstUrl; a.target='_blank'; a.className='link-btn'; a.textContent = 'View Additional Order(s)'; 
      actions.appendChild(a);
    }
    
    // Hidden key for reference
    const keyRef = document.createElement('div'); 
    keyRef.className = 'meta'; 
    keyRef.textContent = `Matching Key: ${order.Key}`;
    keyRef.style.display = 'none'; // Keep this hidden from the user
    actions.appendChild(keyRef);

    const fileBox = document.createElement('div'); fileBox.className='filebox';
    const fileLabel = document.createElement('label'); fileLabel.textContent = 'Attach Dispatch/Sales Order File'; fileLabel.setAttribute('for', `file-${index}`);
    const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.id=`file-${index}`;
    fileBox.append(fileLabel, fileInput);
    actions.appendChild(fileBox);

    const submitRow = document.createElement('div'); submitRow.className='submit-row';
    const submitBtn = document.createElement('button'); submitBtn.className='btn';
    
    let actionKind;
    if(order.FinalOrder) { 
      submitBtn.textContent = 'Submit Final Sales Order'; actionKind = 'final'; 
    } else if(order.URLs) { 
      submitBtn.textContent = 'Submit Additional Sales Order'; actionKind = 'additional'; 
    } else { 
      submitBtn.textContent = 'Submit Sales Order'; actionKind = 'generic'; 
    }
    submitBtn.dataset.kind = actionKind;

    const statusMsg = document.createElement('div'); statusMsg.className = 'status-message';
    
    submitBtn.addEventListener('click', async () => {
      try{
        statusMsg.textContent = '';
        const file = fileInput.files?.[0] || null;
        
        // Use custom modal or simple logic instead of confirm()
        if(!file) {
          if (!window.confirm('No file selected. Submit without attachment?')) return;
        }

        submitBtn.disabled = true; submitBtn.textContent = 'Submitting…';
        
        // *** FIX: Use the 'Key' field which contains the ISO timestamp from doGet ***
        const keyVal = order.Key; 
        
        const payload = { ...order, Key: keyVal };

        const bodyData = {
          action: submitBtn.dataset.kind === 'final' ? 'submitFinalOrder' :
                  (submitBtn.dataset.kind === 'additional' ? 'submitAdditionalOrder' : 'submitOrder'),
          payload
        };

        const fd = new FormData();
        fd.append('data', JSON.stringify(bodyData));
        if(file) fd.append('file', file, file.name);

        // Fetch is done with method: 'POST'
        const res = await fetch(API_URL, { method:'POST', body: fd });
        
        // Google Apps Script usually returns an HTML response when mode is 'no-cors'
        // but since we are sending JSON response now, we can try to parse it.
        // If the script is deployed as 'Web App' and set to execute as 'Me', 
        // the response might not be readable due to CORS headers unless deployed 
        // with specific configuration or used inside a Google environment.
        // Assuming a successful 200/302 response for now due to the form data.
        
        // Since the script now returns JSON, let's try to read it.
        // NOTE: If running in an iframe, fetch might fail with no-cors. 
        // If it fails, we fall back to assuming success after a delay.
        
        let result = { success: true, message: 'Submitted successfully!' };
        try {
            const jsonResult = await res.json();
            if (jsonResult.ok === false) {
                throw new Error(jsonResult.error || 'Server reported failure.');
            }
            // Optional: You could refresh the view here if you want immediate feedback, but the script runs an automatic timer.
        } catch (e) {
            // Fallback for non-JSON or unreadable response (common in no-cors)
            console.warn("Could not read server response (CORS/No-CORS issue). Assuming success if no HTTP error.");
            if (!res.ok) throw new Error('HTTP request failed.');
        }


        statusMsg.textContent = '✅ Submission successful!';
        statusMsg.classList.remove('failure');
        statusMsg.classList.add('success');
        
      }catch(err){
        console.error('Submission failed:', err);
        statusMsg.textContent = `❌ Submission failed: ${err.message || 'Check console.'}`;
        statusMsg.classList.remove('success');
        statusMsg.classList.add('failure');
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = submitBtn.dataset.kind === 'final' ? 'Submit Final Sales Order' :
                                (submitBtn.dataset.kind === 'additional' ? 'Submit Additional Sales Order' : 'Submit Sales Order');
        setTimeout(() => {
          statusMsg.textContent = '';
          fetchOrders(); // Force a refresh after submission attempt
        }, 3000);
      }
    });

    submitRow.prepend(statusMsg);
    submitRow.appendChild(submitBtn);
    actions.appendChild(submitRow);

    card.append(head, body, document.createElement('div'), actions);
    return card;
  }

  
  async function fetchOrders(){
    if(fetching) return;
    fetching = true; setLoading(true);
    refreshBtn.disabled = true;
    try{
      const res = await fetch(API_URL + '?action=getOrders', { cache:'no-store' }); // Added a param for clarity
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      render(data);
      lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    }catch(err){
      console.error(err); setError('Failed to fetch orders: '+ (err.message || 'Unknown error'));
    }finally{
      fetching = false; setLoading(false);
      refreshBtn.disabled = false;
    }
  }

  function render(rows){
    grid.innerHTML = '';
    if(!Array.isArray(rows) || rows.length===0){ setEmpty(); return; }
    rows.forEach((row,i)=> grid.appendChild(createCard(row,i)));
    grid.hidden = false; emptyState.hidden = true; errState.hidden = true;
  }

  function startAuto(){ clearInterval(timer); timer = setInterval(fetchOrders, 5*60*1000); }
  function stopAuto(){ clearInterval(timer); }

  // Event Listeners
  refreshBtn.addEventListener('click', fetchOrders);
  toggleAutoBtn.addEventListener('click', () => {
    auto = !auto;
    if(auto){ startAuto(); toggleAutoBtn.textContent = 'Auto: On'; }
    else { stopAuto(); toggleAutoBtn.textContent = 'Auto: Off'; }
  });

  // Initial load
  fetchOrders();
  startAuto();
</script>
</body>
</html>
