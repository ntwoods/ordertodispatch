<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inform The Dealer About Dispatch Details</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
  <style>
.dealer-type-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.25rem 0.75rem; /* px-3 py-1 */
  border-radius: 9999px; /* rounded-full */
  font-size: 0.75rem; /* text-xs */
  font-weight: 600; /* font-semibold */
  color: white; /* text-white */
  margin-left: 0.5rem; /* ml-2 */
  white-space: nowrap; /* Prevent text wrapping */
  z-index: 30;
}
.bg-red-500 { background-color: #ef4444; }
.bg-yellow-500 { background-color: #f59e0b; }
.bg-green-500 { background-color: #22c55e; }
.bg-gray-500 { background-color: #6b7280; }

body {
    font-family: Arial, sans-serif;
    background-color: #e0f2f7; /* Light blue background */
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

h1 {
    text-align: center;
    color: #01579b; /* Darker blue for heading */
    margin-bottom: 30px;
}

.loading {
    text-align: center;
    font-size: 18px;
    color: #0277bd; /* Medium blue for loading */
}

.error {
    background-color: #bbdefb; /* Light blue for error background */
    color: #c62828; /* Red for error text */
    padding: 15px;
    border-radius: 5px;
    text-align: center;
    margin-bottom: 20px;
}

.order-card {
    background-color: #e3f2fd; /* Lighter blue for card background */
    border: 1px solid #90caf9; /* Light blue border */
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
}

.order-card:hover {
    transform: translateY(-5px);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.order-header h2 {
    color: #01579b; /* Darker blue for order title */
    margin: 0;
}

.order-header .status {
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: bold;
    color: white;
}

.order-header .status.Pending {
    background-color: #ffb300; /* Amber for pending */
}

.order-header .status.Dispatched {
    background-color: #43a047; /* Green for dispatched */
}

.order-details p {
    margin-bottom: 8px;
    color: #37474f; /* Dark grey for text */
}

.order-details p strong {
    color: #1976d2; /* Blue for strong text */
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: flex-end; /* Align buttons to the right */
}

.button-group button {
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.button-group button.dispatch-btn {
    background-color: #0288d1; /* Light blue for dispatch button */
    color: white;
}

.button-group button.dispatch-btn:hover {
    background-color: #039be5; /* Lighter blue on hover */
}

.button-group button.copy-btn {
    background-color: #546e7a; /* Blue-grey for copy button */
    color: white;
}

.button-group button.copy-btn:hover {
    background-color: #78909c; /* Lighter blue-grey on hover */
}

.button-group button:disabled {
    background-color: #bdbdbd; /* Light grey for disabled */
    cursor: not-allowed;
}
  </style>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-10 text-center">
      Inform The Dealer About Dispatch Details
    </h1>

    <div id="loader" class="text-center py-10">
      <p class="text-lg text-gray-700">Loading orders...</p>
    </div>

    <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxMxIzOQmHv3LPTh6ca6i5uuguyH615cnjA5emEGNT0rmWpJlnrcg-KWNVP1DORkkcX/exec";
    let globalOrders = [];

    async function fetchOrders() {
      document.getElementById('loader').classList.remove('hidden');
      document.getElementById('orders-container').innerHTML = ''; // Clear existing orders

      try {
        const urlParams = new URLSearchParams(window.location.search);
        const crmName = urlParams.get('crm');

        if (!crmName) {
            console.error('CRM name is missing in URL. Please provide a CRM name (e.g., ?crm=YourCRMName).');
            document.getElementById("loader").innerHTML = `
                <div class="text-center py-10">
                    <p class="text-red-600 font-bold text-xl">Error: CRM name is missing in URL!</p>
                    <p class="text-gray-700">Please provide a CRM name in the URL (e.g., <code class="bg-gray-200 p-1 rounded">?crm=YourCRMName</code>).</p>
                </div>
            `;
            return;
        }

        const response = await fetch(`${API_URL}?crm=${encodeURIComponent(crmName)}`);
        const result = await response.json();

        if (result.status === "success") {
          globalOrders = result.data.filter(order => order.status === "Dispatched");
          renderOrders(globalOrders);
        } else {
          console.error("Failed to fetch orders:", result.message);
          document.getElementById('orders-container').innerHTML = `<p class="text-center text-red-500">Error: ${result.message}</p>`;
        }
      } catch (error) {
        console.error("Error fetching orders:", error);
        document.getElementById('orders-container').innerHTML = `<p class="text-center text-red-500">Failed to load orders. Please try again.</p>`;
      } finally {
        document.getElementById('loader').classList.add('hidden');
      }
    }

    function renderOrders(orders) {
      const container = document.getElementById("orders-container");
      container.innerHTML = ""; // Clear previous cards

      if (orders.length === 0) {
        container.innerHTML = `
          <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-10">
            <p class="text-lg text-gray-700">No dispatched orders to inform dealers about.</p>
          </div>
        `;
        return;
      }

      orders.forEach((order, index) => {
        const card = document.createElement("div");
        card.className = "order-card bg-white p-6 rounded-lg shadow-md";
        card.innerHTML = `
          <div class="order-header">
            <h2 class="text-xl font-bold">${order.dealerName || 'N/A'}
                ${order.dealerType ? `<div class="dealer-type-badge ${getDealerBadgeColor(order.dealerType)}">${order.dealerType}</div>` : ''}
            </h2>
            <span class="status ${order.status}">${order.status || 'N/A'}</span>
          </div>
          <div class="order-details text-gray-700">
            <p><strong>Marketing Person:</strong> ${order.marketingPersonName || 'N/A'}</p>
            <p><strong>Location:</strong> ${order.location || 'N/A'}</p>
            <p><strong>CRM Name:</strong> ${order.crmName || 'N/A'}</p>
            <p><strong>Concerned Owner:</strong> ${order.concernedOwner || 'N/A'}</p>
            <p><strong>Order Time:</strong> ${formatDateToDDMMMYYYY(order.timestamp)}</p>
            <p><strong>Tentative Dispatch:</strong> ${order.dispatchDate || 'N/A'}</p>
            <p><strong>Expected Delivery Date:</strong> ${order.expectedDeliveryDate || 'N/A'}</p>
            <p><strong>Vehicle No:</strong> <input type="text" id="vehicleNo-${index}" value="${order.vehicleNo || ''}" class="p-1 border rounded w-full mt-1"></p>
            <p><strong>Freight Amt:</strong> <input type="text" id="freight-${index}" value="${order.freight || ''}" class="p-1 border rounded w-full mt-1"></p>
            <p><strong>Driver Name:</strong> <input type="text" id="driverName-${index}" value="${order.driverName || ''}" class="p-1 border rounded w-full mt-1"></p>
            <p><strong>Driver Mobile:</strong> <input type="text" id="driverMob-${index}" value="${order.driverMob || ''}" class="p-1 border rounded w-full mt-1"></p>
            <p><strong>Invoice URL:</strong> <input type="text" id="invoiceUrl-${index}" value="${order.invoiceUrl || ''}" class="p-1 border rounded w-full mt-1"></p>
            
            <p><strong>Remark:</strong> <input type="text" id="remark-${index}" required class="p-1 border rounded w-full mt-1" placeholder="Enter remark here"></p>

          </div>
          <div class="button-group">
            <button class="dispatch-btn py-2 px-4 rounded" onclick="submitOrder(${index})">
              <i class="fas fa-paper-plane mr-2"></i>Inform Dealer
            </button>
            <button class="copy-btn py-2 px-4 rounded" onclick="copyDispatchDetails(${index})">
              <i class="fas fa-copy mr-2"></i>Copy Details
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function getDealerBadgeColor(dealerType) {
        if (!dealerType) return 'bg-gray-500';
        switch (dealerType.toLowerCase()) {
            case 'red': return 'bg-red-500';
            case 'yellow': return 'bg-yellow-500';
            case 'green': return 'bg-green-500';
            default: return 'bg-gray-500';
        }
    }

    function formatDateToDDMMMYYYY(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      const options = { day: '2-digit', month: 'short', year: 'numeric' };
      return date.toLocaleDateString('en-GB', options).replace(/ /g, '-');
    }

    async function submitOrder(index) {
      const order = globalOrders[index];
      const button = document.querySelector(`#orders-container div:nth-child(${index + 1}) .dispatch-btn`);
      const originalText = button.innerHTML;

      const vehicleNo = document.getElementById(`vehicleNo-${index}`).value;
      const freight = document.getElementById(`freight-${index}`).value;
      const driverName = document.getElementById(`driverName-${index}`).value;
      const driverMob = document.getElementById(`driverMob-${index}`).value;
      const invoiceUrl = document.getElementById(`invoiceUrl-${index}`).value;
      const remark = document.getElementById(`remark-${index}`).value; // Get remark value

      if (!remark) {
          alert("Remark field is mandatory. Please fill it.");
          return;
      }

      button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...`;
      button.disabled = true;

      const payload = {
        timestamp: order.timestamp,
        vehicleNo: vehicleNo,
        freight: freight,
        driverName: driverName,
        driverMob: driverMob,
        invoiceUrl: invoiceUrl,
        remark: remark // Include remark in payload
      };

      try {
        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        setTimeout(() => {
          alert("Submitted successfully!");
          button.innerHTML = `<i class="fas fa-check mr-2"></i> Submitted ✓`;
          button.className = button.className.replace('dispatch-btn', 'bg-green-500 hover:bg-green-600');
          fetchOrders();
        }, 1000);

      } catch (err) {
        console.error('Submit error:', err);
        button.innerHTML = originalText;
        button.disabled = false;
        alert("Submission failed. Please try again.");
      }
    }

    function copyDispatchDetails(index) {
      const order = globalOrders[index];
      const vehicleNo = document.getElementById(`vehicleNo-${index}`).value;
      const freight = document.getElementById(`freight-${index}`).value;
      const driverName = document.getElementById(`driverName-${index}`).value;
      const driverMob = document.getElementById(`driverMob-${index}`).value;
      const invoiceUrl = document.getElementById(`invoiceUrl-${index}`).value;

      const details = `Expected Delivery Date: ${formatDateToDDMMMYYYY(order.expectedDeliveryDate)}
Dispatch Date & Time: ${formatDateToDDMMMYYYY(order.timestamp)}
Vehicle No: ${vehicleNo || 'N/A'}
Freight Amt: ${freight || 'N/A'}
Driver Name: ${driverName || 'N/A'}
Driver Mobile: ${driverMob || 'N/A'}
Invoice URL: ${invoiceUrl || 'N/A'}`;

      navigator.clipboard.writeText(details)
        .then(() => {
          alert('Dispatch details copied to clipboard!');
        })
        .catch(err => {
          console.error('Failed to copy dispatch details:', err);
          alert('Failed to copy dispatch details. Please copy manually.');
        });
    }

    // Initial fetch on page load
    document.addEventListener('DOMContentLoaded', fetchOrders);
  </script>
</body>
</html>
