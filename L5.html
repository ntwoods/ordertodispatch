<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inform The Dealer About Dispatch Details</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css"> <!-- Link to your custom style.css -->
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div id="loader" class="text-center text-xl text-blue-600 font-semibold">Loading orders...</div>
  <div id="ordersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6 hidden"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwUr0UhENK6RGtdvYMC6-V0Khwb3kibKP4SLXC4nzL6Hm4idr6P-Olx4XTWvgZ_e2xk-Q/exec";

    let globalOrders = [];
function formatDateToDDMMMYYYY(dateStr) {
  const date = new Date(dateStr);
  const options = { day: '2-digit', month: 'short', year: 'numeric' };
  return date.toLocaleDateString('en-GB', options).replace(/ /g, '-');
}


function openMultipleDocuments(urlString, index) {
    // Split the URLs by comma and trim whitespace
    const urls = urlString.split(',').map(url => url.trim()).filter(url => url.length > 0);
    
    if (urls.length === 0) {
        // Using a custom message box instead of alert()
        showMessageBox('No valid URLs found');
        return;
    }
    
    // Show a confirmation if there are multiple URLs
    if (urls.length > 1) {
        showConfirmationBox(`This will open ${urls.length} documents in separate tabs. Continue?`, () => {
            // Open each URL in a new tab with a small delay to prevent popup blocker
            urls.forEach((url, urlIndex) => {
                setTimeout(() => {
                    window.open(url, '_blank');
                }, urlIndex * 100); // 100ms delay between each tab opening
            });
        });
    } else {
        // Open single URL directly
        window.open(urls[0], '_blank');
    }
}

// Custom message box function
function showMessageBox(message) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
    modalOverlay.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p class="text-gray-800 text-lg mb-4">${message}</p>
            <button onclick="this.closest('.modal-overlay').remove()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full">
                OK
            </button>
        </div>
    `;
    document.body.appendChild(modalOverlay);
}

// Custom confirmation box function
function showConfirmationBox(message, onConfirm) {
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay fixed inset-0 flex items-center justify-center z-50';
    modalOverlay.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center">
            <p class="text-gray-800 text-lg mb-4">${message}</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYes" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">
                    Yes
                </button>
                <button id="confirmNo" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full">
                    No
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modalOverlay);

    document.getElementById('confirmYes').onclick = () => {
        onConfirm();
        modalOverlay.remove();
    };
    document.getElementById('confirmNo').onclick = () => {
        modalOverlay.remove();
    };
}


    async function fetchOrders() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const crmName = urlParams.get('crm');
        if (!crmName) {
            // Using custom message box instead of alert()
            showMessageBox('CRM name is missing in URL');
            throw new Error('CRM name is missing in URL');
        }
        // Append crmName to the API URL
        const response = await fetch(`${API_URL}?crm=${encodeURIComponent(crmName)}`);
        const result = await response.json();
        if (result.status === "success") {
          document.getElementById("loader").classList.add("hidden");
          document.getElementById("ordersContainer").classList.remove("hidden");
          globalOrders = result.data;
          renderOrders(globalOrders);
          if (typeof setReadOnlyMode === "function") {
            setReadOnlyMode();
          }

        } else {
          throw new Error("Invalid response");
        }
      } catch (err) {
        document.getElementById("loader").innerText = "Failed to load orders.";
        console.error(err);
      }
    }

    function getDeadline(originalTimestampStr) {
      const original = new Date(originalTimestampStr);
      let deadline = new Date(original);
      const day = original.getUTCDay(); // 1 = Monday

      // If timestamp is Monday (1), subtract 2 days
      if (day === 1) {
        deadline.setDate(deadline.getDate());
      } else {
        deadline.setDate(deadline.getDate());
      }

      deadline.setHours(18, 0, 0, 0); // 6:00 PM
      return deadline;
    }

    function renderOrders(orders) {
      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

        if (orders.length === 0) {
    container.innerHTML = `
      <div class="col-span-full text-center text-xl text-gray-600 font-semibold">
        ðŸ“¦ No Pending Orders
      </div>
    `;
    return;
  }

      orders.forEach((order, index) => {
        const deadline = getDeadline(order.timestamp);
        const hasInvoice = order.invoiceUrl && order.invoiceUrl.trim() !== "";
        const bgColor = hasInvoice ? "bg-green-100 border border-green-300" : "bg-red-100 border border-red-300";
        const card = document.createElement("div");
        card.className = `${bgColor} p-6 rounded-2xl shadow-md relative transition hover:scale-[1.02]`;
        const overdue = new Date() > deadline;
        const deadlineLabel = overdue ? "Overdue" : "Active";

        // Determine dealerType badge class
        let dealerTypeBadgeHtml = '';
        if (order.dealerType) {
            let badgeColorClass = '';
            switch (order.dealerType.toLowerCase()) {
                case 'red':
                    badgeColorClass = 'bg-red-600'; // Darker red for better contrast
                    break;
                case 'yellow':
                    badgeColorClass = 'bg-yellow-500';
                    break;
                case 'green':
                    badgeColorClass = 'bg-green-600'; // Darker green for better contrast
                    break;
                default:
                    badgeColorClass = 'bg-gray-500';
            }
            dealerTypeBadgeHtml = `
                <div class="dealer-type-badge ${badgeColorClass}">
                    ${order.dealerType}
                </div>
            `;
        }

        card.innerHTML = `
          ${dealerTypeBadgeHtml} <!-- Dealer Type Badge -->
          <div class="absolute top-2 right-2 text-sm font-semibold px-3 py-1 rounded-full ${overdue ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">
            ${deadlineLabel}
          </div>
          ${!hasInvoice ? `<div class="absolute top-2 left-2 text-sm font-semibold px-3 py-1 rounded-full bg-red-200 text-red-800">
            Invoice Missing
          </div>` : ''}
          <h3 class="text-xl font-bold text-gray-800 mb-2">${order.dealerName}</h3>
          <p class="text-gray-600 mb-1">Marketing Person: <span class="font-medium">${order.marketingPersonName}</span></p>
          <p class="text-gray-600 mb-1">Location: <span class="font-medium">${order.location}</span></p>
          <p class="text-gray-600 mb-1">CRM: <span class="font-medium">${order.crmName}</span></p>
          <p class="text-gray-600 mb-4">Concerned Owner: <span class="font-medium">${order.concernedOwner}</span></p>

          <div class="flex justify-between items-center mb-4">
            <span class="text-gray-700 font-semibold">File Upload:</span>
            <button onclick="openMultipleDocuments('${order.fileUploadLink.replace(/'/g, "\\'")}', ${index})" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-full transition duration-300">
              View Document
            </button>
          </div>

          <div class="bg-white p-4 rounded-lg shadow-inner mb-4">
            <p class="text-gray-700 text-lg font-semibold mb-2">Dispatch Details:</p>
            <p class="text-gray-600 text-sm mb-1">Expected Delivery Date: <span class="font-medium">${formatDateToDDMMMYYYY(order.expectedDeliveryDate)}</span></p>
            <p class="text-gray-600 text-sm mb-1">Dispatch Date & Time: <span class="font-medium">${formatDateToDDMMMYYYY(order.timestamp)}</span></p>
            <p class="text-gray-600 text-sm mb-1">Vehicle No: <span class="font-medium">${order.vehicleNo || 'N/A'}</span></p>
            <p class="text-gray-600 text-sm mb-1">Freight Amt: <span class="font-medium">${order.freight || 'N/A'}</span></p>
            <p class="text-gray-600 text-sm mb-1">Driver Name: <span class="font-medium">${order.driverName || 'N/A'}</span></p>
            <p class="text-gray-600 text-sm mb-4">Driver Mobile: <span class="font-medium">${order.driverMob || 'N/A'}</span></p>
            <p class="text-gray-600 text-sm">Invoice URL: <a href="${order.invoiceUrl}" target="_blank" class="text-blue-500 hover:underline">${order.invoiceUrl || 'N/A'}</a></p>
          </div>

          <div class="flex justify-center">
            <button onclick="submitOrder(this, ${index})" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
              Inform Dealer
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function submitOrder(button, index) {
  const originalText = button.textContent;
  button.textContent = "Submitting...";
  button.disabled = true;
  button.classList.add('btn-loading'); // Add loading class

  try {
    const order = globalOrders[index];
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ action: "informDealer", orderId: order.orderId, crmName: order.crmName }),
    });

    const result = await response.json();

    if (result.status === "success") {
        // Using custom message box instead of alert()
        showMessageBox("Submitted successfully!");
        button.textContent = "Submitted âœ“";
        button.style.backgroundColor = "#10B981"; // Green color
        // Optionally, remove the card or disable further submissions
        // button.disabled = true;
        fetchOrders(); // Refresh the data to reflect changes
    } else {
        throw new Error(result.message || "Submission failed.");
    }
  } catch (err) {
    console.error('Submit error:', err);
    // Using custom message box instead of alert()
    showMessageBox("Submission failed. Please try again.");
    button.textContent = originalText;
    button.disabled = false;
  } finally {
    button.classList.remove('btn-loading'); // Remove loading class
    fetchOrders(); // Always refresh data in finally
  }
}

    function copyDispatchDetails(index) {
      const order = globalOrders[index];
      const details = `Expected Delivery Date: ${formatDateToDDMMMYYYY(order.expectedDeliveryDate)}
      Dispatch Date & Time: ${formatDateToDDMMMYYYY(order.timestamp)}
      Vehicle No: ${order.vehicleNo || 'N/A'}
      Freight Amt: ${order.freight || 'N/A'}
      Driver Name: ${order.driverName || 'N/A'}
      Driver Mobile: ${order.driverMob || 'N/A'}
      Invoice URL: ${order.invoiceUrl || 'N/A'}`;

      navigator.clipboard.writeText(details)
        .then(() => {
          // Using custom message box instead of alert()
          showMessageBox('Dispatch details copied to clipboard!');
        })
        .catch(err => {
          console.error('Failed to copy dispatch details:', err);
          // Using custom message box instead of alert()
          showMessageBox('Failed to copy dispatch details.');
        });
    }

    // Initial fetch of orders when the page loads
    document.addEventListener("DOMContentLoaded", fetchOrders);
  </script>
</body>
</html>
