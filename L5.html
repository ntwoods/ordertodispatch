<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inform The Dealer About Dispatch Details</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    .dealer-type-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
      margin-left: 0.5rem;
      white-space: nowrap;
      z-index: 30;
    }
    .bg-red-500 { background-color: #ef4444; }
    .bg-yellow-500 { background-color: #f59e0b; }
    .bg-green-500 { background-color: #22c55e; }
    .bg-gray-500 { background-color: #6b7280; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <!-- Mode banner -->
  <div id="modeBanner" class="mb-3 hidden rounded-lg px-4 py-2 text-sm font-semibold"></div>

  <div id="loader" class="text-center text-xl text-blue-600 font-semibold">Loading orders...</div>
  <div id="ordersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6 hidden"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwUr0UhENK6RGtdvYMC6-V0Khwb3kibKP4SLXC4nzL6Hm4idr6P-Olx4XTWvgZ_e2xk-Q/exec";

    // --------- URL mode detection ----------
    const urlParams = new URLSearchParams(window.location.search);
    const modeParam = (urlParams.get('mode') || '').trim().toLowerCase();
    const crmParam = (urlParams.get('crm') || '').trim();

    // Priority: if mode=view present => view-only + all CRMs (ignore crm)
    const IS_VIEW_ONLY = modeParam === 'view';
    const FETCH_ALL = IS_VIEW_ONLY || !crmParam; // all when view-only OR when no crm provided
    const apiFetchUrl = FETCH_ALL ? API_URL : `${API_URL}?crm=${encodeURIComponent(crmParam)}`;

    // Banner text + style
    function showModeBanner() {
      const banner = document.getElementById('modeBanner');
      if (!banner) return;

      let text = '';
      let classes = '';
      if (IS_VIEW_ONLY) {
        text = 'View Only Mode: You can only view all CRMs; no submission allowed.';
        classes = 'bg-yellow-100 text-yellow-800 border border-yellow-300';
      } else if (!crmParam) {
        text = 'All CRMs Mode: Showing pending orders for ALL CRMs.';
        classes = 'bg-blue-100 text-blue-800 border border-blue-300';
      } else {
        text = `CRM Mode: Showing pending orders for CRM â€“ ${crmParam}`;
        classes = 'bg-green-100 text-green-800 border border-green-300';
      }

      banner.textContent = text;
      banner.className = `mb-4 p-3 rounded-lg text-sm font-medium ${classes}`;
    }

    // Global store for orders
    let globalOrders = [];

    /**
     * Fetch orders and manage loader / container visibility
     */
    async function fetchOrders() {
      showModeBanner();

      const loaderEl = document.getElementById("loader");
      const container = document.getElementById("ordersContainer");

      if (loaderEl) loaderEl.classList.remove("hidden");
      if (container) {
        container.classList.add("hidden");
        container.innerHTML = "";
      }

      try {
        const res = await fetch(apiFetchUrl);
        const json = await res.json();

        if (!json || !json.success) {
          throw new Error(json && json.message ? json.message : "Unknown error from API");
        }

        const dataArr = json.data || [];
        globalOrders = dataArr; // store globally

        renderOrders(dataArr);
      } catch (err) {
        console.error("Error fetching orders:", err);
        alert("Error fetching orders: " + (err.message || err));
      } finally {
        if (loaderEl) loaderEl.classList.add("hidden");
        if (container) container.classList.remove("hidden");
      }
    }

    // --- Utility to format date in DD-MMM-YYYY HH:MM:SS ---
    function formatDateToDDMMMYYYY(dateStrOrDate) {
      if (!dateStrOrDate) return "";
      const d = (dateStrOrDate instanceof Date) ? dateStrOrDate : new Date(dateStrOrDate);
      if (isNaN(d)) return "";

      const day = String(d.getDate()).padStart(2, "0");
      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const month = monthNames[d.getMonth()];
      const year = d.getFullYear();

      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");

      return `${day}-${month}-${year} ${hh}:${mm}:${ss}`;
    }

    // ------------------- Deadline Logic (updated) -------------------
    function getDeadline(originalTimestampStr) {
      // Agar timestamp blank ya null hai to direct null
      if (!originalTimestampStr) return null;

      const original = new Date(originalTimestampStr);
      if (isNaN(original)) {
        // agar invalid date aa gaya to null
        return null;
      }

      const deadline = new Date(original);
      const hour = original.getHours();
      const minute = original.getMinutes();

      // Agar time 5:00 pm se baad ka hai (strictly after 17:00)
      if (hour > 17 || (hour === 17 && minute > 0)) {
        // Next day le lo
        deadline.setDate(deadline.getDate() + 1);

        // Agar next day Sunday hai (getDay() === 0) to Monday kar do
        if (deadline.getDay() === 0) {
          deadline.setDate(deadline.getDate() + 1);
        }

        // Deadline time = 10:30 am
        deadline.setHours(10, 30, 0, 0);
      } else {
        // Normal case: sirf 2 ghanta add
        deadline.setTime(deadline.getTime() + 2 * 60 * 60 * 1000);
      }

      return deadline;
    }

    function renderOrders(orders) {
      const container = document.getElementById("ordersContainer");
      if (!container) return;

      container.innerHTML = "";

      if (!orders || orders.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center text-xl text-gray-600 font-semibold">
            ðŸ“¦ No Pending Orders
          </div>
        `;
        return;
      }

      orders.forEach((order, index) => {
        const deadline = getDeadline(order.timestamp);
        const hasDeadline = !!deadline;

        const hasInvoice = order.invoiceUrl && order.invoiceUrl.trim() !== "";
        const bgColor = hasInvoice
          ? "bg-green-100 border border-green-300"
          : "bg-red-100 border border-red-300";

        const card = document.createElement("div");
        card.className = `${bgColor} p-6 rounded-2xl shadow-md relative transition hover:scale-[1.02]`;

        const overdue = hasDeadline && (new Date() > deadline);
        const deadlineLabel = hasDeadline ? (overdue ? "Overdue" : "Active") : "Pending";
        const statusClass = overdue
          ? "bg-red-200 text-red-800"
          : hasDeadline
            ? "bg-green-200 text-green-800"
            : "bg-gray-200 text-gray-800";

        // Dealer Type Badge
        let dealerTypeBadge = "";
        if (order.dealerType) {
          let badgeColorClass = "";
          switch ((order.dealerType || "").toLowerCase()) {
            case "red": badgeColorClass = "bg-red-500"; break;
            case "yellow": badgeColorClass = "bg-yellow-500"; break;
            case "green": badgeColorClass = "bg-green-500"; break;
            default: badgeColorClass = "bg-gray-500";
          }
          dealerTypeBadge = `
            <div class="dealer-type-badge ${badgeColorClass}">
              ${order.dealerType}
            </div>
          `;
        }

        // Editable section (hidden/omitted in view-only)
        const editableBlock = IS_VIEW_ONLY ? `
          <div class="mt-4 text-sm text-gray-600 italic">
            View Only Mode: Editing controls are disabled.
          </div>
        ` : `
          <div class="editable">
            <span class="text-m text-black-600">Dispatch Receipt:</span>
            <button onclick="openMultipleDocuments('${(order.dispatchDetailUrl || '').replace(/'/g, "\\'")}', ${index})"
              class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
              View Dispatch Receipts
            </button>

            <span class="text-m text-black-600">Raw File:</span>
            <button onclick="openMultipleDocuments('${(order.fileUploadLink || '').replace(/'/g, "\\'")}', ${index})"
              class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
              Raw File
            </button>

            <span class="text-m text-black-600">Final Order:</span>
            <button onclick="openMultipleDocuments('${(order.finalOrder || '').replace(/'/g, "\\'")}', ${index})"
              class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
              Final File
            </button>

            ${order.additionalOrder ? `
              <span class="text-m text-red-600">Additional Order:</span>
              <button onclick="openMultipleDocuments('${(order.additionalOrder || '').replace(/'/g, "\\'")}', ${index})"
                class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
                Additional Order File
              </button>
            ` : ""}

            <span class="text-m text-black-600">Invoices:</span>
            <button onclick="openMultipleDocuments('${(order.invoiceUrl || '').replace(/'/g, "\\'")}', ${index})"
              class="text-sm text-blue-600 hover:text-blue-800 underline bg-transparent border-none cursor-pointer">
              View Invoices
            </button>

            <div class="mt-4">
              <label class="inline-flex items-center">
                <input type="radio" name="confirm-${index}" id="radio-${index}" class="form-radio h-4 w-4 text-blue-600">
                <span class="ml-2 text-sm">Dispatch Details Sent To Dealer</span>
              </label>
            </div>

            <div class="mt-2">
              <label for="remark-${index}" class="block text-sm font-medium text-gray-700">Remark:</label>
              <input type="text" id="remark-${index}"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <button id="submit-${index}" onclick="submitConfirmation(${index})"
              class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
              Submit
            </button>

            <button onclick="copyDispatchDetails(${index})"
              class="mt-2 w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
              Copy Dispatch Details
            </button>
          </div>
        `;

        card.innerHTML = `
          <div class="absolute top-2 right-2 text-sm font-semibold px-3 py-1 rounded-full ${statusClass}">
            ${deadlineLabel}
          </div>

          ${!hasInvoice
            ? `<div class="absolute top-2 left-2 text-xs font-semibold px-2 py-1 rounded-full bg-red-200 text-red-800">Missing Invoice</div>`
            : ""}

          <div class="flex items-center">
            <div class="text-xl font-bold mb-2">${order.dealerName}</div>
            ${dealerTypeBadge}
          </div>
          <p><strong>Marketing:</strong> ${order.marketingPersonName}</p>
          <p><strong>Location:</strong> ${order.location}</p>
          <p><strong>CRM:</strong> ${order.crmName}</p>
          <p><strong>Con. Owner:</strong> ${order.concernedOwner}</p>
          <p><strong>Expected Delivery:</strong> ${formatDateToDDMMMYYYY(order.expectedDeliveryDate)}</p>
          <p><strong>Dispatch Date & Time:</strong> ${formatDateToDDMMMYYYY(order.dispatchDate)}</p>
          <p><strong>Deadline:</strong> ${hasDeadline ? formatDateToDDMMMYYYY(deadline) : ""}</p>
          <p><strong>Time Left:</strong> <span id="countdown-${index}" class="font-mono text-blue-700"></span></p>
          <p><strong>Vehicle No:</strong> ${order.vehicleNo || "N/A"}</p>
          <p><strong>Freight:</strong> ${order.freight || "N/A"}</p>
          <p><strong>Driver Name:</strong> ${order.driverName || "N/A"}</p>
          <p><strong>Driver Mobile:</strong> ${order.driverMob || "N/A"}</p>

          ${editableBlock}
        `;

        container.appendChild(card);

        // Sirf jab valid deadline ho tabhi countdown chalao
        if (hasDeadline) {
          startCountdown(deadline, index);
        }
      });
    }

    function startCountdown(deadline, index) {
      const el = document.getElementById(`countdown-${index}`);
      if (!el) return;

      function update() {
        const now = new Date();
        const diff = deadline - now;
        if (diff <= 0) {
          el.innerText = "Expired";
          return;
        }
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);
        el.innerText = `${hours}h ${minutes}m ${seconds}s`;
      }

      update();
      setInterval(update, 1000);
    }

    // ---------------- Opening multiple documents ----------------
    function openMultipleDocuments(urlString, index) {
      if (!urlString) {
        alert("No document URLs available.");
        return;
      }
      const urls = urlString.split(",").map(u => u.trim()).filter(u => u);
      if (urls.length === 0) {
        alert("No valid document URLs found.");
        return;
      }

      urls.forEach((url) => {
        window.open(url, "_blank");
      });
    }

    // ---------------- Submission Logic ----------------
    async function submitConfirmation(index) {
      if (IS_VIEW_ONLY) {
        alert("View Only mode mein submission allowed nahi hai.");
        return;
      }

      const radio = document.getElementById(`radio-${index}`);
      const remarkInput = document.getElementById(`remark-${index}`);
      if (!radio || !radio.checked) {
        alert("Please confirm that the Dispatch Department is informed.");
        return;
      }

      const button = document.getElementById(`submit-${index}`);
      const originalText = button.textContent;
      button.textContent = "Submitting...";
      button.disabled = true;

      const payload = {
        timestampForMap: globalOrders[index].timestampForMap,
        remark: remarkInput ? remarkInput.value : ""
      };

      try {
        await fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });

        setTimeout(() => {
          alert("Submitted successfully!");
          button.textContent = "Submitted âœ“";
          button.disabled = true;
        }, 500);
      } catch (err) {
        console.error("Submission error:", err);
        alert("Error submitting data. Please try again.");
        button.textContent = originalText;
        button.disabled = false;
      }
    }

    // ---------------- Copy Dispatch Details ----------------
    function copyDispatchDetails(index) {
      const order = globalOrders[index];
      if (!order) {
        alert("Order not found.");
        return;
      }

      const details = `Dealer: ${order.dealerName}
Marketing Person: ${order.marketingPersonName}
Location: ${order.location}
CRM: ${order.crmName}
Concerned Owner: ${order.concernedOwner}
Expected Delivery: ${formatDateToDDMMMYYYY(order.expectedDeliveryDate)}
Dispatch Date & Time: ${formatDateToDDMMMYYYY(order.dispatchDate)}
Vehicle No: ${order.vehicleNo || "N/A"}
Freight: ${order.freight || "N/A"}
Driver Name: ${order.driverName || "N/A"}
Driver Mobile: ${order.driverMob || "N/A"}
Invoice URL: ${order.invoiceUrl || "N/A"}`;

      navigator.clipboard.writeText(details)
        .then(() => alert("Dispatch details copied to clipboard!"))
        .catch(err => {
          console.error("Failed to copy dispatch details:", err);
          alert("Failed to copy dispatch details. Please try again or copy manually.");
        });
    }

    // Kickoff
    fetchOrders();
  </script>
  <script src="js/viewOnly.js"></script>
</body>
</html>
