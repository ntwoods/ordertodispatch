<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dispatch Command Center</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    * { font-family: 'Inter', sans-serif; }

    body {
      background-color: #e3f2fd;
      min-height: 100vh; position: relative; overflow-x: hidden;
    }
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: -1;
      background:
        radial-gradient(circle at 20% 50%, rgba(144,202,249,.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(179,229,252,.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(207,216,220,.2) 0%, transparent 50%);
    }

    .glass-morphism { background: rgba(255,255,255,.8); backdrop-filter: blur(20px);
      border: 1px solid rgba(144,202,249,.5); box-shadow: 0 10px 30px rgba(0,0,0,.1); }
    .card-hover { transition: all .4s cubic-bezier(.4,0,.2,1); transform-style: preserve-3d; }
    .card-hover:hover { transform: translateY(-8px) rotateX(2deg);
      box-shadow: 0 15px 40px rgba(0,0,0,.15), 0 0 0 1px rgba(144,202,249,.5); }

    .pulse-ring { animation: pulse-ring 2s cubic-bezier(.455,.03,.515,.955) infinite; }
    @keyframes pulse-ring { 0%{transform:scale(.8);opacity:1} 80%,100%{transform:scale(1.2);opacity:0} }

    .float-animation { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

    .gradient-text { background: linear-gradient(135deg,#1976d2 0%,#2196f3 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }

    .status-active  { background: linear-gradient(135deg,#4CAF50,#81C784); box-shadow: 0 0 15px rgba(76,175,80,.4); }
    .status-overdue { background: linear-gradient(135deg,#EF5350,#E57373); box-shadow: 0 0 15px rgba(239,83,80,.4); animation: pulse-danger 2s infinite; }
    @keyframes pulse-danger { 0%,100%{opacity:1} 50%{opacity:.8} }

    .countdown-active { background: linear-gradient(135deg,#1976d2,#2196f3);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-weight:700; text-shadow:0 0 8px rgba(25,118,210,.3); }
    .countdown-danger { background: linear-gradient(135deg,#D32F2F,#F44336);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-weight:700; animation:pulse 1s infinite; }

    .btn-primary { background: linear-gradient(135deg,#1976d2,#2196f3); color:#fff; transition:.3s; box-shadow:0 8px 20px rgba(25,118,210,.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(25,118,210,.4); }
    .btn-success { background: linear-gradient(135deg,#4CAF50,#81C784); color:#fff; box-shadow:0 8px 20px rgba(76,175,80,.3); }

    .loader-container { background: rgba(255,255,255,.9); backdrop-filter: blur(15px);
      border: 1px solid rgba(144,202,249,.5); box-shadow: 0 10px 30px rgba(0,0,0,.1); }

    .loading-dots{ display:inline-block; } .loading-dots::after{ content:'...'; animation:dots 2s steps(4,end) infinite; }
    @keyframes dots{ 0%,20%{content:'.'} 40%{content:'..'} 60%,100%{content:'...'} }

    .metric-card{ background: rgba(255,255,255,.9); backdrop-filter: blur(10px);
      border: 1px solid rgba(144,202,249,.5); transition:.3s; box-shadow:0 5px 15px rgba(0,0,0,.08); }
    .metric-card:hover{ background:#fff; transform: translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.12); }
    .icon-glow{ filter: drop-shadow(0 0 8px rgba(25,118,210,.5)); }

    .no-orders { background: rgba(255,255,255,.9); backdrop-filter: blur(15px);
      border: 2px dashed rgba(144,202,249,.6); animation: float 4s ease-in-out infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,.1); }

    .radio-custom{ appearance:none; width:20px;height:20px; border:2px solid #1976d2; border-radius:50%; position:relative; cursor:pointer; transition:.3s; }
    .radio-custom:checked{ background: linear-gradient(135deg,#1976d2,#2196f3); border-color:#1976d2; }
    .radio-custom:checked::after{ content:''; position:absolute; top:3px; left:3px; width:10px;height:10px; border-radius:50%; background:#fff; }

    /* Text shades */
    .text-white{ color:#212121 } .text-white\/80{ color:rgba(33,33,33,.8) }
    .text-white\/70{ color:rgba(33,33,33,.7) } .text-white\/60{ color:rgba(33,33,33,.6) }
    .text-white\/10{ background-color: rgba(144,202,249,.2) }

    /* Dealer type badge */
    .dealer-type-badge{ display:inline-flex;align-items:center;justify-content:center;padding:.25rem .75rem;border-radius:9999px;font-size:.75rem;font-weight:600;color:#fff;margin-left:.5rem;white-space:nowrap; }
    .bg-red-500{background:#ef4444}.bg-yellow-500{background:#f59e0b}.bg-green-500{background:#22c55e}.bg-gray-500{background:#6b7280}
  </style>
</head>
<body class="min-h-screen p-4">
  <div class="text-center mb-8">
    <div class="glass-morphism rounded-3xl p-8 max-w-4xl mx-auto">
      <div class="flex items-center justify-center mb-4">
        <div class="relative">
          <div class="absolute inset-0 pulse-ring bg-white opacity-20 rounded-full"></div>
          <i class="fas fa-truck-fast text-5xl text-blue-700 icon-glow"></i>
        </div>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-blue-800 mb-2 gradient-text">
        Our Dispatch Team Needs Some Reminders
      </h1>
      <p class="text-xl text-blue-600 font-light">Real-time Order Management & Tracking Dashboard</p>
      <!-- Mode banner -->
      <div id="modeBanner" class="mt-4 mx-auto w-max hidden glass-morphism rounded-full px-4 py-2 text-sm font-semibold border"></div>
    </div>
  </div>

  <div id="metricsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 max-w-6xl mx-auto hidden">
    <div class="metric-card rounded-2xl p-6 text-center">
      <div class="text-3xl mb-2 text-blue-500">ðŸ“Š</div>
      <div class="text-2xl font-bold text-blue-800" id="totalOrders">0</div>
      <div class="text-blue-600">Total Orders</div>
    </div>
    <div class="metric-card rounded-2xl p-6 text-center">
      <div class="text-3xl mb-2 text-blue-500">âš¡</div>
      <div class="text-2xl font-bold text-blue-800" id="activeOrders">0</div>
      <div class="text-blue-600">Active Orders</div>
    </div>
    <div class="metric-card rounded-2xl p-6 text-center">
      <div class="text-3xl mb-2 text-blue-500">ðŸš¨</div>
      <div class="text-2xl font-bold text-blue-800" id="overdueOrders">0</div>
      <div class="text-blue-600">Overdue Orders</div>
    </div>
  </div>

  <div id="loader" class="text-center">
    <div class="loader-container rounded-3xl p-12 max-w-md mx-auto">
      <div class="mb-6"><i class="fas fa-sync-alt text-4xl text-blue-500 animate-spin"></i></div>
      <div class="text-2xl text-blue-700 font-semibold">Loading orders<span class="loading-dots"></span></div>
      <div class="text-blue-500/60 mt-2">Fetching latest dispatch data</div>
    </div>
  </div>

  <div id="ordersContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 max-w-7xl mx-auto hidden"></div>

  <script>
    // ====== CONFIG ======
    const API_URL = "https://script.google.com/macros/s/AKfycbxMxIzOQmHv3LPTh6ca6i5uuguyH615cnjA5emEGNT0rmWpJlnrcg-KWNVP1DORkkcX/exec";
    let globalOrders = [];

    // ====== URL Modes ======
    const URL_PARAMS = new URLSearchParams(window.location.search);
    const MODE_PARAM = (URL_PARAMS.get('mode') || '').trim().toLowerCase();
    const CRM_PARAM  = (URL_PARAMS.get('crm')  || '').trim();

    // 1) ?crm=...   => CRM-filtered + edit
    // 2) ?mode=view => ALL + view-only (ignore crm)
    // 3) no params  => ALL + edit
    const IS_VIEW_ONLY = MODE_PARAM === 'view';
    const FETCH_ALL    = IS_VIEW_ONLY || !CRM_PARAM;

    const API_WITH_CRM = `${API_URL}?crm=${encodeURIComponent(CRM_PARAM)}`;
    const API_FETCH_URL = FETCH_ALL ? API_URL : API_WITH_CRM;

    // ====== Mode Banner ======
    function setModeBanner(){
      const el = document.getElementById('modeBanner');
      let text = '', cls = '';
      if (IS_VIEW_ONLY) { text = 'Mode: View Only â€¢ Showing orders for ALL CRMs'; cls='border-yellow-300 text-yellow-800'; }
      else if (!FETCH_ALL) { text = `Mode: Normal â€¢ CRM Filter: ${CRM_PARAM}`; cls='border-blue-300 text-blue-800'; }
      else { text = 'Mode: Normal â€¢ Showing orders for ALL CRMs'; cls='border-green-300 text-green-800'; }
      el.textContent = text;
      el.className = `mt-4 mx-auto w-max glass-morphism rounded-full px-4 py-2 text-sm font-semibold border ${cls}`;
      el.classList.remove('hidden');
    }

    // ====== Smart parser (JSON or text) ======
    async function parseSmart(resp){
      const ct = (resp.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) return { kind:'json', body: await resp.json() };
      const txt = await resp.text(); return { kind:'text', body: txt };
    }

    // ====== Fetch Orders (robust + 3 modes) ======
    async function fetchOrders() {
      try {
        // 1st attempt (per mode)
        let resp = await fetch(API_FETCH_URL, { cache: 'no-store' });
        let parsed = await parseSmart(resp);

        // If backend replied "CRM name missing", retry without crm (ALL)
        if (parsed.kind === 'text' && /crm name missing/i.test(parsed.body) && API_FETCH_URL !== API_URL) {
          resp = await fetch(API_URL, { cache: 'no-store' });
          parsed = await parseSmart(resp);
        }

        if (parsed.kind === 'json' && parsed.body && parsed.body.status === "success") {
          document.getElementById("loader").classList.add("hidden");
          document.getElementById("ordersContainer").classList.remove("hidden");
          document.getElementById("metricsContainer").classList.remove("hidden");

          globalOrders = parsed.body.data || [];
          updateMetrics(globalOrders);
          renderOrders(globalOrders);

          if (IS_VIEW_ONLY && typeof setReadOnlyMode === 'function') setReadOnlyMode();
          if (IS_VIEW_ONLY) applyViewOnly();
        } else {
          throw new Error("Invalid response from API");
        }
      } catch (err) {
        document.getElementById("loader").innerHTML = `
          <div class="loader-container rounded-3xl p-12 max-w-md mx-auto">
            <div class="mb-6"><i class="fas fa-exclamation-triangle text-4xl text-red-400"></i></div>
            <div class="text-2xl text-blue-700 font-semibold mb-2">Failed to load orders</div>
            <div class="text-blue-500/60">Please check your connection and try again</div>
          </div>
        `;
        console.error(err);
      }
    }

    // ====== Metrics ======
    function updateMetrics(orders) {
      const total = orders.length;
      let active = 0, overdue = 0;
      orders.forEach(order => {
        const deadline = getDeadline(order.timestamp);
        if (new Date() > deadline) overdue++; else active++;
      });
      document.getElementById('totalOrders').textContent = total;
      document.getElementById('activeOrders').textContent = active;
      document.getElementById('overdueOrders').textContent = overdue;
    }

    // ====== Render ======
    function renderOrders(orders) {
      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

      if (!orders || orders.length === 0) {
        container.innerHTML = `
          <div class="md:col-span-3 flex justify-center">
            <div class="no-orders rounded-3xl p-12 text-center max-w-lg w-full float-animation">
              <i class="fas fa-box-open text-6xl text-blue-400 mb-4"></i>
              <h2 class="text-3xl font-bold text-blue-700 mb-2">No Pending Dispatches!</h2>
              <p class="text-blue-500/70">All orders are up-to-date. Great job, team!</p>
              <button onclick="fetchOrders()" class="btn-primary px-6 py-3 rounded-xl mt-6">
                <i class="fas fa-sync-alt mr-2"></i> Refresh Dashboard
              </button>
            </div>
          </div>
        `;
        return;
      }

      orders.forEach((order, index) => {
        const deadline = getDeadline(order.timestamp);
        const isOverdue = new Date() > deadline;

        const card = document.createElement("div");
        card.className = "glass-morphism rounded-3xl p-6 flex flex-col card-hover";
        card.style.animationDelay = `${index * 0.1}s`;

        const statusClass = isOverdue ? 'status-overdue' : 'status-active';
        const countdownClass = isOverdue ? 'countdown-danger' : 'countdown-active';
        const statusText = isOverdue ? 'OVERDUE' : 'ACTIVE';

        // Dealer Type Badge
        let dealerTypeBadge = '';
        if (order.dealerType) {
          let c = 'bg-gray-500';
          switch (String(order.dealerType).toLowerCase()) {
            case 'red': c='bg-red-500'; break;
            case 'yellow': c='bg-yellow-500'; break;
            case 'green': c='bg-green-500'; break;
          }
          dealerTypeBadge = `<div class="dealer-type-badge ${c}">${order.dealerType}</div>`;
        }

        card.innerHTML = `
          <div class="flex-grow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-bold text-blue-800 flex items-center">
                ${order.dealerName} ${dealerTypeBadge}
              </h3>
              <span class="text-xs font-semibold px-3 py-1 rounded-full text-white ${statusClass}">
                ${statusText}
              </span>
            </div>

            <p class="text-blue-700/80 mb-2"><i class="fas fa-user mr-2 text-blue-500/70"></i>Marketing: <span class="text-blue-900 font-medium">${order.marketingPersonName}</span></p>
            <p class="text-blue-700/80 mb-2"><i class="fas fa-map-marker-alt mr-2 text-blue-500/70"></i>Location: <span class="text-blue-900 font-medium">${order.location}</span></p>
            <p class="text-blue-700/80 mb-2"><i class="fas fa-id-card mr-2 text-blue-500/70"></i>CRM Name: <span class="text-blue-900 font-medium">${order.crmName}</span></p>
            <p class="text-blue-700/80 mb-4"><i class="fas fa-user-tie mr-2 text-blue-500/70"></i>Concerned Owner: <span class="text-blue-900 font-medium">${order.concernedOwner}</span></p>

            <div class="flex justify-between items-center mb-4">
              <span class="text-blue-700/80"><i class="fas fa-calendar-alt mr-2 text-blue-500/70"></i>Tentative Dispatch:</span>
              <span class="text-blue-900 font-medium">${order.timestamp ? formatDate(order.timestamp) : 'N/A'}</span>
            </div>

            <div class="flex justify-between items-center bg-blue-500/10 rounded-xl p-3 mb-4">
              <span class="text-blue-700 font-semibold"><i class="fas fa-hourglass-half mr-2 text-blue-600"></i>Time Left:</span>
              <span id="countdown-${index}" class="text-2xl font-mono ${countdownClass}"></span>
            </div>

            <div class="flex justify-center space-x-4 mb-4">
              <button onclick="openMultipleDocuments('${order.fileUploadLink ? order.fileUploadLink.replace(/'/g, "\\'") : ''}')" class="btn-primary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-file-alt mr-2"></i>Raw Order
              </button>
              <button onclick="openMultipleDocuments('${order.finalOrderFile ? order.finalOrderFile.replace(/'/g, "\\'") : ''}')" class="btn-primary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-file-invoice mr-2"></i>Final Order
              </button>
            </div>

            ${IS_VIEW_ONLY ? `
              <div class="mt-2 text-sm italic text-gray-600">View Only Mode: Editing controls are disabled.</div>
            ` : `
              <div class="editable">
                <div class="mb-4">
                  <label for="remark-${index}" class="block text-blue-700/80 font-semibold mb-2">
                    <i class="fas fa-comment-alt mr-2 text-blue-500/70"></i>Remark:
                  </label>
                  <input type="text" id="remark-${index}"
                         class="w-full p-3 rounded-lg bg-blue-500/10 border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-300 text-blue-900"
                         placeholder="Add a remark (e.g., 'Called customer')" />
                </div>

                <div class="radio-section mb-4">
                  <label class="block text-blue-700/80 font-semibold mb-2">
                    <i class="fas fa-check-circle mr-2 text-blue-500/70"></i>Status Update:
                  </label>
                  <div class="flex flex-wrap gap-4">
                    <label class="inline-flex items-center group cursor-pointer">
                      <input type="radio" name="status-${index}" value="Dispatch informed" class="radio-custom" onchange="enableSubmit(${index})">
                      <span class="ml-2 text-blue-800 font-medium group-hover:text-blue-900">Dispatch department informed</span>
                    </label>
                  </div>
                </div>

                <button id="submit-btn-${index}" onclick="submitOrder(${index})"
                  class="btn-primary w-full py-3 rounded-xl text-lg font-semibold flex items-center justify-center transition-all duration-300 ease-in-out"
                  disabled>
                  <i class="fas fa-paper-plane mr-3"></i> Submit Update
                </button>
              </div>
            `}
          </div>
        `;
        container.appendChild(card);
        startCountdown(deadline, `countdown-${index}`);
      });
    }

    // ====== Utilities ======
    function formatDate(ts) {
      const d = parseOrderDate(ts);
      if (isNaN(d)) return 'N/A';
      return d.toLocaleDateString('en-GB');
    }

    function parseOrderDate(ts) {
      if (!ts) return new Date(NaN);
      if (typeof ts === 'string') {
        const m = ts.trim().match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})$/);
        if (m) { const d = +m[1], mo = +m[2]-1, y = +m[3]; return new Date(y,mo,d); }
      }
      return new Date(ts);
    }

    function getDeadline(timestamp) {
      const orderTime = parseOrderDate(timestamp);
      if (isNaN(orderTime)) return new Date();
      return new Date(orderTime.getFullYear(), orderTime.getMonth(), orderTime.getDate(), 18,0,0,0);
    }

    function startCountdown(deadline, elementId) {
      const el = document.getElementById(elementId);
      function render() {
        const now = new Date(), ms = deadline - now;
        if (ms <= 0) { el.textContent = "00:00:00:00"; el.classList.remove('countdown-active'); el.classList.add('countdown-danger'); return; }
        const days = Math.floor(ms/86400000);
        const hours = Math.floor((ms%86400000)/3600000);
        const minutes = Math.floor((ms%3600000)/60000);
        const seconds = Math.floor((ms%60000)/1000);
        el.textContent = `${String(days).padStart(2,'0')}:${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
      }
      render(); setInterval(render, 1000);
    }

    function enableSubmit(index) {
      const submitBtn = document.getElementById(`submit-btn-${index}`);
      if (submitBtn) submitBtn.disabled = false;
    }

    function applyViewOnly(){
      document.querySelectorAll('.editable input, .editable button, .editable textarea, .editable select')
        .forEach(ctrl => { ctrl.disabled = true; ctrl.classList.add('cursor-not-allowed'); });
      document.querySelectorAll('.editable').forEach(el => el.style.opacity = 0.6);
    }

    async function submitOrder(index) {
      const order = globalOrders[index];
      const selectedStatus = document.querySelector(`input[name="status-${index}"]:checked`);
      const remark = document.getElementById(`remark-${index}`)?.value || '';
      const button = document.getElementById(`submit-btn-${index}`);
      const originalText = button.innerHTML;

      if (!selectedStatus) { showNotification('Please select a status!', 'warning'); return; }

      button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...`;
      button.disabled = true;

      const payload = {
        timestamp: order.timestamp,
        timestampForMap: order.timestampForMap,
        status: selectedStatus.value,
        remark: remark
      };

      try {
        await fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        setTimeout(() => {
          showNotification('Order updated successfully!', 'success');
          button.innerHTML = `<i class="fas fa-check mr-2"></i> Submitted âœ“`;
          button.className = button.className.replace('btn-primary', 'btn-success');
          fetchOrders();
        }, 1000);
      } catch (err) {
        console.error('Submit error:', err);
        button.innerHTML = originalText;
        button.disabled = false;
        showNotification('Submission failed. Please try again.', 'error');
      }
    }

    function showNotification(message, type) {
      const notificationDiv = document.createElement('div');
      let bg = 'bg-blue-500', icon = 'fas fa-info-circle';
      if (type === 'success') { bg='bg-green-500'; icon='fas fa-check-circle'; }
      else if (type === 'error') { bg='bg-red-500'; icon='fas fa-exclamation-circle'; }
      else if (type === 'warning') { bg='bg-yellow-500'; icon='fas fa-exclamation-triangle'; }

      notificationDiv.className = `fixed top-4 right-4 ${bg} text-white px-6 py-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
      notificationDiv.innerHTML = `<div class="flex items-center gap-3"><i class="${icon}"></i><span>${message}</span></div>`;
      document.body.appendChild(notificationDiv);
      setTimeout(()=>notificationDiv.classList.remove('translate-x-full'), 100);
      setTimeout(()=>{
        notificationDiv.classList.add('translate-x-full');
        setTimeout(()=>document.body.removeChild(notificationDiv), 300);
      }, 3000);
    }

    function openMultipleDocuments(urlString) {
      const urls = String(urlString || '').split(',').map(u => u.trim()).filter(Boolean);
      if (!urls.length) { showNotification('No valid URLs found for this order.', 'warning'); return; }
      if (urls.length > 1) showNotification(`Opening ${urls.length} documents in separate tabs.`, 'info');
      urls.forEach((u,i)=> setTimeout(()=> window.open(u,'_blank'), i*100));
    }

    // ====== INIT ======
    function createParticles() {
      const container = document.createElement('div');
      container.id = 'particles'; container.className = 'absolute inset-0 pointer-events-none z-0';
      document.body.prepend(container);
      for (let i=0;i<20;i++){
        const p = document.createElement('div');
        p.style.position='absolute'; p.style.width='3px'; p.style.height='3px';
        p.style.background='rgba(144,202,249,.8)'; p.style.borderRadius='50%'; p.style.pointerEvents='none';
        p.style.animation = `float ${6 + Math.random()*3}s infinite ease-in-out`;
        p.style.left = Math.random()*100 + '%'; p.style.animationDelay = Math.random()*6 + 's';
        container.appendChild(p);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      createParticles();
      setModeBanner();
      fetchOrders();
    });
  </script>

  <script src="js/viewOnly.js"></script>
</body>
</html>
