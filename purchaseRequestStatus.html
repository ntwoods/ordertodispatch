<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Requests Status Portal</title>
  <style>
    /* Existing styles unchanged ... */

    .arrived-badge {
      background-color: #28a745;
      color: white;
      font-size: 0.8em;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CRM Requests Status Portal</h1>
    <div class="crm-name-display" id="crmNameDisplay"></div>
    <div id="statusMessage" class="loading-message">Loading requests...</div>
    <div id="requestsGrid" class="requests-grid"></div>
  </div>

  <!-- existing modal unchanged -->

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyffY1_V3ap0VOnFJ8tIPP5bR9_gy_cVQ8_WmLpu0Q6E_dzHOUDPbdXnP4Db5gXRyxl/exec";
    const CANCEL_API_URL = "https://script.google.com/macros/s/AKfycbxWuFbG38SzVYHJ78lqhpgeremUGKvkANvB5xM4DbrV5zAn5FJWB_D0xPl91ubnCgvs/exec";

    const crmNameDisplay = document.getElementById('crmNameDisplay');
    const statusMessage = document.getElementById('statusMessage');
    const requestsGrid = document.getElementById('requestsGrid');

    const cancellationRemarkModal = document.getElementById('cancellationRemarkModal');
    const closeButton = cancellationRemarkModal.querySelector('.close-button');
    const modalRequestId = document.getElementById('modalRequestId');
    const cancellationRemarkInput = document.getElementById('cancellationRemark');
    const confirmCancelButton = cancellationRemarkModal.querySelector('.confirm-cancel');
    const closeModalButton = cancellationRemarkModal.querySelector('.close-modal');

    let currentRequestIdToCancel = null;

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        const options = { day: '2-digit', month: 'short', year: '2-digit' };
        return date.toLocaleDateString('en-GB', options).replace(/ /g, '-');
      } catch (e) {
        console.error("Error formatting date:", dateString, e);
        return dateString;
      }
    }

    function displayStatusMessage(message, type) {
      statusMessage.style.display = 'block';
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type}-message`;
      if (type !== 'loading') {
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 5000);
      }
    }

    async function fetchRequests() {
      const urlParams = new URLSearchParams(window.location.search);
      const crmName = urlParams.get('crmName');

      if (!crmName) {
        displayStatusMessage('Error: CRM name not found in the URL.', 'error');
        return;
      }

      crmNameDisplay.textContent = `Requests for CRM: ${crmName}`;
      displayStatusMessage('Loading requests...', 'loading');
      requestsGrid.innerHTML = '';

      try {
        const response = await fetch(`${API_URL}?crm=${encodeURIComponent(crmName)}`);
        const result = await response.json();

        if (result.status === "success" && result.data && result.data.length > 0) {
          statusMessage.style.display = 'none';
          requestsGrid.style.display = 'grid';

          const now = new Date();

          result.data.forEach(request => {
            let showCard = true;
            let arrivedBadge = "";

            if (request.receivedAtGodown) {
              try {
                const receivedDate = new Date(request.receivedAtGodown);
                const diffDays = (now - receivedDate) / (1000 * 60 * 60 * 24);
                if (diffDays <= 15) {
                  arrivedBadge = `<span class="arrived-badge">Arrived</span>`;
                } else {
                  showCard = false; // older than 15 days â†’ skip
                }
              } catch (err) {
                console.warn("Invalid receivedAtGodown:", request.receivedAtGodown);
                showCard = false;
              }
            } else {
              showCard = false; // if no receivedAtGodown, skip
            }

            if (showCard) {
              const card = document.createElement('div');
              card.className = 'request-card';

              if (request.purchaseStatus && request.purchaseStatus.toLowerCase() === 'cancel') {
                card.classList.add('cancelled-watermark');
              }

              card.innerHTML = `
                <h3>
                  Request ID: ${request.requestId || 'N/A'}
                  ${arrivedBadge}
                </h3>
                <p><strong>Dealer Name:</strong> ${request.dealername || 'N/A'}</p>
                <p><strong>Priority:</strong> ${request.priority || 'N/A'}</p>
                <p><strong>CRM Remark:</strong> ${request.crmRemark || 'N/A'}</p>
                <p><strong>Request Date:</strong> ${formatDate(request.requestDate)}</p>
                <p><strong>Expected Delivery:</strong> ${formatDate(request.expectedDelivery)}</p>
                <p><strong>Remark Purchase:</strong> ${request.remarkPurchase || 'N/A'}</p>
                <p><strong>Received At Godown:</strong> ${formatDate(request.receivedAtGodown)}</p>
                <div class="actions">
                  ${request.product ? `<button class="view-file-button" data-file-url="${request.product}">View File</button>` : ''}
                  <button class="cancel-button" data-request-id="${request.requestId}">Cancel Request</button>
                </div>
              `;
              requestsGrid.appendChild(card);
            }
          });

          attachButtonListeners();

        } else {
          displayStatusMessage(`No requests found for CRM: ${crmName}.`, 'no-data');
          requestsGrid.style.display = 'none';
        }

      } catch (error) {
        console.error("Failed to fetch requests:", error);
        displayStatusMessage(`Error fetching data: ${error.message}`, 'error');
        requestsGrid.style.display = 'none';
      }
    }

    async function cancelRequest(requestId, cancellationRemark) {
      displayStatusMessage(`Attempting to cancel request ${requestId}...`, 'loading');
      try {
        await fetch(CANCEL_API_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'cancel',
            requestId: requestId,
            crm: new URLSearchParams(window.location.search).get('crmName'),
            cancellationRemark: cancellationRemark
          }),
        });
        displayStatusMessage(`Cancel request for ID ${requestId} sent. Refresh to confirm.`, 'success');
        setTimeout(fetchRequests, 2000);
      } catch (error) {
        console.error("Failed to send cancel request:", error);
        displayStatusMessage(`Error: ${error.message}`, 'error');
      }
    }

    function attachButtonListeners() {
      requestsGrid.querySelectorAll('.cancel-button').forEach(button => {
        button.onclick = (event) => {
          currentRequestIdToCancel = event.target.getAttribute('data-request-id');
          if (currentRequestIdToCancel) {
            modalRequestId.textContent = currentRequestIdToCancel;
            cancellationRemarkInput.value = '';
            cancellationRemarkModal.style.display = 'block';
          }
        };
      });

      requestsGrid.querySelectorAll('.view-file-button').forEach(button => {
        button.onclick = (event) => {
          const fileUrl = event.target.getAttribute('data-file-url');
          if (fileUrl) window.open(fileUrl, '_blank');
        };
      });
    }

    closeButton.addEventListener('click', () => {
      cancellationRemarkModal.style.display = 'none';
      currentRequestIdToCancel = null;
    });

    closeModalButton.addEventListener('click', () => {
      cancellationRemarkModal.style.display = 'none';
      currentRequestIdToCancel = null;
    });

    confirmCancelButton.addEventListener('click', () => {
      const remark = cancellationRemarkInput.value.trim();
      if (remark && currentRequestIdToCancel) {
        cancelRequest(currentRequestIdToCancel, remark);
        cancellationRemarkModal.style.display = 'none';
        currentRequestIdToCancel = null;
      } else {
        displayStatusMessage('Cancellation remark is required.', 'error');
      }
    });

    window.addEventListener('click', (event) => {
      if (event.target === cancellationRemarkModal) {
        cancellationRemarkModal.style.display = 'none';
        currentRequestIdToCancel = null;
      }
    });

    document.addEventListener('DOMContentLoaded', fetchRequests);
  </script>
</body>
</html>
