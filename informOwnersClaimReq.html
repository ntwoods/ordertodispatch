<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Request Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        .overflow-y-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-scroll::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg p-6">
        <div class="container mx-auto flex items-center justify-between flex-wrap">
            <h1 id="dashboard-title" class="text-3xl md:text-4xl font-extrabold tracking-tight mb-4 md:mb-0">
                <i class="fas fa-clipboard-list mr-3"></i>
                Claim Requests
            </h1>

            <div class="flex items-center space-x-4 md:space-x-8 flex-wrap justify-end">
                
                <div class="relative inline-block text-left z-10">
                    <button id="filter-dropdown-btn" class="inline-flex justify-center items-center rounded-lg border border-transparent bg-white px-4 py-2 text-sm font-semibold text-blue-800 shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-blue-600 transition-colors">
                        <i class="fas fa-filter mr-2"></i>
                        Filter Status
                        <i class="fas fa-chevron-down ml-2 -mr-1 text-xs"></i>
                    </button>
                    
                    <div id="filter-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden transition-all duration-200">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="filter-dropdown-btn">
                            <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="filter-status" value="reject" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mr-2">
                                <span class="font-medium text-red-600">Rejected</span>
                            </label>
                            <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="filter-status" value="approve" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 mr-2">
                                <span class="font-medium text-green-600">Pending at A/c</span>
                            </label>
                            <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="filter-status" value="verify" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500 mr-2">
                                <span class="font-medium text-yellow-600">Pending for Verification Report</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <span class="text-sm md:text-base font-medium">CRM:</span>
                    <span id="crm-display" class="text-sm md:text-base font-semibold bg-white text-blue-800 px-3 py-1 rounded-full shadow-inner">N/A</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 flex-grow overflow-hidden">
        
        <div id="loading" class="text-center py-20 text-blue-500 hidden">
            <i class="fas fa-spinner fa-spin text-5xl mb-4"></i>
            <p class="text-lg font-medium">Fetching your claims...</p>
        </div>
        <div id="error-message" class="text-center py-20 text-red-500 hidden">
            <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
            <p class="text-lg font-medium">Oops! Something went wrong. Please try again later.</p>
        </div>
        <div id="no-data-message" class="text-center py-20 text-gray-500 hidden">
            <i class="fas fa-box-open text-5xl mb-4"></i>
            <p class="text-lg font-medium">No claims found for this CRM.</p>
        </div>

        <div id="card-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>

    </main>

    <footer class="bg-slate-100 text-slate-600 text-center py-4 text-sm shadow-inner">
        &copy; 2024 Claim Request Dashboard. All Rights Reserved.
    </footer>

    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4 py-8 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                
                <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-blue-800">
                        <i class="fas fa-user-check mr-2"></i>
                        Owners Informed
                    </h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="mt-4">
                    <div class="mb-4">
                        <label for="owner-remark" class="block text-sm font-medium text-gray-700 mb-2">Owner's Remark</label>
                        <textarea id="owner-remark" rows="4" class="block w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div id="marketing-person-field" class="mb-4 hidden">
                        <label for="marketing-person-name" class="block text-sm font-medium text-gray-700 mb-2">Marketing Person's Name</label>
                        <input type="text" id="marketing-person-name" class="block w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row-reverse sm:justify-start sm:space-x-2 sm:space-x-reverse space-y-2 sm:space-y-0 mt-4">
                    <button id="approve-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors shadow-sm">
                        <i class="fas fa-check-circle mr-2"></i>Approve Claim
                    </button>
                    <button id="verify-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm">
                        <i class="fas fa-info-circle mr-2"></i>Verify Claim
                    </button>
                    <button id="reject-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors shadow-sm">
                        <i class="fas fa-times-circle mr-2"></i>Reject Claim
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="post-loading" class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-4">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <span class="text-lg font-medium">Processing...</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Placeholder for the Google Apps Script deployment URL.
            // You MUST replace this with your actual deployed URL.
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8K5xr1V52_zKMfy9gJyWZE0kuxsu0Gjoo2bdNfIXz9-zDDxFCHp2i4mdrLDZxs-BFbA/exec';

            const cardContainer = document.getElementById('card-container');
            const loadingIndicator = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const noDataMessage = document.getElementById('no-data-message');
            const crmDisplay = document.getElementById('crm-display');
            const postLoading = document.getElementById('post-loading');
            
            const modal = document.getElementById('modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const ownerRemarkInput = document.getElementById('owner-remark');
            const marketingPersonField = document.getElementById('marketing-person-field');
            const marketingPersonNameInput = document.getElementById('marketing-person-name');

            // Get the buttons from the modal
            const approveBtn = document.getElementById('approve-claim-btn');
            const verifyBtn = document.getElementById('verify-claim-btn');
            const rejectBtn = document.getElementById('reject-claim-btn');

            // Filter dropdown elements
            const filterDropdownBtn = document.getElementById('filter-dropdown-btn');
            const filterMenu = document.getElementById('filter-menu');
            const filterCheckboxes = document.querySelectorAll('input[name="filter-status"]');

            let originalData = [];

            /**
             * Extracts URL parameters from the current window location.
             * @returns {URLSearchParams} An object containing the URL parameters.
             */
            const getUrlParams = () => new URLSearchParams(window.location.search);

            /**
             * Sends data to the Google Apps Script doPost function
             * @param {Object} payload The data to send
             */
            const sendData = async (payload) => {
                try {
                    postLoading.classList.remove('hidden');
                    
                    // Create form data for POST request
                    const formData = new FormData();
                    formData.append('reqId', payload.reqId);
                    formData.append('action', payload.action);
                    formData.append('ownerRemark', payload.ownerRemark);
                    if (payload.marketingPerson) {
                        formData.append('marketingPerson', payload.marketingPerson);
                    }

                    console.log('Sending payload to server:', payload);

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // As you mentioned this is intentional
                        body: formData
                    });

                    // Note: With no-cors mode, we can't read the response
                    // So we'll assume success if no error is thrown
                    console.log('Request sent successfully');
                    
                    // Show success message
                    alert(`Claim ${payload.action} successfully!`);
                    
                    // Optionally refresh the page to see updated data
                    // window.location.reload();

                } catch (error) {
                    console.error('Error sending data:', error);
                    alert('Error processing request. Please try again.');
                } finally {
                    postLoading.classList.add('hidden');
                }
            };

            /**
             * Fetches data from the Google Apps Script API.
             * @param {string} crmName The CRM name to filter the data.
             */
            const fetchData = async (crmName) => {
                loadingIndicator.classList.remove('hidden');
                cardContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');
                noDataMessage.classList.add('hidden');

                try {
                    // Encode the CRM name to handle spaces and special characters.
                    const encodedCrmName = encodeURIComponent(crmName);
                    const response = await fetch(`${SCRIPT_URL}?crm=${encodedCrmName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    // Store the original fetched data
                    originalData = result.data;
                    
                    // Display the fetched data.
                    displayCards(originalData);

                } catch (error) {
                    console.error('Fetch error:', error);
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    cardContainer.classList.remove('hidden');
                }
            };

            /**
             * Filters the original data based on selected statuses and displays the results.
             */
            const filterCards = () => {
                const selectedStatuses = Array.from(filterCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);

                let filteredData = [];
                if (selectedStatuses.length > 0) {
                    filteredData = originalData.filter(item => {
                        const ownerResponse = item['Owner Response']?.toLowerCase();
                        return selectedStatuses.includes(ownerResponse);
                    });
                } else {
                    // If no filters are selected, show all cards
                    filteredData = originalData;
                }
                
                displayCards(filteredData);
            };

            /**
             * Creates and appends HTML cards to the container.
             * @param {Array<Object>} data An array of claim request objects.
             */
            const displayCards = (data) => {
                cardContainer.innerHTML = '';
                if (data.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    return;
                }

                data.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('bg-white', 'p-6', 'rounded-xl', 'shadow-lg', 'hover:shadow-xl', 'transition-shadow', 'duration-300', 'border', 'border-slate-200', 'flex', 'flex-col', 'justify-between', 'relative'); // Added 'relative' for absolute positioning of the copy button

                    // Convert the raw date string to a readable format
                    const formattedDate = new Date(item['Request Date']).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                    
                    const issueDate = new Date(item['Request Date']).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

                    // Variables for dynamic content
                    let cardColorClass = 'bg-white';
                    let buttonHtml = `<button class="owners-informed-btn w-full px-4 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors shadow-md focus:outline-none" data-req-id="${item['REQ-ID']}">
                                        <i class="fas fa-bullhorn mr-2"></i>Owners Informed
                                    </button>`;
                    let remarkHtml = '';

                    // Check for Owner Response and update card based on its value
                    const ownerResponse = item['Owner Response']?.toLowerCase();
                    const ownerRemark = item['Owner Remark'] || '';

                    if (ownerRemark) {
                        remarkHtml = `
                            <div class="mt-4 border-t pt-4 border-slate-200">
                                <h4 class="text-sm font-semibold text-slate-600 mb-2">Owner's Remark:</h4>
                                <p class="text-sm text-slate-800 break-words">${ownerRemark}</p>
                            </div>`;
                    }

                    if (ownerResponse === 'reject') {
                        cardColorClass = 'bg-red-100 border-red-400';
                        buttonHtml = '';
                    } else if (ownerResponse === 'verify') {
                        cardColorClass = 'bg-yellow-100 border-yellow-400';
                        buttonHtml = `<button class="submit-verification-btn w-full px-4 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors shadow-md focus:outline-none" data-req-id="${item['REQ-ID']}">
                                        <i class="fas fa-file-alt mr-2"></i>Submit Verification Report
                                    </button>`;
                    } else if (ownerResponse === 'approve') {
                        cardColorClass = 'bg-green-100 border-green-400';
                        buttonHtml = `<span class="inline-flex items-center px-3 py-1 text-sm font-semibold text-green-800 bg-green-200 rounded-full shadow-sm">
                                        <i class="fas fa-clock mr-2"></i>A/c Team's Response Awaiting
                                    </span>`;
                    }

                    // Fix for the InvalidCharacterError
                    card.classList.add(...cardColorClass.split(' '));

                    // Build the card's inner HTML
                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-medium text-slate-500">${formattedDate}</span>
                                <span class="text-sm font-medium text-slate-500">${item['REQ-ID']}</span>
                            </div>
                            <h2 class="text-lg md:text-xl font-bold text-blue-800 mb-2">${item['Product']}</h2>
                            <div class="space-y-3 text-slate-700">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-building text-blue-500 w-5 text-center"></i>
                                    <span class="text-sm md:text-base">Dealer: ${item['Dealer Name']}</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-hashtag text-blue-500 w-5 text-center"></i>
                                    <span class="text-sm md:text-base">Qty: ${item['Qty']}</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-exclamation-circle text-red-500 w-5 text-center mt-1"></i>
                                    <p class="text-sm md:text-base break-words flex-1">Issue: ${item['Issue']}</p>
                                </div>
                            </div>
                            ${remarkHtml}
                        </div>
                        <div class="mt-4">
                            ${buttonHtml}
                        </div>
                        <button class="copy-btn absolute bottom-3 right-3 text-gray-500 hover:text-blue-500 transition-colors duration-200 bg-gray-200 hover:bg-gray-300 rounded-md p-2 shadow-sm"> 
                                data-dealer-name="${item['Dealer Name']}"
                                data-product="${item['Product']}"
                                data-qty="${item['Qty']}"
                                data-issue="${item['Issue']}"
                                data-issue-date="${issueDate}">
                            <i class="fas fa-copy text-sm"></i>
                        </button>
                    `;
                    cardContainer.appendChild(card);
                });
                
                // Add event listeners to the new buttons
                document.querySelectorAll('.owners-informed-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        // Store the REQ-ID on the modal for later use
                        modal.dataset.reqId = button.dataset.reqId;
                        marketingPersonField.classList.add('hidden');
                        ownerRemarkInput.value = ''; // Clear previous input
                        marketingPersonNameInput.value = ''; // Clear previous input
                        modal.classList.remove('hidden');
                    });
                });

                // Add event listeners to the new copy buttons
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const dealerName = button.dataset.dealerName;
                        const product = button.dataset.product;
                        const qty = button.dataset.qty;
                        const issue = button.dataset.issue;
                        const issueDate = button.dataset.issueDate;

                        const content = `
🎉 **Claim Request Details** 🎉

📋 **Dealer's Name:** ${dealerName}
📦 **Product:** ${product}
🔢 **Qty:** ${qty}
⚠️ **Issue:** ${issue}
📅 **Issue Date:** ${issueDate}

_Please review this claim and take action accordingly._
                        `.trim();

                        try {
                            await navigator.clipboard.writeText(content);
                            alert('📋 Details copied to clipboard!');
                        } catch (err) {
                            console.error('Failed to copy text:', err);
                            alert('Failed to copy. Please try again.');
                        }
                    });
                });
            };

            // Event listener to close the modal
            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });

            // Handle the click event for the three modal buttons
            approveBtn.addEventListener('click', () => {
                const payload = {
                    action: 'approve',
                    ownerRemark: ownerRemarkInput.value,
                    reqId: modal.dataset.reqId
                };
                console.log('Approve Payload:', payload);
                sendData(payload);
                modal.classList.add('hidden');
            });

            verifyBtn.addEventListener('click', () => {
                if (marketingPersonField.classList.contains('hidden')) {
                    // Show the marketing person input field
                    marketingPersonField.classList.remove('hidden');
                    return;
                }
                const payload = {
                    action: 'verify',
                    ownerRemark: ownerRemarkInput.value,
                    marketingPerson: marketingPersonNameInput.value,
                    reqId: modal.dataset.reqId
                };
                console.log('Verify Payload:', payload);
                sendData(payload);
                modal.classList.add('hidden');
            });

            rejectBtn.addEventListener('click', () => {
                const payload = {
                    action: 'reject',
                    ownerRemark: ownerRemarkInput.value,
                    reqId: modal.dataset.reqId
                };
                console.log('Reject Payload:', payload);
                sendData(payload);
                modal.classList.add('hidden');
            });

            // Filter dropdown event listeners
            filterDropdownBtn.addEventListener('click', () => {
                filterMenu.classList.toggle('hidden');
            });

            filterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    filterCards();
                });
            });

            // Close the filter menu if the user clicks outside of it
            window.addEventListener('click', (event) => {
                if (!filterDropdownBtn.contains(event.target) && !filterMenu.contains(event.target)) {
                    filterMenu.classList.add('hidden');
                }
            });


            // Main execution logic
            const params = getUrlParams();
            const crmName = params.get('crm');

            if (crmName) {
                // Decode the CRM name for display purposes
                const decodedCrmName = decodeURIComponent(crmName);
                crmDisplay.textContent = decodedCrmName;
                fetchData(decodedCrmName);
            } else {
                crmDisplay.textContent = 'Parameter Missing';
                noDataMessage.innerHTML = '<i class="fas fa-box-open text-5xl mb-4"></i><p class="text-lg font-medium">No CRM name provided in the URL.</p><p class="mt-2 text-sm text-gray-400">Example: `your-page.html?crm=Kuldeep%20Sharma`</p>';
                noDataMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
