<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Request Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        .overflow-y-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-scroll::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg p-6">
        <div class="container mx-auto flex items-center justify-between flex-wrap">
            <h1 id="dashboard-title" class="text-3xl md:text-4xl font-extrabold tracking-tight mb-4 md:mb-0">
                <i class="fas fa-clipboard-list mr-3"></i>
                Claim Requests
            </h1>

            <div class="flex items-center space-x-4 md:space-x-8 flex-wrap justify-end">
                
                <div class="relative inline-block text-left z-10">
                    <button id="filter-dropdown-btn" class="inline-flex justify-center items-center rounded-lg border border-transparent bg-white px-4 py-2 text-sm font-semibold text-blue-800 shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-blue-600 transition-colors">
                        <i class="fas fa-filter mr-2"></i>
                        Filter Status
                        <i class="fas fa-chevron-down ml-2 -mr-1 text-xs"></i>
                    </button>
                    
                    <div id="filter-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-lg shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden transition-all duration-200">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="filter-dropdown-btn">
                            <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="filter-status" value="reject" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 mr-2">
                                <span class="font-medium text-red-600">Rejected</span>
                            </label>
                            <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="filter-status" value="approve" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 mr-2">
                                <span class="font-medium text-green-600">Pending at A/c</span>
                            </label>
                            <label class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                <input type="checkbox" name="filter-status" value="verify" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500 mr-2">
                                <span class="font-medium text-yellow-600">Pending for Verification Report</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <span class="text-sm md:text-base font-medium">CRM:</span>
                    <span id="crm-display" class="text-sm md:text-base font-semibold bg-white text-blue-800 px-3 py-1 rounded-full shadow-inner">N/A</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 flex-grow overflow-hidden">
        
        <div id="loading" class="text-center py-20 text-blue-500 hidden">
            <i class="fas fa-spinner fa-spin text-5xl mb-4"></i>
            <p class="text-lg font-medium">Fetching your claims...</p>
        </div>
        <div id="error-message" class="text-center py-20 text-red-500 hidden">
            <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
            <p class="text-lg font-medium">Oops! Something went wrong. Please try again later.</p>
        </div>
        <div id="no-data-message" class="text-center py-20 text-gray-500 hidden">
            <i class="fas fa-box-open text-5xl mb-4"></i>
            <p class="text-lg font-medium">No claims found for this CRM.</p>
        </div>

        <div id="card-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>

    </main>

    <footer class="bg-slate-100 text-slate-600 text-center py-4 text-sm shadow-inner">
        &copy; 2024 Claim Request Dashboard. All Rights Reserved.
    </footer>

    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4 py-8 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                
                <div class="editable">
                <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-blue-800">
                        <i class="fas fa-user-check mr-2"></i>
                        Owners Informed
                    </h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                </div>
                <div class="mt-4">
                    <div class="mb-4">
                        <label for="owner-remark" class="block text-sm font-medium text-gray-700 mb-2">Owner's Remark</label>
                        <textarea id="owner-remark" rows="4" class="block w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div id="marketing-person-field" class="mb-4 hidden">
                        <label for="marketing-person-name" class="block text-sm font-medium text-gray-700 mb-2">Marketing Person's Name</label>
                        <input type="text" id="marketing-person-name" class="block w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row-reverse sm:justify-start sm:space-x-2 sm:space-x-reverse space-y-2 sm:space-y-0 mt-4">
                    <button id="approve-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors shadow-sm">
                        <i class="fas fa-check-circle mr-2"></i>Approve Claim
                    </button>
                    <button id="verify-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm">
                        <i class="fas fa-info-circle mr-2"></i>Verify Claim
                    </button>
                    <button id="reject-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors shadow-sm">
                        <i class="fas fa-times-circle mr-2"></i>Reject Claim
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="post-loading" class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-4">
            <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
            <span class="text-lg font-medium">Processing...</span>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8K5xr1V52_zKMfy9gJyWZE0kuxsu0Gjoo2bdNfIXz9-zDDxFCHp2i4mdrLDZxs-BFbA/exec';

    // DOM refs
    const cardContainer = document.getElementById('card-container');
    const loadingIndicator = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const noDataMessage = document.getElementById('no-data-message');
    const crmDisplay = document.getElementById('crm-display');
    const postLoading = document.getElementById('post-loading');

    const modal = document.getElementById('modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const ownerRemarkInput = document.getElementById('owner-remark');
    const marketingPersonField = document.getElementById('marketing-person-field');
    const marketingPersonNameInput = document.getElementById('marketing-person-name');

    const approveBtn = document.getElementById('approve-claim-btn');
    const verifyBtn = document.getElementById('verify-claim-btn');
    const rejectBtn = document.getElementById('reject-claim-btn');

    const filterDropdownBtn = document.getElementById('filter-dropdown-btn');
    const filterMenu = document.getElementById('filter-menu');
    const filterCheckboxes = document.querySelectorAll('input[name="filter-status"]');

    let originalData = [];

    // --- Helpers ---
    const getUrlParams = () => new URLSearchParams(window.location.search);
    // Escape HTML to prevent XSS
    const escapeHtml = (unsafe) => {
        if (unsafe === undefined || unsafe === null) return '';
        return String(unsafe)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    };

    const buildScriptUrl = (crmName) => {
        if (crmName) return `${SCRIPT_URL}?crm=${encodeURIComponent(crmName)}`;
        return SCRIPT_URL;
    };

    // --- Network: fetch data (GET) ---
    const fetchData = async (crmName = null) => {
        loadingIndicator.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        noDataMessage.classList.add('hidden');
        cardContainer.classList.add('hidden');

        try {
            const url = buildScriptUrl(crmName);
            const response = await fetch(url, { method: 'GET' });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const result = await response.json();
            // adapt if your API returns { data: [...] } or just an array
            originalData = Array.isArray(result.data) ? result.data : (Array.isArray(result) ? result : (result.data || []));

            if (!originalData || originalData.length === 0) {
                noDataMessage.classList.remove('hidden');
                cardContainer.innerHTML = '';
                return;
            }

            displayCards(originalData);
            cardContainer.classList.remove('hidden');
        } catch (err) {
            console.error('fetchData error:', err);
            errorMessage.classList.remove('hidden');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    };

    // --- Network: send data (POST) ---
    // NOTE: This uses JSON and expects the server to accept CORS & JSON.
    const sendData = async (payload) => {
        try {
            postLoading.classList.remove('hidden');

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // requires server CORS
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            // read and act on server response
            const resJson = await response.json();
            if (resJson && resJson.error) throw new Error(resJson.error);

            alert(`Claim ${payload.action} successfully!`);
            // optional: refresh list
            // fetchData(getCrmFromUI()?getCrmFromUI():null);
        } catch (error) {
            console.error('sendData error:', error);
            alert('Error processing request. Please try again.');
        } finally {
            postLoading.classList.add('hidden');
        }
    };

    // --- Filtering ---
    const filterCards = () => {
        const selectedStatuses = Array.from(filterCheckboxes)
            .filter(c => c.checked)
            .map(c => c.value.toLowerCase().trim());

        let filtered = originalData;
        if (selectedStatuses.length > 0) {
            filtered = originalData.filter(item => {
                const resp = (item['Owner Response'] || '').toString().toLowerCase().trim();
                // normalize typical variations e.g. "rejected" -> "reject"
                const normalized = resp.replace(/ed$/,''); // simple normalization
                return selectedStatuses.includes(normalized) || selectedStatuses.includes(resp);
            });
        }
        displayCards(filtered);
    };

    // --- Card rendering (with event delegation) ---
    const displayCards = (data) => {
        cardContainer.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
            noDataMessage.classList.remove('hidden');
            return;
        }

        const frag = document.createDocumentFragment();

        data.forEach(item => {
            // sanitize values
            const product = escapeHtml(item['Product']);
            const dealerName = escapeHtml(item['Dealer Name']);
            const qty = escapeHtml(item['Qty']);
            const issue = escapeHtml(item['Issue']);
            const reqId = escapeHtml(item['REQ-ID']);
            const ownerResponse = (item['Owner Response'] || '').toString().toLowerCase().trim();
            const ownerRemark = escapeHtml(item['Owner Remark'] || '');

            // date formatting (safely)
            let formattedDate = 'Unknown';
            try {
                const d = new Date(item['Request Date']);
                formattedDate = isNaN(d) ? 'Unknown' : d.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
            } catch (e) { /* ignore */ }

            // card root (note: no bg color here; color is added via colorClass)
            const card = document.createElement('div');
            card.className = 'p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-200 flex flex-col justify-between relative';

            let colorClass = 'bg-white';
            let footerHtml = `<button class="owners-informed-btn w-full px-4 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors shadow-md focus:outline-none" data-req-id="${reqId}">
                                <i class="fas fa-bullhorn mr-2"></i>Owners Informed
                              </button>`;
            let statusTagHtml = '';

            if (ownerResponse === 'reject' || ownerResponse === 'rejected') {
                colorClass = 'bg-red-100 border-red-400';
                footerHtml = '';
                statusTagHtml = '<div class="mt-2 text-sm font-semibold text-gray-700">ðŸ›ˆ Rejected</div>';
            } else if (ownerResponse === 'verify' || ownerResponse === 'verification pending') {
                colorClass = 'bg-yellow-100 border-yellow-400';
                footerHtml = `<button class="submit-verification-btn w-full px-4 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors shadow-md focus:outline-none" data-req-id="${reqId}">
                                <i class="fas fa-file-alt mr-2"></i>Submit Verification Report
                              </button>`;
                statusTagHtml = '<div class="mt-2 text-sm font-semibold text-gray-700">ðŸ›ˆ Verification Pending</div>';
            } else if (ownerResponse === 'approve' || ownerResponse === 'approved') {
                colorClass = 'bg-green-100 border-green-400';
                const dealerCN = (item['Dealer CN Vch No'] || '').toString().trim();
                const supplierName = (item['Supplier Name'] || '').toString().trim();
                let statusTag = '';
                if (!dealerCN && !supplierName) statusTag = "A/c Response Awaiting";
                else if (dealerCN && !supplierName) statusTag = "Only Supplier Claim Pending";
                else if (!dealerCN && supplierName) statusTag = "Only Dealer Claim Pending";
                else statusTag = "Request Clear";

                footerHtml = `<span class="inline-flex items-center px-3 py-1 text-sm font-semibold text-green-800 bg-green-200 rounded-full shadow-sm">
                                <i class="fas fa-check-circle mr-2"></i>${escapeHtml(statusTag)}
                              </span>`;
            }

            // Build innerHTML safely (already escaped)
            card.innerHTML = `
                <div class="flex-grow">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-medium text-slate-500">${formattedDate}</span>
                        <span class="text-sm font-medium text-slate-500">${reqId}</span>
                    </div>
                    <h2 class="text-lg md:text-xl font-bold text-blue-800 mb-2">${product}</h2>
                    <div class="space-y-3 text-slate-700">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-building text-blue-500 w-5 text-center"></i>
                            <span class="text-sm md:text-base">Dealer: ${dealerName}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-hashtag text-blue-500 w-5 text-center"></i>
                            <span class="text-sm md:text-base">Qty: ${qty}</span>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-exclamation-circle text-red-500 w-5 text-center mt-1"></i>
                            <p class="text-sm md:text-base break-words flex-1">Issue: ${issue}</p>
                        </div>
                    </div>
                    ${ownerRemark ? `<div class="mt-4 border-t pt-4 border-slate-200">
                                        <h4 class="text-sm font-semibold text-slate-600 mb-2">Owner's Remark:</h4>
                                        <p class="text-sm text-slate-800 break-words">${ownerRemark}</p>
                                     </div>` : ''}
                    ${statusTagHtml}
                </div>
                <div class="mt-4">${footerHtml}</div>
                <button class="copy-btn absolute bottom-3 right-3 text-white transition-all duration-200 bg-black/20 backdrop-blur-sm rounded-md p-2 shadow-lg hover:bg-black/30"
                    data-dealer-name="${escapeHtml(item['Dealer Name'])}"
                    data-product="${escapeHtml(item['Product'])}"
                    data-qty="${escapeHtml(item['Qty'])}"
                    data-issue="${escapeHtml(item['Issue'])}"
                    data-issue-date="${escapeHtml(new Date(item['Request Date']).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }))}">
                    <i class="fas fa-copy text-sm"></i>
                </button>
            `;

            // add color class after creation
            card.classList.add(...colorClass.split(' '));
            frag.appendChild(card);
        });

        cardContainer.appendChild(frag);
    };

    // --- Event delegation for dynamic buttons inside cards ---
    cardContainer.addEventListener('click', (e) => {
        const ownersBtn = e.target.closest('.owners-informed-btn');
        if (ownersBtn) {
            modal.dataset.reqId = ownersBtn.dataset.reqId;
            marketingPersonField.classList.add('hidden');
            ownerRemarkInput.value = '';
            marketingPersonNameInput.value = '';
            modal.classList.remove('hidden');
            return;
        }

        const copyBtn = e.target.closest('.copy-btn');
        if (copyBtn) {
            const dealerName = copyBtn.dataset.dealerName;
            const product = copyBtn.dataset.product;
            const qty = copyBtn.dataset.qty;
            const issue = copyBtn.dataset.issue;
            const issueDate = copyBtn.dataset.issueDate;
            const content = `Dealer: ${dealerName}\nProduct: ${product}\nQty: ${qty}\nIssue: ${issue}\nIssueDate: ${issueDate}`;
            navigator.clipboard?.writeText(content).then(() => {
                alert('ðŸ“‹ Details copied to clipboard!');
            }).catch(err => {
                console.error('copy failed', err);
                alert('Failed to copy. Please try again.');
            });
            return;
        }

        const verificationBtn = e.target.closest('.submit-verification-btn');
        if (verificationBtn) {
            // handle verification flow (open modal or custom flow)
            modal.dataset.reqId = verificationBtn.dataset.reqId;
            marketingPersonField.classList.remove('hidden'); // show input
            modal.classList.remove('hidden');
            return;
        }
    });

    // --- Modal controls ---
    closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));

    // Close when clicking overlay: better to detect overlay element specifically
    modal.addEventListener('click', (e) => {
        // If the click target is the modal backdrop (the top-level modal), close.
        // The inner modal content is aligned/centered and won't be equal to modal itself.
        if (e.target === modal) modal.classList.add('hidden');
    });

    approveBtn.addEventListener('click', () => {
        const payload = {
            action: 'approve',
            ownerRemark: ownerRemarkInput.value || '',
            reqId: modal.dataset.reqId
        };
        sendData(payload);
        modal.classList.add('hidden');
    });

    verifyBtn.addEventListener('click', () => {
        if (marketingPersonField.classList.contains('hidden')) {
            marketingPersonField.classList.remove('hidden');
            return;
        }
        const payload = {
            action: 'verify',
            ownerRemark: ownerRemarkInput.value || '',
            marketingPerson: marketingPersonNameInput.value || '',
            reqId: modal.dataset.reqId
        };
        sendData(payload);
        modal.classList.add('hidden');
    });

    rejectBtn.addEventListener('click', () => {
        const payload = {
            action: 'reject',
            ownerRemark: ownerRemarkInput.value || '',
            reqId: modal.dataset.reqId
        };
        sendData(payload);
        modal.classList.add('hidden');
    });

    // Filters
    filterDropdownBtn.addEventListener('click', () => filterMenu.classList.toggle('hidden'));
    filterCheckboxes.forEach(cb => cb.addEventListener('change', filterCards));
    // Close filter if click outside
    window.addEventListener('click', (e) => {
        if (!filterDropdownBtn.contains(e.target) && !filterMenu.contains(e.target)) {
            filterMenu.classList.add('hidden');
        }
    });

    // --- Main execution logic ---
    const params = getUrlParams();
    const crmName = params.get('crm'); // URLSearchParams.get returns decoded value already

    if (crmName) {
        crmDisplay.textContent = crmName;
        fetchData(crmName);
    } else {
        crmDisplay.textContent = 'All CRMs';
        // fetch unfiltered (native) API as you required
        fetchData(null);
    }
});
</script>

    <script src="https://ntwoods.github.io/ordertodispatch/js/viewOnly.js"></script>
</body>
</html>
