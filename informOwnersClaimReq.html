<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Request Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for premium typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        .overflow-y-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-scroll::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
            border-radius: 10px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 10px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg p-6">
        <div class="container mx-auto flex items-center justify-between">
            <h1 id="dashboard-title" class="text-3xl md:text-4xl font-extrabold tracking-tight">
                <i class="fas fa-clipboard-list mr-3"></i>
                Claim Requests
            </h1>
            <div class="flex items-center space-x-2">
                <span class="text-sm md:text-base font-medium">CRM:</span>
                <span id="crm-display" class="text-sm md:text-base font-semibold bg-white text-blue-800 px-3 py-1 rounded-full shadow-inner">N/A</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-6 flex-grow overflow-hidden">
        
        <!-- Loading and Error States -->
        <div id="loading" class="text-center py-20 text-blue-500 hidden">
            <i class="fas fa-spinner fa-spin text-5xl mb-4"></i>
            <p class="text-lg font-medium">Fetching your claims...</p>
        </div>
        <div id="error-message" class="text-center py-20 text-red-500 hidden">
            <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
            <p class="text-lg font-medium">Oops! Something went wrong. Please try again later.</p>
        </div>
        <div id="no-data-message" class="text-center py-20 text-gray-500 hidden">
            <i class="fas fa-box-open text-5xl mb-4"></i>
            <p class="text-lg font-medium">No claims found for this CRM.</p>
        </div>

        <!-- Cards Container -->
        <div id="card-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Cards will be dynamically added here by JavaScript -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-100 text-slate-600 text-center py-4 text-sm shadow-inner">
        &copy; 2024 Claim Request Dashboard. All Rights Reserved.
    </footer>

    <!-- Modal for "Owners Informed" -->
    <div id="modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen px-4 py-8 text-center sm:block sm:p-0">
            <!-- Modal backdrop -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" aria-hidden="true"></div>
            
            <!-- Modal content container -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                
                <!-- Modal header -->
                <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-blue-800">
                        <i class="fas fa-user-check mr-2"></i>
                        Owners Informed
                    </h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Modal body -->
                <div class="mt-4">
                    <div class="mb-4">
                        <label for="owner-remark" class="block text-sm font-medium text-gray-700 mb-2">Owner's Remark</label>
                        <textarea id="owner-remark" rows="4" class="block w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <!-- New input field for Marketing Person, initially hidden -->
                    <div id="marketing-person-field" class="mb-4 hidden">
                        <label for="marketing-person-name" class="block text-sm font-medium text-gray-700 mb-2">Marketing Person's Name</label>
                        <input type="text" id="marketing-person-name" class="block w-full px-3 py-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="flex flex-col sm:flex-row-reverse sm:justify-start sm:space-x-2 sm:space-x-reverse space-y-2 sm:space-y-0 mt-4">
                    <button id="approve-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors shadow-sm">
                        <i class="fas fa-check-circle mr-2"></i>Approve Claim
                    </button>
                    <button id="verify-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600 transition-colors shadow-sm">
                        <i class="fas fa-info-circle mr-2"></i>Verify Claim
                    </button>
                    <button id="reject-claim-btn" class="px-5 py-2 text-sm font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors shadow-sm">
                        <i class="fas fa-times-circle mr-2"></i>Reject Claim
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Placeholder for the Google Apps Script deployment URL.
            // You MUST replace this with your actual deployed URL.
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzrRLWOtKKIkxs0cUBMZpfRjukuMP0171yTZfXCtp-0oKnt7FaM0frkbkbLAyApZV8xXg/exec';

            const cardContainer = document.getElementById('card-container');
            const loadingIndicator = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const noDataMessage = document.getElementById('no-data-message');
            const crmDisplay = document.getElementById('crm-display');
            
            const modal = document.getElementById('modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const ownerRemarkInput = document.getElementById('owner-remark');
            const marketingPersonField = document.getElementById('marketing-person-field');
            const marketingPersonNameInput = document.getElementById('marketing-person-name');

            // Get the buttons from the modal
            const approveBtn = document.getElementById('approve-claim-btn');
            const verifyBtn = document.getElementById('verify-claim-btn');
            const rejectBtn = document.getElementById('reject-claim-btn');

            /**
             * Extracts URL parameters from the current window location.
             * @returns {URLSearchParams} An object containing the URL parameters.
             */
            const getUrlParams = () => new URLSearchParams(window.location.search);

            /**
             * Fetches data from the Google Apps Script API.
             * @param {string} crmName The CRM name to filter the data.
             */

            /**
             * Sends a POST request to the Google Apps Script API.
             * @param {Object} data The data payload to send.
             */
            const sendData = async (data) => {
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: new URLSearchParams(data) // Convert the data object to URL-encoded form data
                    });
                    const result = await response.json();
                    console.log('API Response:', result);
                    if (result.status === 'success') {
                        alert('Claim updated successfully!');
                        // Reload or update the UI as needed
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                    alert('An error occurred. Please try again.');
                }
            };
            
            // ... inside the button click handlers, replace the console.log line with:
            // approveBtn.addEventListener('click', () => {
            //     const payload = { /* ... */ };
            //     sendData(payload);
            // });            
            
            const fetchData = async (crmName) => {
                loadingIndicator.classList.remove('hidden');
                cardContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');
                noDataMessage.classList.add('hidden');

                try {
                    // Encode the CRM name to handle spaces and special characters.
                    const encodedCrmName = encodeURIComponent(crmName);
                    const response = await fetch(`${SCRIPT_URL}?crm=${encodedCrmName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    // Display the fetched data.
                    displayCards(result.data);

                } catch (error) {
                    console.error('Fetch error:', error);
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    cardContainer.classList.remove('hidden');
                }
            };

            /**
             * Creates and appends HTML cards to the container.
             * @param {Array<Object>} data An array of claim request objects.
             */
            const displayCards = (data) => {
                cardContainer.innerHTML = '';
                if (data.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    return;
                }

                data.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('bg-white', 'p-6', 'rounded-xl', 'shadow-lg', 'hover:shadow-xl', 'transition-shadow', 'duration-300', 'border', 'border-slate-200', 'flex', 'flex-col', 'justify-between');

                    // Convert the raw date string to a readable format
                    const formattedDate = new Date(item['Request Date']).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });

                    // Build the card's inner HTML
                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-medium text-slate-500">${formattedDate}</span>
                                <span class="text-sm font-medium text-slate-500">${item['REQ-ID']}</span>
                            </div>
                            <h2 class="text-lg md:text-xl font-bold text-blue-800 mb-2">${item['Product']}</h2>
                            <div class="space-y-3 text-slate-700">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-building text-blue-500 w-5 text-center"></i>
                                    <span class="text-sm md:text-base">Dealer: ${item['Dealer Name']}</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-hashtag text-blue-500 w-5 text-center"></i>
                                    <span class="text-sm md:text-base">Qty: ${item['Qty']}</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-exclamation-circle text-red-500 w-5 text-center mt-1"></i>
                                    <p class="text-sm md:text-base break-words flex-1">Issue: ${item['Issue']}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="owners-informed-btn w-full px-4 py-2 text-sm font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors shadow-md focus:outline-none" data-req-id="${item['REQ-ID']}">
                                <i class="fas fa-bullhorn mr-2"></i>Owners Informed
                            </button>
                        </div>
                    `;
                    cardContainer.appendChild(card);
                });
                
                // Add event listeners to the new buttons
                document.querySelectorAll('.owners-informed-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        // Store the REQ-ID on the modal for later use
                        modal.dataset.reqId = button.dataset.reqId;
                        marketingPersonField.classList.add('hidden');
                        modal.classList.remove('hidden');
                    });
                });
            };

            // Event listener to close the modal
            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });

            // Handle the click event for the three modal buttons
            approveBtn.addEventListener('click', () => {
                const payload = {
                    action: 'approve',
                    ownerRemark: ownerRemarkInput.value,
                    reqId: modal.dataset.reqId
                };
                console.log('Approve Payload:', payload);
                // Here you would call your doPost function to send the data
                // sendData(payload);
                modal.classList.add('hidden');
            });

            verifyBtn.addEventListener('click', () => {
                if (marketingPersonField.classList.contains('hidden')) {
                    // Show the marketing person input field
                    marketingPersonField.classList.remove('hidden');
                    return;
                }
                const payload = {
                    action: 'verify',
                    ownerRemark: ownerRemarkInput.value,
                    marketingPerson: marketingPersonNameInput.value,
                    reqId: modal.dataset.reqId
                };
                console.log('Verify Payload:', payload);
                // Here you would call your doPost function to send the data
                // sendData(payload);
                modal.classList.add('hidden');
            });

            rejectBtn.addEventListener('click', () => {
                const payload = {
                    action: 'reject',
                    ownerRemark: ownerRemarkInput.value,
                    reqId: modal.dataset.reqId
                };
                console.log('Reject Payload:', payload);
                // Here you would call your doPost function to send the data
                // sendData(payload);
                modal.classList.add('hidden');
            });


            // Main execution logic
            const params = getUrlParams();
            const crmName = params.get('crm');

            if (crmName) {
                // Decode the CRM name for display purposes
                const decodedCrmName = decodeURIComponent(crmName);
                crmDisplay.textContent = decodedCrmName;
                fetchData(decodedCrmName);
            } else {
                crmDisplay.textContent = 'Parameter Missing';
                noDataMessage.innerHTML = '<i class="fas fa-box-open text-5xl mb-4"></i><p class="text-lg font-medium">No CRM name provided in the URL.</p><p class="mt-2 text-sm text-gray-400">Example: `your-page.html?crm=Kuldeep%20Sharma`</p>';
                noDataMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
